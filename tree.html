<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>RJVC Binary Tree</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui;
}
.topbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  background:#0b1320;
  padding:10px;
  display:flex;
  gap:8px;
  justify-content:center;
  z-index:10;
}
.btn{
  padding:8px 12px;
  border-radius:999px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb;color:#111827}

.canvas-wrap{
  margin-top:70px;
  display:flex;
  justify-content:center;
}
canvas{
  background:#020617;
}
</style>
</head>

<body>

<div class="topbar">
  <button class="btn btn-primary" onclick="zoomIn()">＋</button>
  <button class="btn btn-primary" onclick="zoomOut()">－</button>
  <button class="btn btn-secondary" onclick="resetZoom()">Reset</button>
  <button class="btn btn-secondary" onclick="history.back()">Back</button>
</div>

<div class="canvas-wrap">
  <canvas id="treeCanvas" width="1400" height="900"></canvas>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
  authDomain: "rjvc-plan.firebaseapp.com",
  projectId: "rjvc-plan"
});
const db = firebase.firestore();
const treeCol = db.collection("TreeNodes");

const canvas = document.getElementById("treeCanvas");
const ctx = canvas.getContext("2d");

let scale = 1;
let nodes = {};
let rootId = null;

function zoomIn(){ scale += 0.1; draw(); }
function zoomOut(){ scale = Math.max(0.5, scale-0.1); draw(); }
function resetZoom(){ scale = 1; draw(); }

/* ❌ DRAG & TOUCH DISABLED */
canvas.onmousedown = null;
canvas.ontouchstart = null;

/* LOAD TREE */
treeCol.onSnapshot(snap=>{
  nodes={};
  snap.forEach(d=>nodes[d.id]={id:d.id,...d.data()});
  Object.values(nodes).forEach(n=>{
    if(!n.parentId) rootId=n.id;
  });
  draw();
});

function draw(){
  ctx.setTransform(scale,0,0,scale,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!rootId) return;

  let levels=[[rootId]];
  while(true){
    let last=levels[levels.length-1];
    let next=[];
    last.forEach(id=>{
      let n=nodes[id];
      if(n?.leftId) next.push(n.leftId);
      if(n?.rightId) next.push(n.rightId);
    });
    if(!next.length) break;
    levels.push(next);
  }

  let pos={};
  levels.forEach((lvl,i)=>{
    let y=80+i*120;
    let step=canvas.width/(lvl.length+1);
    lvl.forEach((id,j)=>{
      pos[id]={x:step*(j+1),y};
    });
  });

  ctx.strokeStyle="#64748b";
  Object.values(nodes).forEach(n=>{
    if(n.leftId && pos[n.leftId]){
      ctx.beginPath();
      ctx.moveTo(pos[n.id].x,pos[n.id].y);
      ctx.lineTo(pos[n.leftId].x,pos[n.leftId].y);
      ctx.stroke();
    }
    if(n.rightId && pos[n.rightId]){
      ctx.beginPath();
      ctx.moveTo(pos[n.id].x,pos[n.id].y);
      ctx.lineTo(pos[n.rightId].x,pos[n.rightId].y);
      ctx.stroke();
    }
  });

  Object.values(nodes).forEach(n=>{
    let p=pos[n.id];
    if(!p) return;
    ctx.fillStyle="#0b1320";
    ctx.strokeStyle="#2563eb";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.roundRect(p.x-70,p.y-20,140,40,10);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.fillText(n.name||"",p.x,p.y+5);
  });
}
</script>

</body>
</html>
