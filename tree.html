<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>RJVC – Full Tree (Admin Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #e6ebff;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 20px 26px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    h1 {
      margin: 0 0 4px;
      text-align: center;
      color: #102a6b;
    }
    .sub {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cbd5ff;
      min-width: 260px;
      font-size: 13px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      margin-top: 10px;
    }
    .panel {
      flex: 1 1 260px;
    }
    h2 {
      margin: 10px 0 6px;
      font-size: 16px;
      color: #102a6b;
    }
    .card {
      background: #f9f9ff;
      border-radius: 14px;
      border: 1px solid #dde2ff;
      padding: 10px 12px;
      font-size: 12px;
    }
    .wallet {
      font-size: 12px;
      line-height: 1.5;
    }
    button {
      border: none;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      margin: 2px 2px;
    }
    .btn-add {
      background: #0066ff;
      color: white;
    }
    .btn-minus {
      background: #ffe7ba;
      color: #663c00;
    }
    .btn-reset {
      background: #ffccc7;
      color: #a8071a;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
    }

    /* ===== Tree layout big ===== */
    .tree-wrap {
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .tree {
      min-width: 700px;
      text-align: center;
      margin-top: 6px;
    }
    .tree-row {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin-bottom: 14px;
    }
    .tree-node {
      min-width: 140px;
      background: #111827;
      color: #fff;
      padding: 8px 10px;
      border-radius: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.22);
      font-size: 11px;
    }
    .tree-node.main {
      background: #0b3b91;
      font-weight: 600;
    }
    .node-title {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 2px;
    }
    .node-id {
      font-size: 11px;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .node-stats {
      font-size: 10px;
      margin-bottom: 4px;
    }
    .node-actions {
      margin-top: 2px;
    }

    .tree-line-h {
      width: 160px;
      height: 2px;
      background: #cbd5ff;
      margin: 0 auto 6px auto;
    }
    .tree-line-h-wide {
      width: 260px;
      height: 2px;
      background: #cbd5ff;
      margin: 0 auto 6px auto;
    }
    .tree-line-v {
      width: 2px;
      height: 20px;
      background: #cbd5ff;
      margin: 0 auto;
    }
    .tree-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    @media (max-width: 600px) {
      .tree {
        min-width: 540px;
      }
      .tree-row {
        gap: 26px;
      }
      .tree-node {
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>RJVC – Full Tree View</h1>
  <div class="sub">
    <b>Admin Only:</b> यह पेज सिर्फ admin के लिए है, customer को लिंक मत दिखाएँ।  
    सारे data वही हैं जो <code>admin.html</code> में localStorage में सेव हैं।
  </div>

  <!-- Customer chooser -->
  <div style="text-align:center; margin-bottom:12px;">
    <label style="font-size:12px; font-weight:600;">किस customer का Tree देखना है?</label><br>
    <select id="customerSelect" onchange="onCustomerChange()">
      <option value="">-- Customer चुनें --</option>
    </select>
  </div>

  <div class="row">
    <div class="panel">
      <h2>Tree View (Binary Layout)</h2>
      <div class="tree-wrap">
        <div id="treeArea" class="tree">
          <!-- JS से tree आएगा -->
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Details & Wallets</h2>
      <div class="card">
        <div id="custInfo" style="margin-bottom:6px; font-size:12px;">
          पहले कोई customer चुनें।
        </div>
        <div id="walletInfo" class="wallet"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "rjvc_admin_customers";
  const PER_PAIR_AMOUNT = 3;   // 2 members = 1 pair = ₹3

  let customers = [];
  let currentCustomer = null;  // पूरा object
  let currentIds = null;       // normalize किया हुआ ids structure

  /* ---------- Storage Helpers ---------- */
  function loadCustomers() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    } catch (e) {
      return [];
    }
  }

  function saveCustomers(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function formatNumber(n) {
    return Number(n || 0).toLocaleString("en-IN");
  }

  /* ---------- Pair / Wallet Calculation (admin.js जैसा ही) ---------- */
  function recalcPairsAndWallets(customer) {
    customer.walletCommission = 0;
    customer.walletBonus = 0;
    if (!customer.ids) return;

    customer.ids.forEach(id => {
      const members = Number(id.members || 0);
      const pairs = Math.floor(members / 2);
      id.pairs = pairs;

      const earning = pairs * PER_PAIR_AMOUNT;
      if (id.type === "main") {
        customer.walletCommission += earning;
      } else if (id.type === "sub") {
        customer.walletBonus += earning;
      }
    });
  }

  function normalizeIds(cust) {
    const res = {
      main:  { code: cust.mainId || "" },
      sub1:  { code: "" },
      sub2:  { code: "" },
      sub3:  { code: "" },
      sub4:  { code: "" },
      sub5:  { code: "" },
      mainm: 0, mainp: 0,
      sub1m: 0, sub1p: 0,
      sub2m: 0, sub2p: 0,
      sub3m: 0, sub3p: 0,
      sub4m: 0, sub4p: 0,
      sub5m: 0, sub5p: 0
    };

    if (cust.ids && Array.isArray(cust.ids)) {
      cust.ids.forEach(id => {
        if (id.type === "main") {
          res.main.code = id.code;
          res.mainm = id.members || 0;
          res.mainp = id.pairs || 0;
        } else if (id.type === "sub") {
          if (id.index === 1) { res.sub1.code = id.code; res.sub1m = id.members || 0; res.sub1p = id.pairs || 0; }
          if (id.index === 2) { res.sub2.code = id.code; res.sub2m = id.members || 0; res.sub2p = id.pairs || 0; }
          if (id.index === 3) { res.sub3.code = id.code; res.sub3m = id.members || 0; res.sub3p = id.pairs || 0; }
          if (id.index === 4) { res.sub4.code = id.code; res.sub4m = id.members || 0; res.sub4p = id.pairs || 0; }
          if (id.index === 5) { res.sub5.code = id.code; res.sub5m = id.members || 0; res.sub5p = id.pairs || 0; }
        }
      });
    }

    // default codes
    if (!res.main.code && cust.mainId) res.main.code = cust.mainId;
    if (!res.sub1.code && cust.mainId) res.sub1.code = cust.mainId + "-1";
    if (!res.sub2.code && cust.mainId) res.sub2.code = cust.mainId + "-2";
    if (!res.sub3.code && cust.mainId) res.sub3.code = cust.mainId + "-3";
    if (!res.sub4.code && cust.mainId) res.sub4.code = cust.mainId + "-4";
    if (!res.sub5.code && cust.mainId) res.sub5.code = cust.mainId + "-5";

    return res;
  }

  /* ---------- Tree Page Controls (Add / Minus / Reset) ---------- */
  function updateIdMembers(kind, index, delta) {
    if (!currentCustomer || !currentCustomer.ids) return;

    let target = null;
    if (kind === "main") {
      target = currentCustomer.ids.find(i => i.type === "main");
    } else {
      target = currentCustomer.ids.find(i => i.type === "sub" && i.index === index);
    }
    if (!target) return;

    const newVal = Math.max(0, Number(target.members || 0) + delta);
    target.members = newVal;

    // recalc + save back
    recalcPairsAndWallets(currentCustomer);
    const idx = customers.findIndex(c => c.id === currentCustomer.id);
    if (idx !== -1) customers[idx] = currentCustomer;
    saveCustomers(customers);

    // refresh screen
    loadCurrentCustomer(currentCustomer.mainId);
  }

  function resetIdMembers(kind, index) {
    if (!confirm("क्या इस ID के सारे members reset (0) करना चाहते हैं?")) return;
    if (!currentCustomer || !currentCustomer.ids) return;

    let target = null;
    if (kind === "main") {
      target = currentCustomer.ids.find(i => i.type === "main");
    } else {
      target = currentCustomer.ids.find(i => i.type === "sub" && i.index === index);
    }
    if (!target) return;

    target.members = 0;
    recalcPairsAndWallets(currentCustomer);
    const idx = customers.findIndex(c => c.id === currentCustomer.id);
    if (idx !== -1) customers[idx] = currentCustomer;
    saveCustomers(customers);

    loadCurrentCustomer(currentCustomer.mainId);
  }

  /* ---------- Rendering ---------- */
  function renderTree() {
    const treeArea = document.getElementById("treeArea");
    const walletInfo = document.getElementById("walletInfo");
    const custInfo = document.getElementById("custInfo");

    if (!currentCustomer || !currentIds) {
      treeArea.innerHTML = "<div style='font-size:12px; padding:8px;'>पहले ऊपर से कोई customer चुनें।</div>";
      walletInfo.innerHTML = "";
      custInfo.innerHTML = "पहले ऊपर से कोई customer चुनें।";
      return;
    }

    const c = currentCustomer;
    const ids = currentIds;

    custInfo.innerHTML =
      "<b>" + c.name + "</b> (" + c.mobile +
      ")<br>Main ID: <b>" + ids.main.code + "</b>";

    walletInfo.innerHTML =
      "Commission Wallet: ₹" + formatNumber(c.walletCommission || 0) +
      "<br>Bonus Wallet: ₹" + formatNumber(c.walletBonus || 0) +
      "<br><br><i>Rule:</i> हर 2 members = 1 pair, 1 pair पर ₹" + PER_PAIR_AMOUNT +
      " binary earning. Main ID की earning Commission Wallet में जाती है, " +
      "Sub IDs की earning Bonus Wallet में जाती है।";

    treeArea.innerHTML = `
      <div class="tree-row">
        <div class="tree-node main">
          <div class="node-title">Main ID</div>
          <div class="node-id">${ids.main.code}</div>
          <div class="node-stats">
            Members: ${ids.mainm || 0} &nbsp; | &nbsp;
            Pairs: ${ids.mainp || 0}
          </div>
          <div class="node-actions">
            <button class="btn-add btn-small"
              onclick="updateIdMembers('main', 0, +1)">+ Member</button>
            <button class="btn-minus btn-small"
              onclick="updateIdMembers('main', 0, -1)">- Member</button>
            <button class="btn-reset btn-small"
              onclick="resetIdMembers('main', 0)">Reset</button>
          </div>
        </div>
      </div>

      <div class="tree-line-v"></div>
      <div class="tree-line-h-wide"></div>

      <div class="tree-row">
        <div class="tree-node">
          <div class="node-title">Sub ID 1</div>
          <div class="node-id">${ids.sub1.code}</div>
          <div class="node-stats">
            Members: ${ids.sub1m || 0} | Pairs: ${ids.sub1p || 0}
          </div>
          <div class="node-actions">
            <button class="btn-add btn-small"
              onclick="updateIdMembers('sub', 1, +1)">+ Member</button>
            <button class="btn-minus btn-small"
              onclick="updateIdMembers('sub', 1, -1)">- Member</button>
            <button class="btn-reset btn-small"
              onclick="resetIdMembers('sub', 1)">Reset</button>
          </div>
        </div>

        <div class="tree-node">
          <div class="node-title">Sub ID 2</div>
          <div class="node-id">${ids.sub2.code}</div>
          <div class="node-stats">
            Members: ${ids.sub2m || 0} | Pairs: ${ids.sub2p || 0}
          </div>
          <div class="node-actions">
            <button class="btn-add btn-small"
              onclick="updateIdMembers('sub', 2, +1)">+ Member</button>
            <button class="btn-minus btn-small"
              onclick="updateIdMembers('sub', 2, -1)">- Member</button>
            <button class="btn-reset btn-small"
              onclick="resetIdMembers('sub', 2)">Reset</button>
          </div>
        </div>
      </div>

      <div class="tree-row">
        <div class="tree-col">
          <div class="tree-line-v"></div>
          <div class="tree-line-h"></div>
          <div class="tree-node">
            <div class="node-title">Sub ID 3</div>
            <div class="node-id">${ids.sub3.code}</div>
            <div class="node-stats">
              Members: ${ids.sub3m || 0} | Pairs: ${ids.sub3p || 0}
            </div>
            <div class="node-actions">
              <button class="btn-add btn-small"
                onclick="updateIdMembers('sub', 3, +1)">+ Member</button>
              <button class="btn-minus btn-small"
                onclick="updateIdMembers('sub', 3, -1)">- Member</button>
              <button class="btn-reset btn-small"
                onclick="resetIdMembers('sub', 3)">Reset</button>
            </div>
          </div>
        </div>

        <div class="tree-col">
          <div class="tree-line-v"></div>
          <div class="tree-line-h-wide"></div>
          <div class="tree-row">
            <div class="tree-node">
              <div class="node-title">Sub ID 4</div>
              <div class="node-id">${ids.sub4.code}</div>
              <div class="node-stats">
                Members: ${ids.sub4m || 0} | Pairs: ${ids.sub4p || 0}
              </div>
              <div class="node-actions">
                <button class="btn-add btn-small"
                  onclick="updateIdMembers('sub', 4, +1)">+ Member</button>
                <button class="btn-minus btn-small"
                  onclick="updateIdMembers('sub', 4, -1)">- Member</button>
                <button class="btn-reset btn-small"
                  onclick="resetIdMembers('sub', 4)">Reset</button>
              </div>
            </div>

            <div class="tree-node">
              <div class="node-title">Sub ID 5</div>
              <div class="node-id">${ids.sub5.code}</div>
              <div class="node-stats">
                Members: ${ids.sub5m || 0} | Pairs: ${ids.sub5p || 0}
              </div>
              <div class="node-actions">
                <button class="btn-add btn-small"
                  onclick="updateIdMembers('sub', 5, +1)">+ Member</button>
                <button class="btn-minus btn-small"
                  onclick="updateIdMembers('sub', 5, -1)">- Member</button>
                <button class="btn-reset btn-small"
                  onclick="resetIdMembers('sub', 5)">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  /* ---------- Customer selection ---------- */
  function loadCurrentCustomer(mainId) {
    currentCustomer = customers.find(c => c.mainId === mainId) || null;
    if (currentCustomer) {
      recalcPairsAndWallets(currentCustomer);
      currentIds = normalizeIds(currentCustomer);
    } else {
      currentIds = null;
    }
    renderTree();
  }

  function onCustomerChange() {
    const sel = document.getElementById("customerSelect");
    const val = sel.value;
    if (!val) {
      currentCustomer = null;
      currentIds = null;
      renderTree();
      return;
    }
    loadCurrentCustomer(val);
  }

  function populateCustomerSelect() {
    const sel = document.getElementById("customerSelect");
    sel.innerHTML = '<option value="">-- Customer चुनें --</option>';

    customers.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.mainId;
      opt.textContent = c.name + " (" + c.mobile + ") – " + c.mainId;
      sel.appendChild(opt);
    });
  }

  /* ---------- Init ---------- */
  window.addEventListener("load", function () {
    customers = loadCustomers();
    populateCustomerSelect();

    // अगर URL में ?id=RJVCXXXX आया है तो उसे auto select करें
    const params = new URLSearchParams(window.location.search);
    const idFromUrl = params.get("id");
    if (idFromUrl) {
      const sel = document.getElementById("customerSelect");
      const option = Array.from(sel.options).find(o => o.value === idFromUrl);
      if (option) {
        sel.value = idFromUrl;
        loadCurrentCustomer(idFromUrl);
      }
    } else {
      renderTree();
    }
  });
</script>
</body>
</html>
