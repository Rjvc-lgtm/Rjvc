<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Binary Admin (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:#f3f4f6;color:#111827;}
    h1,h2,h3{margin:0 0 8px;}

    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.15);padding:22px;max-width:480px;width:100%;}
    label{display:block;font-size:14px;margin-bottom:4px;}
    input{width:100%;padding:10px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:15px;outline:none;}
    input:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.25);}
    .btn{border:none;border-radius:999px;padding:10px 18px;font-size:15px;font-weight:600;cursor:pointer;}
    .btn-primary{background:#2563eb;color:#fff;}
    .btn-secondary{background:#e5e7eb;color:#111827;}
    .btn-danger{background:#dc2626;color:#fff;}
    .btn-sm{padding:6px 10px;font-size:12px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .flex{display:flex;}
    .between{justify-content:space-between;align-items:center;}
    .center{text-align:center;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{font-size:12px;text-transform:uppercase;color:#6b7280;}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;background:#dbeafe;color:#1d4ed8;}
    .wrap{max-width:1100px;width:100%;margin:24px auto;padding:0 8px;}
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(15,23,42,.1);padding:18px;margin-bottom:18px;}
    .small{font-size:12px;color:#6b7280;}
    .error{color:#dc2626;font-size:13px;margin-top:6px;}
    .ok{color:#166534;font-size:13px;margin-top:6px;}

    .wallets{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;}
    .wallet-box{flex:1 1 180px;background:#eff6ff;border-radius:14px;padding:10px 12px;}
    .wallet-title{font-size:12px;color:#4b5563;}
    .wallet-value{font-size:18px;font-weight:700;color:#1d4ed8;}

    .tree-panel{background:#020617;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:8px;}
    .tree-root-label{font-size:13px;color:#a5b4fc;margin-bottom:4px;}
    .tree-level{text-align:center;margin:8px 0;}
    .tree-node-wrap{display:inline-block;margin:6px;}
    .tree-node{padding:6px 10px;border-radius:12px;background:#111827;border:1px solid #4b5563;font-size:12px;min-width:120px;}
    .tree-node-main{background:#1d4ed8;border-color:#93c5fd;}
    .tree-node-name{font-weight:600;}
    .tree-node-meta{font-size:10px;color:#9ca3af;margin-top:2px;}
    .tree-node-actions{margin-top:6px;display:flex;gap:4px;justify-content:center;flex-wrap:wrap;}
    .tree-node-actions .btn-sm{padding:3px 6px;font-size:10px;}

    .profit-panel{background:#0f172a;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:10px;}
    .profit-boxes{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .profit-box{flex:1 1 160px;background:#020617;border-radius:14px;padding:10px 12px;border:1px solid #1e293b;}
    .profit-label{font-size:12px;color:#9ca3af;}
    .profit-value{font-size:18px;font-weight:700;}

    canvas{max-width:100%;}

    @media(max-width:720px){
      .panel{padding:14px;}
      table{font-size:12px;}
    }
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page">
  <div class="card">
    <h1 class="center">RJVC Admin Login</h1>
    <p class="center small" style="margin-bottom:16px;">
      यह पेज सिर्फ admin के लिए है। Customer को यह link न दें।
    </p>
    <label>Admin ID</label>
    <input id="adminId" placeholder="जैसे: admin" />
    <div class="mt-2"></div>
    <label>Password</label>
    <input id="adminPass" type="password" placeholder="जैसे: 1234" />
    <button class="btn btn-primary mt-3" style="width:100%;" onclick="handleAdminLogin()">
      Login
    </button>
    <div id="loginError" class="error" style="display:none;">गलत ID या Password</div>
    <p class="small" style="margin-top:12px;">
      फिलहाल default: <b>ID: admin</b>, <b>Password: 1234</b> (कोड में ऊपर बदल सकते हैं)
    </p>
  </div>
</div>

<!-- ADMIN MAIN PAGE -->
<div id="adminPage" style="display:none;">
  <div class="wrap">
    <!-- HEADER -->
    <div class="panel flex between">
      <div>
        <h2>Binary Tree Admin (Firebase)</h2>
        <div class="small">
          हर customer 20₹ joining देता है। 2 members (1 pair) पर <b>3₹</b> binary bonus customers को जाता है।
        </div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- CREATE ROOT CUSTOMER -->
    <div class="panel">
      <h3>नया Customer बनाएं (Root level)</h3>
      <div class="flex" style="gap:10px;flex-wrap:wrap;margin-top:8px;">
        <div style="flex:1 1 200px;">
          <label>Customer Name</label>
          <input id="rootName" placeholder="जैसे: Rajesh" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Customer Password (Login के लिए)</label>
          <input id="rootPass" placeholder="जैसे: 1234" />
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="createRootCustomer()">
        Root में नया Customer जोड़ें
      </button>
      <div id="rootMsg" class="ok" style="display:none;"></div>
      <p class="small" style="margin-top:6px;">
        यहाँ से बने हर customer का <b>नाम + password</b> Firebase की <b>Users</b> collection में भी save होगा।
        वही login RJVC Customer Login page पर चलेगा।
      </p>
    </div>

    <!-- CUSTOMER LIST -->
    <div class="panel">
      <div class="flex between">
        <h3>Customer List (Tree Nodes)</h3>
        <span class="badge" id="totalCustomersBadge">0 Customers</span>
      </div>
      <div class="wallets">
        <div class="wallet-box">
          <div class="wallet-title">कुल Customers (Tree में)</div>
          <div id="totalCust" class="wallet-value">0</div>
        </div>
        <div class="wallet-box">
          <div class="wallet-title">कुल Pairs (पूरा Tree)</div>
          <div id="totalPairs" class="wallet-value">0</div>
        </div>
        <div class="wallet-box">
          <div class="wallet-title">कुल Binary Pairs Income (Members को) ₹</div>
          <div id="totalCommission" class="wallet-value">₹0</div>
        </div>
      </div>
      <div class="mt-3" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Members<br/>(नीचे)</th>
              <th>Pairs</th>
              <th>Binary Income<br/>(₹)</th>
              <th>Tree</th>
              <th>Del</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
      <p class="small" style="margin-top:6px;">
        Logic: हर 2 member = 1 pair. 1 pair की binary earning = 3₹।  
        यह earning customer के wallet में जाएगी (Users collection में भी update होता है)।
      </p>
    </div>

    <!-- TREE VIEW -->
    <div class="tree-panel">
      <div class="flex between">
        <div>
          <div class="tree-root-label">Binary Tree View</div>
          <div id="treeRootInfo" style="font-size:13px;">
            अभी कोई root select नहीं है।
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="showFullRootTree()">
          सिर्फ Root दिखाओ
        </button>
      </div>
      <div id="treeViewArea" style="margin-top:10px;font-size:12px;">
        अभी tree खाली है।
      </div>
    </div>

    <!-- COMPANY PROFIT + HISTORY -->
    <div class="panel">
      <h3>Company Business Report</h3>
      <p class="small">
        Company Profit = (कुल Customers × 20₹ joining) – (Binary payout customers को)।  
        Admin जब चाहे “Save Snapshot” दबाकर history में entry जोड़ सकता है।
      </p>

      <div class="profit-panel mt-3">
        <div class="flex between">
          <div>
            <div class="small">Current Summary</div>
          </div>
          <div class="small" id="profitUpdated">Auto (Tree से)</div>
        </div>

        <div class="profit-boxes">
          <div class="profit-box">
            <div class="profit-label">Total Customers × 20₹ (Business Income)</div>
            <div class="profit-value" id="businessIncome">₹0</div>
          </div>
          <div class="profit-box">
            <div class="profit-label">Total Binary Pairs Income (Members को) ₹</div>
            <div class="profit-value" id="binaryPayoutBox">₹0</div>
          </div>
          <div class="profit-box">
            <div class="profit-label">Company Profit (₹)</div>
            <div class="profit-value" id="companyProfitBox">₹0</div>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-primary btn-sm" onclick="saveProfitSnapshot()">
            Save Snapshot (Firebase history)
          </button>
        </div>

        <div class="mt-3">
          <div class="small">Business Chart (Income vs Payout vs Profit)</div>
          <canvas id="profitChart" width="420" height="220"></canvas>
        </div>

        <div class="mt-3">
          <div class="small">Recent Profit History (Firebase से)</div>
          <div style="overflow-x:auto;margin-top:6px;">
            <table>
              <thead>
                <tr>
                  <th>DATE/TIME</th>
                  <th>CUSTOMERS</th>
                  <th>INCOME (₹)</th>
                  <th>BINARY PAYOUT (₹)</th>
                  <th>PROFIT (₹)</th>
                </tr>
              </thead>
              <tbody id="profitHistoryBody">
                <!-- rows -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- WITHDRAWALS (ADMIN VIEW – FUTURE USE) -->
    <div class="panel">
      <h3>Customer Withdrawals (History)</h3>
      <p class="small">
        Customer side से withdrawal request आने पर ये यहाँ <b>Withdrawals</b> collection से दिखेंगे।
      </p>
      <div style="overflow-x:auto;margin-top:6px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Name</th>
              <th>Amount (₹)</th>
              <th>Bank</th>
              <th>Account</th>
              <th>IFSC</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="withdrawBody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- FIREBASE CDN -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

<script>
  /************ Firebase config – RJVC PLAN ************/
  const firebaseConfig = {
    apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
    authDomain: "rjvc-plan.firebaseapp.com",
    projectId: "rjvc-plan",
    storageBucket: "rjvc-plan.firebasestorage.app",
    messagingSenderId: "265431528728",
    appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d",
    measurementId: "G-1Y7PN96H93"
  };

  firebase.initializeApp(firebaseConfig);
  try { firebase.analytics(); } catch(e) {}

  const db             = firebase.firestore();
  const treeCol        = db.collection("TreeNodes");
  const usersCol       = db.collection("Users");
  const profitCol      = db.collection("ProfitHistory");
  const withdrawalsCol = db.collection("Withdrawals");

  /************ Simple Admin Login ************/
  const ADMIN_ID = "admin";
  const ADMIN_PASSWORD = "1234";

  function handleAdminLogin(){
    const id   = document.getElementById("adminId").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    const err  = document.getElementById("loginError");

    if(id === ADMIN_ID && pass === ADMIN_PASSWORD){
      err.style.display = "none";
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("adminPage").style.display = "block";
      startSubscriptions();
    }else{
      err.style.display = "block";
    }
  }

  function logout(){
    document.getElementById("adminPage").style.display = "none";
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("adminPass").value = "";
  }

  /************ Tree data in memory ************/
  let nodesById = {};    // id -> node data
  let rootId    = null;  // top root
  let currentTreeRootId = null;
  let treeUnsub = null;
  let profitUnsub = null;
  let withdrawUnsub = null;

  // global totals
  let globalTotalPairs = 0;
  let globalTotalCommission = 0;
  let globalTotalCustomers = 0;

  function startSubscriptions(){
    // live tree listener
    if(treeUnsub) treeUnsub();
    treeUnsub = treeCol.orderBy("createdAt","asc").onSnapshot(async snap=>{
      nodesById = {};
      rootId = null;
      snap.forEach(doc=>{
        const d = doc.data();
        nodesById[doc.id] = Object.assign({id:doc.id}, d);
      });

      // root = जिसे parentId नहीं है
      Object.values(nodesById).forEach(n=>{
        if(!n.parentId) rootId = n.id;
      });

      await recalcAll();   // सब कुछ recompute + Users update
      renderTable();
      renderTree();
      updateCompanyProfitUI();
    });

    // profit history listener (last 20)
    if(profitUnsub) profitUnsub();
    profitUnsub = profitCol
      .orderBy("createdAt","desc")
      .limit(20)
      .onSnapshot(snap=>{
        const tbody = document.getElementById("profitHistoryBody");
        tbody.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.timestamp || ""}</td>
            <td>${d.totalCustomers || 0}</td>
            <td>₹${d.businessIncome || 0}</td>
            <td>₹${d.binaryPayout || 0}</td>
            <td>₹${d.companyProfit || 0}</td>
          `;
          tbody.appendChild(tr);
        });
      });

    // withdrawals history
    if(withdrawUnsub) withdrawUnsub();
    withdrawUnsub = withdrawalsCol
      .orderBy("createdAt","desc")
      .limit(50)
      .onSnapshot(snap=>{
        const tbody = document.getElementById("withdrawBody");
        tbody.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.timestamp || ""}</td>
            <td>${d.name || ""}</td>
            <td>₹${d.amount || 0}</td>
            <td>${d.bankName || ""}</td>
            <td>${d.accountNumber || ""}</td>
            <td>${d.ifsc || ""}</td>
            <td>${d.status || "pending"}</td>
          `;
          tbody.appendChild(tr);
        });
      });
  }

  /************ Helper – create node + user ************/
  function buildTreeNode(id, name, pass, parentId){
    return {
      name,
      password: pass,
      parentId: parentId || null,
      leftId: null,
      rightId: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
  }

  function buildUserDoc(name, pass){
    return {
      name,
      password: pass,
      commissionWallet: 0,
      bonusWallet: 0,
      totalMembers: 0,
      totalPairs: 0,
      isBlocked: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
  }

  /************ Create Root Customer ************/
  async function createRootCustomer(){
    const name = document.getElementById("rootName").value.trim();
    const pass = document.getElementById("rootPass").value.trim();
    const msg  = document.getElementById("rootMsg");
    msg.style.display = "none";

    if(!name || !pass){
      msg.textContent = "Name और Password दोनों जरूरी हैं।";
      msg.className = "error";
      msg.style.display = "block";
      return;
    }

    try{
      // नया random id, दोनों collection में same id से doc बनाना
      const newRef = treeCol.doc();
      const id = newRef.id;

      await Promise.all([
        newRef.set(buildTreeNode(id, name, pass, null)),
        usersCol.doc(id).set(buildUserDoc(name, pass))
      ]);

      document.getElementById("rootName").value = "";
      document.getElementById("rootPass").value = "";

      msg.textContent = "Customer root में सफलतापूर्वक जोड़ा गया।";
      msg.className = "ok";
      msg.style.display = "block";
    }catch(err){
      msg.textContent = "Error: " + err.message;
      msg.className = "error";
      msg.style.display = "block";
    }
  }

  /************ Utility – count descendants & commissions ************/
  function countDescendants(nodeId){
    const node = nodesById[nodeId];
    if(!node) return 0;
    let c = 0;
    if(node.leftId)  c += 1 + countDescendants(node.leftId);
    if(node.rightId) c += 1 + countDescendants(node.rightId);
    return c;
  }

  async function recalcAll(){
    globalTotalPairs = 0;
    globalTotalCommission = 0;
    globalTotalCustomers = Object.keys(nodesById).length;

    const list = Object.values(nodesById);

    // पहले memory में calculate
    list.forEach(n=>{
      const members = countDescendants(n.id);
      const pairs = Math.floor(members/2);
      const commission = pairs * 3; // 3₹ per pair

      n.members = members;
      n.pairs = pairs;
      n.commission = commission;

      globalTotalPairs += pairs;
      globalTotalCommission += commission;
    });

    document.getElementById("totalPairs").textContent = globalTotalPairs;
    document.getElementById("totalCommission").textContent = "₹" + globalTotalCommission;
    document.getElementById("totalCust").textContent = globalTotalCustomers;

    // Users collection sync (हर node का wallet update)
    const batch = db.batch();
    list.forEach(n=>{
      const ref = usersCol.doc(n.id);
      batch.set(ref, {
        name: n.name,
        password: n.password,
        commissionWallet: 0,
        bonusWallet: n.commission || 0,
        totalMembers: n.members || 0,
        totalPairs: n.pairs || 0,
        isBlocked: false
      }, {merge:true});
    });
    if(list.length){
      try{ await batch.commit(); }catch(e){ console.error("Users sync error", e); }
    }
  }

  /************ Table render ************/
  function renderTable(){
    const tbody = document.getElementById("customerTableBody");
    tbody.innerHTML = "";
    const list = Object.values(nodesById);
    list.sort((a,b)=>a.name.localeCompare(b.name));

    document.getElementById("totalCustomersBadge").textContent =
      list.length + " Customers";

    list.forEach((n,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${n.name}</td>
        <td>${n.members || 0}</td>
        <td>${n.pairs || 0}</td>
        <td>₹${n.commission || 0}</td>
        <td><button class="btn btn-secondary btn-sm" onclick="viewTreeFrom('${n.id}')">Tree</button></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteCustomer('${n.id}')">Del</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /************ Tree view ************/
  function viewTreeFrom(id){
    currentTreeRootId = id;
    renderTree();
  }

  function showFullRootTree(){
    currentTreeRootId = rootId;
    renderTree();
  }

  function renderTree(){
    const area = document.getElementById("treeViewArea");
    const info = document.getElementById("treeRootInfo");

    if(!Object.keys(nodesById).length){
      info.textContent = "Tree खाली है। पहले कोई customer जोड़ें।";
      area.textContent = "";
      return;
    }

    const startId = currentTreeRootId || rootId;
    const startNode = nodesById[startId];
    if(!startNode){
      info.textContent = "Tree root नहीं मिला।";
      area.textContent = "";
      return;
    }

    info.innerHTML = `अभी tree <b>${startNode.name}</b> से शुरू हो रहा है
      (Members: ${startNode.members||0}, Pairs: ${startNode.pairs||0}, Binary Income: ₹${startNode.commission||0})`;

    let html = "";

    function buildLevel(ids){
      if(!ids.length) return;
      html += `<div class="tree-level">`;
      ids.forEach(id=>{
        const n = nodesById[id];
        if(!n) return;
        const isMain = (id === rootId);
        html += `
          <div class="tree-node-wrap">
            <div class="tree-node ${isMain ? "tree-node-main":""}">
              <div class="tree-node-name">${n.name}</div>
              <div class="tree-node-meta">M:${n.members||0} · P:${n.pairs||0} · ₹${n.commission||0}</div>
              <div class="tree-node-actions">
                <button class="btn btn-secondary btn-sm" onclick="treeAddMember('${n.id}')">+Member</button>
                <button class="btn btn-secondary btn-sm" onclick="editCustomer('${n.id}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${n.id}')">Del</button>
              </div>
            </div>
          </div>`;
      });
      html += `</div>`;

      const next = [];
      ids.forEach(id=>{
        const n = nodesById[id];
        if(!n) return;
        if(n.leftId)  next.push(n.leftId);
        if(n.rightId) next.push(n.rightId);
      });
      if(next.length) buildLevel(next);
    }

    buildLevel([startId]);
    area.innerHTML = html;
  }

  /************ Add / Edit / Delete ************/
  // Tree से कॉल – पहले side पूछेगा (Left / Right)
  function treeAddMember(parentId){
    const sideAns = prompt("किस side जोड़ना है? Left = L या 1, Right = R या 2");
    if(!sideAns) return;
    const s = sideAns.trim().toLowerCase();
    let sideField = null;
    if(s==="l" || s==="1") sideField = "leftId";
    else if(s==="r" || s==="2") sideField = "rightId";
    else{
      alert("गलत choice, L/1 या R/2 लिखें");
      return;
    }

    const name = prompt("नया member का नाम?");
    if(!name) return;
    const pass = prompt("उसका login password?");
    if(!pass) return;

    addMember(parentId, sideField, name, pass);
  }

  // main add logic – अगर जगह खाली है तो normal, अगर भरा है तो बीच में नया node
  async function addMember(parentId, sideField, name, pass){
    try{
      const parentRef = treeCol.doc(parentId);
      const parentSnap = await parentRef.get();
      if(!parentSnap.exists){
        alert("Parent नहीं मिला");
        return;
      }
      const parent = parentSnap.data();
      const existingChildId = parent[sideField] || null;

      // पहले नया node create (id दोनों collections में same)
      const newRef = treeCol.doc();
      const newId = newRef.id;

      const newTreeData = buildTreeNode(newId, name, pass, parentId);
      const newUserData = buildUserDoc(name, pass);

      const updateParent = {};
      updateParent[sideField] = newId;

      const batch = db.batch();
      batch.set(newRef, newTreeData);              // नया node
      batch.set(usersCol.doc(newId), newUserData); // Users entry
      batch.update(parentRef, updateParent);       // parent link

      if(existingChildId){
        // बीच में insert: existing child नीचे चला जाएगा (new.leftId)
        batch.update(newRef, { leftId: existingChildId });
        batch.update(treeCol.doc(existingChildId), { parentId: newId });
      }

      await batch.commit();
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  async function editCustomer(id){
    const node = nodesById[id];
    if(!node) return;
    const newName = prompt("नया नाम?", node.name);
    if(!newName) return;
    const newPass = prompt("नया password? (खाली छोड़ो तो पुराना ही रहेगा)", "");
    const update = { name:newName };
    if(newPass && newPass.trim()) update.password = newPass.trim();

    try{
      const batch = db.batch();
      batch.update(treeCol.doc(id), update);
      batch.set(usersCol.doc(id), {
        name: newName,
        ...(update.password ? {password:update.password}: {})
      }, {merge:true});
      await batch.commit();
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  async function deleteCustomer(id){
    const node = nodesById[id];
    if(!node) return;
    if(!confirm(`"${node.name}" और उसका पूरा subtree delete होगा, आगे बढ़ें?`)) return;

    // parent से link हटाओ
    if(node.parentId){
      const parentRef = treeCol.doc(node.parentId);
      const parent = nodesById[node.parentId];
      if(parent){
        const upd = {};
        if(parent.leftId === id) upd.leftId = null;
        if(parent.rightId === id) upd.rightId = null;
        await parentRef.update(upd);
      }
    }

    // DFS से subtree delete
    async function deleteSubTree(nid){
      const n = nodesById[nid];
      if(!n) return;
      if(n.leftId)  await deleteSubTree(n.leftId);
      if(n.rightId) await deleteSubTree(n.rightId);
      await Promise.all([
        treeCol.doc(nid).delete(),
        usersCol.doc(nid).delete()
      ]);
    }
    await deleteSubTree(id);
  }

  /************ Company Profit (auto from tree) ************/
  function updateCompanyProfitUI(){
    const businessIncome = globalTotalCustomers * 20;  // हर customer 20₹
    const binaryPayout   = globalTotalCommission;      // tree से निकला
    const companyProfit  = businessIncome - binaryPayout;

    document.getElementById("businessIncome").textContent  = "₹" + businessIncome;
    document.getElementById("binaryPayoutBox").textContent = "₹" + binaryPayout;
    document.getElementById("companyProfitBox").textContent= "₹" + companyProfit;
    document.getElementById("profitUpdated").textContent   = new Date().toLocaleString("en-IN");

    drawProfitChart(businessIncome, binaryPayout, companyProfit);
  }

  async function saveProfitSnapshot(){
    const businessIncome = globalTotalCustomers * 20;
    const binaryPayout   = globalTotalCommission;
    const companyProfit  = businessIncome - binaryPayout;

    const now = new Date();
    const stamp = now.toLocaleString("en-IN");

    try{
      await profitCol.add({
        totalCustomers: globalTotalCustomers,
        businessIncome,
        binaryPayout,
        companyProfit,
        timestamp: stamp,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Snapshot Firebase history में save हो गया।");
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  function drawProfitChart(businessIncome, binaryPayout, companyProfit){
    const canvas = document.getElementById("profitChart");
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const labels = ["Income","Binary Payout","Profit"];
    const values = [businessIncome, binaryPayout, companyProfit];
    const maxVal = Math.max(1, ...values.map(v=>Math.abs(v)));
    const barWidth = 60;
    const gap = 40;
    const originX = 40;
    const originY = canvas.height - 30;

    // axis
    ctx.strokeStyle = "#9ca3af";
    ctx.beginPath();
    ctx.moveTo(originX, 10);
    ctx.lineTo(originX, originY);
    ctx.lineTo(canvas.width - 10, originY);
    ctx.stroke();

    // bars
    for(let i=0;i<values.length;i++){
      const x = originX + gap + i*(barWidth+gap);
      const h = (Math.abs(values[i])/maxVal) * (originY-40);
      const y = originY - h;

      ctx.fillStyle = i===0 ? "#3b82f6" : (i===1 ? "#f97316" : "#22c55e");
      ctx.fillRect(x, y, barWidth, h);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "11px system-ui";
      ctx.textAlign = "center";
      ctx.fillText(labels[i], x+barWidth/2, originY+14);
      ctx.fillText("₹"+values[i], x+barWidth/2, y-4);
    }
  }
</script>

</body>
</html>
