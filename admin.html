<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Binary Tree Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    body{margin:0;background:#f2f5ff;}
    h1,h2,h3{margin:0 0 8px;}
    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:24px;max-width:480px;width:100%;}
    label{display:block;font-size:14px;margin-bottom:4px;}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #c5cbe3;font-size:15px;}
    input:focus{outline:none;border-color:#2952ff;box-shadow:0 0 0 2px rgba(41,82,255,.18);}
    .btn{border:none;border-radius:999px;padding:10px 18px;font-size:15px;font-weight:600;cursor:pointer;}
    .btn-primary{background:#2952ff;color:#fff;}
    .btn-secondary{background:#e2e7ff;color:#172554;}
    .btn-danger{background:#fee2e2;color:#991b1b;}
    .btn-sm{padding:6px 10px;font-size:12px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .flex{display:flex;}
    .between{justify-content:space-between;align-items:center;}
    .center{text-align:center;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{font-size:12px;text-transform:uppercase;color:#6b7280;}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#e5f3ff;color:#1d4ed8;}
    .wrap{max-width:1100px;width:100%;margin:24px auto;}
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px;margin-bottom:18px;}
    .tree-panel{background:#020617;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:12px;}
    .tree-root-label{font-size:13px;color:#a5b4fc;margin-bottom:6px;}
    .tree-level{text-align:center;margin-top:12px;}
    .tree-node-wrap{display:inline-block;margin:8px;}
    .tree-node{
      padding:8px 12px;
      border-radius:12px;
      background:#111827;
      border:1px solid #4b5563;
      font-size:12px;
      min-width:120px;
    }
    .tree-node-main{background:#1d4ed8;border-color:#93c5fd;}
    .tree-node-actions{margin-top:6px;display:flex;gap:4px;flex-wrap:wrap;justify-content:center;}
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page">
  <div class="card">
    <h1 class="center">Admin Login</h1>

    <label>Admin ID</label>
    <input id="adminId" placeholder="admin" />

    <label class="mt-2">Password</label>
    <input id="adminPass" type="password" placeholder="1234" />

    <button class="btn btn-primary mt-3" style="width:100%;" onclick="handleAdminLogin()">
      Login
    </button>

    <div id="loginError" class="error" style="display:none;color:red;margin-top:6px;">
      गलत ID या Password
    </div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" style="display:none;">
  <div class="wrap">

    <div class="panel flex between">
      <h2>Binary Tree Admin</h2>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- CREATE ROOT -->
    <div class="panel">
      <h3>नया Root Customer जोड़ें</h3>
      <label>Name</label>
      <input id="newName" placeholder="जैसे: Rajesh" />
      <label class="mt-2">Password</label>
      <input id="newPass" placeholder="1234" />

      <button class="btn btn-primary mt-3" onclick="createRootCustomer()">
        Add Root
      </button>
    </div>

    <!-- LIST -->
    <div class="panel">
      <div class="flex between">
        <h3>Customer List</h3>
        <span id="totalCustomers" class="badge">0</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Members</th>
            <th>Pairs</th>
            <th>Commission</th>
            <th>Tree</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- TREE PANEL -->
    <div class="tree-panel">
      <div class="tree-root-label">Binary Tree</div>
      <div id="treeInfo"></div>
      <div id="treeArea" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
  authDomain: "rjvc-plan.firebaseapp.com",
  projectId: "rjvc-plan",
  storageBucket: "rjvc-plan.firebasestorage.app",
  messagingSenderId: "265431528728",
  appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const treeCol = db.collection("TreeNodes");

// ADMIN LOGIN
const ADMIN_ID = "admin";
const ADMIN_PASS = "1234";

// Tree Data
let nodes = {};
let rootId = null;
let currentTreeRootId = null;

// Create Node
function makeNode(id, name, pass) {
  return {
    id,
    name,
    password: pass,
    parent: null,
    left: null,
    right: null,
    members: 0,
    pairs: 0,
    commission: 0
  };
}

// Login
async function handleAdminLogin() {
  const id = adminId.value.trim();
  const pass = adminPass.value.trim();

  if (id === ADMIN_ID && pass === ADMIN_PASS) {
    loginError.style.display = "none";
    loginPage.style.display = "none";
    adminPage.style.display = "block";

    await loadData();
    renderAll();
  } else {
    loginError.style.display = "block";
  }
}

function logout() {
  adminPage.style.display = "none";
  loginPage.style.display = "flex";
}

// Save to Firebase
async function saveData() {
  const payload = { nodes, rootId };

  // delete old
  const old = await treeCol.get();
  const batch1 = db.batch();
  old.forEach(d => batch1.delete(d.ref));
  await batch1.commit();

  // save new
  const batch2 = db.batch();
  batch2.set(treeCol.doc("_meta"), { rootId });
  Object.values(nodes).forEach(n => {
    batch2.set(treeCol.doc(n.id), n);
  });
  await batch2.commit();
}

// Load from Firebase
async function loadData() {
  const snap = await treeCol.get();
  if (snap.empty) return;

  let tempNodes = {};
  let tempRoot = null;

  snap.forEach(doc => {
    if (doc.id === "_meta") tempRoot = doc.data().rootId;
    else tempNodes[doc.id] = doc.data();
  });

  nodes = tempNodes;
  rootId = tempRoot;
  currentTreeRootId = rootId;
  recalcAll();
}

// Create root
async function createRootCustomer() {
  const name = newName.value.trim();
  const pass = newPass.value.trim();
  if (!name || !pass) return alert("भरें");

  const id = "C" + Date.now();
  nodes[id] = makeNode(id, name, pass);

  if (!rootId) rootId = id;
  await saveData();
  renderAll();
  newName.value = "";
  newPass.value = "";
}

// Add member
async function addMember(parentId, side) {
  const parent = nodes[parentId];
  const name = prompt("Name?");
  const pass = prompt("Password?");
  if (!name || !pass) return;

  const newId = "C" + Date.now();
  const newNode = makeNode(newId, name, pass);
  nodes[newId] = newNode;

  const oldChild = parent[side];

  newNode.parent = parentId;
  parent[side] = newId;

  if (oldChild) {
    const oc = nodes[oldChild];
    oc.parent = newId;

    if (!newNode.left) newNode.left = oldChild;
    else newNode.right = oldChild;
  }

  await saveData();
  recalcAll();
  renderAll();
  currentTreeRootId = parentId;
  renderTree();
}

// Delete
async function deleteNode(id) {
  if (!confirm("Delete?")) return;

  function remove(id) {
    const n = nodes[id];
    if (!n) return;
    if (n.left) remove(n.left);
    if (n.right) remove(n.right);
    delete nodes[id];
  }

  if (rootId === id) {
    nodes = {};
    rootId = null;
  } else {
    const p = nodes[nodes[id].parent];
    if (p.left === id) p.left = null;
    if (p.right === id) p.right = null;
    remove(id);
  }
  await saveData();
  renderAll();
}

// Recalc
function count(id) {
  if (!id) return 0;
  let c = 0;
  const n = nodes[id];
  if (n.left) c += 1 + count(n.left);
  if (n.right) c += 1 + count(n.right);
  return c;
}

function recalcAll() {
  Object.values(nodes).forEach(n => {
    const m = count(n.id);
    n.members = m;
    n.pairs = Math.floor(m / 2);
    n.commission = n.pairs * 3;
  });
}

// Render table
function renderTable() {
  tableBody.innerHTML = "";
  const list = Object.values(nodes);

  totalCustomers.textContent = list.length;

  list.forEach((n, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${n.name}</td>
      <td>${n.members}</td>
      <td>${n.pairs}</td>
      <td>₹${n.commission}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="showTree('${n.id}')">Tree</button></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteNode('${n.id}')">Del</button></td>
    `;
    tableBody.appendChild(tr);
  });
}

// Tree UI
function showTree(id) {
  currentTreeRootId = id;
  renderTree();
}

function renderTree() {
  const root = nodes[currentTreeRootId];
  if (!root) return;
  treeInfo.innerHTML = `<b>${root.name}</b> Tree`;

  let html = "";

  function lvl(ids) {
    if (!ids.length) return;
    html += `<div class="tree-level">`;

    let next = [];
    ids.forEach(id => {
      const n = nodes[id];
      const isMain = (id === rootId);
      html += `
        <div class="tree-node-wrap">
          <div class="tree-node ${isMain?"tree-node-main":""}">
            ${n.name}<br>
            <small>M:${n.members} P:${n.pairs} ₹${n.commission}</small>
            <div class="tree-node-actions">
              <button class="btn btn-sm btn-secondary" onclick="addChoice('${n.id}')">+Member</button>
            </div>
          </div>
        </div>
      `;
      if (n.left) next.push(n.left);
      if (n.right) next.push(n.right);
    });

    html += `</div>`;
    if (next.length) lvl(next);
  }

  lvl([currentTreeRootId]);
  treeArea.innerHTML = html;
}

function addChoice(id) {
  const x = prompt("Left or Right? L/R");
  if (!x) return;
  let side = x.toLowerCase()==="l"?"left":"right";
  addMember(id, side);
}

// Render All
function renderAll() {
  recalcAll();
  renderTable();
  renderTree();
}

</script>
</body>
</html>
