<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<title>RJVC Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#f3f4f6}
.wrap{max-width:1200px;margin:auto;padding:14px}
.panel{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
.flex{display:flex;align-items:center}
.between{justify-content:space-between}
.btn{border:none;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:#fff}
.btn-sm{padding:6px 10px;font-size:12px}
.small{font-size:12px;color:#6b7280}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:left}
th{font-size:11px;color:#6b7280}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="wrap">
  <div class="panel" style="max-width:380px;margin:80px auto">
    <h3>Admin Login</h3>
    <input id="adminId" placeholder="admin">
    <input id="adminPass" type="password" placeholder="1234" style="margin-top:8px">
    <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="login()">Login</button>
    <div id="loginError" class="small" style="color:red;display:none">Wrong login</div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPage" style="display:none">
<div class="wrap">

<div class="panel flex between">
  <div>
    <h2>RJVC Admin Panel</h2>
    <div class="small">Tree â€¢ Wallet â€¢ Withdraw</div>
  </div>
  <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
</div>

<!-- CREATE ROOT -->
<div class="panel">
  <h3>Create Root Customer</h3>
  <div class="flex" style="gap:10px">
    <input id="rootName" placeholder="Customer Name">
    <input id="rootPass" placeholder="Password">
  </div>
  <button class="btn btn-primary" style="margin-top:10px" onclick="createRoot()">Add Root</button>
</div>

<!-- CUSTOMER LIST -->
<div class="panel">
<h3>Customer List</h3>
<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Cycles</th>
<th>Commission</th>
<th>Action</th>
</tr>
</thead>
<tbody id="customerTable"></tbody>
</table>
</div>

</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
  authDomain:"rjvc-plan.firebaseapp.com",
  projectId:"rjvc-plan"
});

const db = firebase.firestore();
const treeCol = db
  .collection("CompanyWallets")
  .doc(COMPANY_ID)
  .collection("TreeNodes");
const usersCol = db.collection("Users");

let nodes = {};

function login(){
  if(adminId.value==="admin" && adminPass.value==="1234"){
    loginPage.style.display="none";
    adminPage.style.display="block";
    loadData();
  }else loginError.style.display="block";
}
function logout(){location.reload()}

function loadData(){
  treeCol.onSnapshot(s=>{
    nodes={};
    s.forEach(d=>nodes[d.id]=d.data());
    renderTable();
  });
}

function renderTable(){
  customerTable.innerHTML="";
  let i=1;
  Object.entries(nodes).forEach(([id,n])=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
<td>${i++}</td>
<td><b>${n.name}</b><br><span class="small">${n.password||""}</span></td>
<td>${n.monthsPaid||0}</td>
<td>â‚¹${getCommission(id)}</td>
<td>
<button class="btn btn-sm btn-secondary" onclick="openTree('${id}')">ðŸŒ³ Tree</button>
<button class="btn btn-sm btn-primary" onclick="addCycle('${id}')">â‚¹20 Paid</button>
<button class="btn btn-sm btn-danger" onclick="deleteCustomer('${id}')">ðŸ—‘ Delete</button>
</td>`;
    customerTable.appendChild(tr);
  });
}

/* ---------- SAFE COMMISSION ---------- */
function getCommission(id){
  if(!nodes[id] || nodes[id].isActive!==true) return 0;
  let count=0;
  Object.values(nodes).forEach(n=>{
    if(n.parentId===id && n.isActive===true) count++;
  });
  return Math.floor(count/2)*10;
}

/* ---------- TREE ---------- */
function openTree(id){
  window.open(
  "tree.html?admin=1&company=main",
  "_blank"
);
}

/* ---------- DELETE ---------- */
async function deleteCustomer(id){
  if(!confirm("Delete customer + downline?")) return;
  await treeCol.doc(id).delete();
  await usersCol.doc(id).delete();
  alert("Deleted");
}

/* ---------- â‚¹20 PAID (AUTO FIX USER) ---------- */
async function addCycle(id){
  const ref=usersCol.doc(id);
  let snap=await ref.get();

  // ðŸ”¥ AUTO CREATE USER IF MISSING
  if(!snap.exists){
    const t=nodes[id];
    await ref.set({
      name:t.name,
      password:t.password||"",
      bonusWallet:0,
      commissionWallet:0,
      cycleCount:0,
      isActive:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    snap=await ref.get();
  }

  const c=snap.data().cycleCount||0;
  await ref.update({
    cycleCount:c+1,
    isActive:true,
    lastPaidAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await treeCol.doc(id).update({isActive:true,monthsPaid:(nodes[id].monthsPaid||0)+1});
  alert("â‚¹20 received & activated");
}

/* ---------- CREATE ROOT ---------- */
async function createRoot(){
  if(!rootName.value||!rootPass.value) return alert("Fill both");
  const doc=await treeCol.add({
    name:rootName.value,
    password:rootPass.value,
    parentId:null,
    monthsPaid:0,
    isActive:false
  });
  await usersCol.doc(doc.id).set({
    name:rootName.value,
    password:rootPass.value,
    bonusWallet:0,
    commissionWallet:0,
    cycleCount:0,
    isActive:false,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Root created");
  rootName.value="";rootPass.value="";
}
</script>
</body>
</html>
