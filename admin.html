<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RJVC Admin Dashboard</title>

<script>
// ✅ सबसे पहले security check (sessionStorage → browser/tab बंद होते ही auto logout)
(function() {
  const flag = sessionStorage.getItem("rjvc_admin_logged");
  if (flag !== "yes") {
    window.location.href = "login.html";
  }
})();
</script>

<style>
  body {
    font-family: sans-serif;
    background: #eef2ff;
    margin: 0;
    padding: 0;
  }
  .header {
    background: #1a73ff;
    color: white;
    padding: 16px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }
  .container {
    padding: 16px;
    max-width: 1100px;
    margin: 0 auto;
  }
  .cards {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 16px;
  }
  .card {
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  .card.summary {
    flex: 1 1 130px;
    min-width: 140px;
  }
  .card h3 {
    margin: 0 0 6px 0;
    font-size: 15px;
    color: #003399;
  }
  .card .big {
    font-size: 18px;
    font-weight: bold;
  }
  .section-title {
    margin-top: 20px;
    font-size: 18px;
    font-weight: 600;
    color: #222;
  }
  input, select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #bbb;
    font-size: 13px;
  }
  label {
    font-size: 13px;
    font-weight: 600;
    display: block;
    margin-bottom: 3px;
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .col {
    flex: 1 1 150px;
  }
  .btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 14px;
    background: #1a73ff;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    border: none;
    cursor: pointer;
  }
  .btn.danger {
    background: #ff4444;
  }
  .btn.small {
    padding: 4px 8px;
    font-size: 12px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 10px;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 6px 5px;
    text-align: left;
  }
  th {
    background: #dde5ff;
  }
  .table-wrapper {
    max-height: 320px;
    overflow: auto;
  }
  .note {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }
</style>
</head>

<body>

<div class="header">RJVC - Admin Panel</div>

<div class="container">

  <!-- Summary cards -->
  <div class="cards">
    <div class="card summary">
      <h3>Total Customers</h3>
      <div id="totalCustomers" class="big">0</div>
    </div>
    <div class="card summary">
      <h3>Total Members Joined</h3>
      <div id="totalMembers" class="big">0</div>
    </div>
    <div class="card summary">
      <h3>Total Wallet Balance (₹)</h3>
      <div id="totalWallet" class="big">0</div>
    </div>
    <div class="card summary">
      <h3>Today Calculations</h3>
      <div id="todayCalc" class="big">0</div>
    </div>
    <div class="card summary">
      <h3>Pending Withdrawals</h3>
      <div id="pendingWithdrawals" class="big">0</div>
    </div>
  </div>

  <!-- Settings -->
  <div class="section-title">Plan Settings (Admin Control)</div>
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Levels</label>
        <input id="set_levels" type="number" min="1" max="20" value="11">
      </div>
      <div class="col">
        <label>Per Member Commission (₹)</label>
        <input id="set_perMember" type="number" min="0" value="15">
      </div>
      <div class="col">
        <label>Start Members</label>
        <input id="set_startMembers" type="number" min="1" value="2">
      </div>
      <div class="col">
        <label>Multiplier</label>
        <input id="set_multiplier" type="number" min="2" value="2">
      </div>
    </div>
    <button class="btn" onclick="saveSettings()">Save Settings</button>
    <div class="note">ये settings customer वाले calculator (index.html) में auto apply होंगी।</div>
  </div>

  <!-- Manual Add Customer -->
  <div class="section-title">Add Customer Manually</div>
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Customer Name</label>
        <input id="manualName" type="text" placeholder="जैसे: राजेश">
      </div>
      <div class="col">
        <label>Mobile</label>
        <input id="manualMobile" type="tel" placeholder="10 digit mobile">
      </div>
      <div class="col">
        <label>Joined Members</label>
        <input id="manualJoined" type="number" min="0" value="0">
      </div>
      <div class="col" style="align-self:flex-end;">
        <button class="btn" onclick="addCustomerManually()">Add</button>
      </div>
    </div>
    <div class="note">यह entry सिर्फ admin panel के लिए है (customer side से नहीं)।</div>
  </div>

  <!-- Customers Table -->
  <div class="section-title">Customer List & Level Report</div>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Mobile</th>
            <th>Joined</th>
            <th>Current Level</th>
            <th>Next Level</th>
            <th>Remaining</th>
            <th>Next Level Income (₹)</th>
            <th>Wallet (₹)</th>
            <th>Date</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
        </tbody>
      </table>
    </div>
    <div class="note">
      ये data index.html पर customer calculation होने पर automatic save होता है।
    </div>
  </div>

  <!-- Withdrawal Requests -->
  <div class="section-title">Bank Withdrawal Requests</div>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Customer</th>
            <th>Mobile</th>
            <th>Amount (₹)</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="withdrawTableBody">
        </tbody>
      </table>
    </div>
    <div class="note">
      यहाँ से admin हर withdrawal को Approve (Paid) या Reject कर सकता है।  
      Reject होने पर amount वापस customer के wallet में चला जाएगा।
    </div>
  </div>

  <div style="margin-top:16px;">
    <button class="btn danger" onclick="logout()">Logout</button>
  </div>

</div>

<script>
function formatNumber(n) {
  return Number(n || 0).toLocaleString("en-IN");
}

function getCustomers() {
  try {
    return JSON.parse(localStorage.getItem("rjvc_customers") || "[]");
  } catch (e) {
    console.warn("Customer read error", e);
    return [];
  }
}

function setCustomers(list) {
  localStorage.setItem("rjvc_customers", JSON.stringify(list));
}

function getWithdrawals() {
  try {
    return JSON.parse(localStorage.getItem("rjvc_withdrawals") || "[]");
  } catch (e) {
    console.warn("Withdraw read error", e);
    return [];
  }
}

function setWithdrawals(list) {
  localStorage.setItem("rjvc_withdrawals", JSON.stringify(list));
}

function loadSettingsToUI() {
  try {
    const s = JSON.parse(localStorage.getItem("rjvc_settings") || "{}");
    if (s.levels) document.getElementById("set_levels").value = s.levels;
    if (s.perMember) document.getElementById("set_perMember").value = s.perMember;
    if (s.startMembers) document.getElementById("set_startMembers").value = s.startMembers;
    if (s.multiplier) document.getElementById("set_multiplier").value = s.multiplier;
  } catch (e) {
    console.warn("Settings load error", e);
  }
}

function saveSettings() {
  const levels = parseInt(document.getElementById("set_levels").value || "0", 10);
  const perMember = parseFloat(document.getElementById("set_perMember").value || "0");
  const startMembers = parseInt(document.getElementById("set_startMembers").value || "0", 10);
  const multiplier = parseInt(document.getElementById("set_multiplier").value || "2", 10);

  const s = { levels, perMember, startMembers, multiplier };
  localStorage.setItem("rjvc_settings", JSON.stringify(s));
  alert("Settings saved. Customers वाले page पर नया plan apply होगा.");
}

function renderDashboard() {
  const customers = getCustomers();
  const withdrawals = getWithdrawals();

  const totalCustomers = customers.length;
  const totalMembers = customers.reduce((sum, c) => sum + (c.joinedMembers || 0), 0);
  const totalWallet = customers.reduce((sum, c) => sum + (c.walletBalance || 0), 0);

  const todayStr = new Date().toISOString().slice(0, 10);
  const todayCalc = customers.filter(c => (c.createdAt || "").slice(0,10) === todayStr).length;

  const pending = withdrawals.filter(w => w.status === "Pending").length;

  document.getElementById("totalCustomers").innerText = formatNumber(totalCustomers);
  document.getElementById("totalMembers").innerText = formatNumber(totalMembers);
  document.getElementById("totalWallet").innerText = formatNumber(totalWallet);
  document.getElementById("todayCalc").innerText = formatNumber(todayCalc);
  document.getElementById("pendingWithdrawals").innerText = formatNumber(pending);

  renderCustomerTable(customers);
  renderWithdrawTable(withdrawals);
}

function renderCustomerTable(customers) {
  const tbody = document.getElementById("customerTableBody");
  tbody.innerHTML = "";

  customers
    .slice()
    .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || "")) // latest first
    .forEach(c => {
      const tr = document.createElement("tr");

      const dateStr = c.createdAt ? c.createdAt.slice(0,10) : "";
      const currentLevel = c.currentLevel || (c.state === "allComplete" ? "All" : "-");
      const nextLevel = c.state === "allComplete" ? "-" : (c.nextLevel || "-");
      const remaining = c.state === "allComplete" ? "0" : formatNumber(c.remainingForNext || 0);
      const nextIncome = c.state === "allComplete" ? "-" : ("₹" + formatNumber(c.nextLevelIncome || 0));
      const wallet = "₹" + formatNumber(c.walletBalance || 0);

      tr.innerHTML = `
        <td>${c.name || "-"}</td>
        <td>${c.mobile || "-"}</td>
        <td>${formatNumber(c.joinedMembers || 0)}</td>
        <td>${currentLevel}</td>
        <td>${nextLevel}</td>
        <td>${remaining}</td>
        <td>${nextIncome}</td>
        <td>${wallet}</td>
        <td>${dateStr}</td>
        <td><button class="btn small danger" onclick="deleteCustomer(${c.id})">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
}

function renderWithdrawTable(withdrawals) {
  const tbody = document.getElementById("withdrawTableBody");
  tbody.innerHTML = "";

  withdrawals
    .slice()
    .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || "")) // latest first
    .forEach(w => {
      const tr = document.createElement("tr");
      const dateStr = w.createdAt ? w.createdAt.slice(0,10) : "";

      tr.innerHTML = `
        <td>${w.name || "-"}</td>
        <td>${w.mobile || "-"}</td>
        <td>₹${formatNumber(w.amount || 0)}</td>
        <td>${w.status}</td>
        <td>${dateStr}</td>
        <td>
          ${w.status === "Pending"
            ? `<button class="btn small" onclick="approveWithdrawal(${w.id})">Approve</button>
               <button class="btn small danger" onclick="rejectWithdrawal(${w.id})">Reject</button>`
            : "-"}
        </td>
      `;
      tbody.appendChild(tr);
    });
}

function approveWithdrawal(id) {
  const withdrawals = getWithdrawals();
  const idx = withdrawals.findIndex(w => w.id === id);
  if (idx === -1) return;

  withdrawals[idx].status = "Paid";
  setWithdrawals(withdrawals);
  renderDashboard();
}

function rejectWithdrawal(id) {
  const withdrawals = getWithdrawals();
  const idx = withdrawals.findIndex(w => w.id === id);
  if (idx === -1) return;

  const req = withdrawals[idx];
  if (req.status !== "Pending") return;

  // Refund amount to customer wallet
  const customers = getCustomers();
  const cIdx = customers.findIndex(c =>
    (c.id && req.customerId && c.id === req.customerId) ||
    (c.mobile && req.mobile && c.mobile === req.mobile)
  );
  if (cIdx !== -1) {
    customers[cIdx].walletBalance =
      (customers[cIdx].walletBalance || 0) + (req.amount || 0);
    setCustomers(customers);
  }

  withdrawals[idx].status = "Rejected";
  setWithdrawals(withdrawals);

  renderDashboard();
}

function deleteCustomer(id) {
  if (!confirm("इस customer को हटाना है?")) return;
  const customers = getCustomers().filter(c => c.id !== id);
  setCustomers(customers);
  renderDashboard();
}

function addCustomerManually() {
  const name = (document.getElementById("manualName").value || "").trim();
  const mobile = (document.getElementById("manualMobile").value || "").trim();
  const joined = parseInt(document.getElementById("manualJoined").value || "0", 10);

  if (!name || !mobile) {
    alert("नाम और mobile दोनों भरें।");
    return;
  }

  const customers = getCustomers();
  if (customers.some(c => c.mobile === mobile)) {
    alert("इस mobile के साथ customer already मौजूद है।");
    return;
  }

  const record = {
    id: Date.now(),
    name,
    mobile,
    joinedMembers: joined,
    state: "manual",
    currentLevel: 0,
    nextLevel: null,
    remainingForNext: 0,
    nextLevelIncome: 0,
    totalIncome: 0,
    walletBalance: 0,
    createdAt: new Date().toISOString()
  };

  customers.push(record);
  setCustomers(customers);

  document.getElementById("manualName").value = "";
  document.getElementById("manualMobile").value = "";
  document.getElementById("manualJoined").value = "0";

  renderDashboard();
}

function logout() {
  sessionStorage.removeItem("rjvc_admin_logged");
  window.location.href = "login.html";
}

window.addEventListener("load", function () {
  loadSettingsToUI();
  renderDashboard();
});
</script>

</body>
</html>
