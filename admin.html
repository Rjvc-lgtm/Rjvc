<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<title>RJVC ADMIN PANEL</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
body{margin:0;background:#eef3ff}
.page{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:480px;width:100%}
h1,h2,h3{margin:0 0 10px}
label{display:block;margin-top:10px;font-size:14px}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e1}
input:focus{border-color:#2563eb;outline:none}
.btn{padding:10px 16px;border:none;border-radius:20px;font-weight:600;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#dde7ff;color:#1e3a8a}
.btn-danger{background:#fecaca;color:#991b1b}
.btn-sm{padding:6px 10px;font-size:12px}
.wrap{max-width:1100px;width:100%;margin:20px auto}
.panel{background:#fff;padding:16px;border-radius:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.1)}
.table-wrap{overflow-x:auto;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #e2e8f0}
th{text-align:left;background:#f8fafc;font-size:11px}
.badge{background:#e5edff;color:#1e40af;padding:4px 10px;border-radius:20px;font-size:11px}
.status-pending{background:#fef08a}
.status-approved{background:#bbf7d0}
.status-rejected{background:#fecaca}
.tree-panel{background:#0f172a;color:#e2e8f0;padding:16px;border-radius:16px}
.tree-node{background:#1e293b;border:1px solid #475569;border-radius:12px;padding:8px;margin:8px;display:inline-block;text-align:center;min-width:120px}
.tree-node-main{background:#2563eb;border-color:#93c5fd}
.tree-actions button{margin:2px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="page">
<div class="card">
<h1>Admin Login</h1>

<label>Admin ID</label>
<input id="adminId" placeholder="admin">

<label>Admin Password</label>
<input id="adminPass" type="password" placeholder="1234">

<button class="btn btn-primary" style="width:100%;margin-top:15px" onclick="adminLogin()">Login</button>

<div id="loginError" style="color:red;display:none;margin-top:10px">
गलत ID या Password
</div>
</div>
</div>


<!-- ADMIN PAGE -->
<div id="adminPage" style="display:none">
<div class="wrap">

<div class="panel" style="display:flex;justify-content:space-between;align-items:center">
<h2>RJVC Binary Tree - Admin</h2>
<button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
</div>

<!-- Create Root -->
<div class="panel">
<h3>नया Root Customer जोड़ें</h3>
<label>Name</label>
<input id="newName">
<label>Password</label>
<input id="newPass">
<button class="btn btn-primary" style="margin-top:10px" onclick="addRoot()">Add Root</button>
</div>

<!-- Customer List -->
<div class="panel">
<h3>Customer List</h3>
<span class="badge" id="custCount">0 Customers</span>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Members</th>
<th>Pairs</th>
<th>Commission</th>
<th>Tree</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="listBody"></tbody>
</table>
</div>
</div>

<!-- Withdrawal List -->
<div class="panel">
<h3>Withdrawal Requests</h3>
<span class="badge" id="wdCount">0</span>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>#</th>
<th>Customer</th>
<th>Amount</th>
<th>Wallet</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="wdBody"></tbody>
</table>
</div>
</div>

<!-- Tree Panel -->
<div class="tree-panel">
<div id="treeInfo"></div>
<div id="treeArea" style="margin-top:20px"></div>
</div>

</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// FIREBASE INIT
firebase.initializeApp({
apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
authDomain: "rjvc-plan.firebaseapp.com",
projectId: "rjvc-plan"
});
const db = firebase.firestore();
const treeCol = db.collection("TreeNodes");
const wdCol = db.collection("Withdrawals");
  // ---------------- ADMIN LOGIN ----------------
const ADMIN_ID="admin";
const ADMIN_PASS="1234";

function adminLogin(){
let id=document.getElementById("adminId").value.trim();
let pw=document.getElementById("adminPass").value.trim();

if(id===ADMIN_ID && pw===ADMIN_PASS){
document.getElementById("loginPage").style.display="none";
document.getElementById("adminPage").style.display="block";
loadTree();
loadWithdrawals();
}else{
document.getElementById("loginError").style.display="block";
}
}

function logout(){
document.getElementById("adminPage").style.display="none";
document.getElementById("loginPage").style.display="flex";
}

// ---------------- TREE DATA ----------------
let nodes={};
let rootId=null;
let currentRoot=null;

// Load Tree from Firebase
async function loadTree(){
let snap=await treeCol.get();
nodes={};
rootId=null;

snap.forEach(doc=>{
if(doc.id==="_meta"){
rootId=doc.data().rootId;
} else {
nodes[doc.id]=doc.data();
}
});

currentRoot=rootId;
recalc();
renderList();
renderTree();
}

// Save Tree
async function saveTree(){
let old=await treeCol.get();
let batch=db.batch();
old.forEach(d=>batch.delete(d.ref));
await batch.commit();

let batch2=db.batch();
batch2.set(treeCol.doc("_meta"),{rootId});
Object.values(nodes).forEach(n=>{
batch2.set(treeCol.doc(n.id),n);
});
await batch2.commit();
}

// ---------------- ADD ROOT ----------------
async function addRoot(){
let name=document.getElementById("newName").value.trim();
let pass=document.getElementById("newPass").value.trim();

if(!name||!pass){alert("Fill Fields");return;}

let id="C"+Date.now();
nodes[id]={id,name,password:pass,left:null,right:null,parent:null};

if(!rootId) rootId=id;

await saveTree();
await loadTree();

document.getElementById("newName").value="";
document.getElementById("newPass").value="";
}

// ---------------- ADD CHILD ----------------
async function addChild(parentId,side){
let name=prompt("Name?");
if(!name) return;
let pass=prompt("Password?");
if(!pass) return;

let newId="C"+Date.now();
let newNode={id:newId,name,password:pass,left:null,right:null,parent:parentId};

let old=nodes[parentId][side];
nodes[newId]=newNode;
nodes[parentId][side]=newId;

if(old){
nodes[old].parent=newId;
newNode.left=old;
}

await saveTree();
await loadTree();
currentRoot=parentId;
renderTree();
}

// ---------------- DELETE NODE ----------------
async function deleteNode(id){
if(!confirm("Delete This Customer with tree?")) return;

function del(id){
let n=nodes[id];
if(!n) return;
if(n.left) del(n.left);
if(n.right) del(n.right);
delete nodes[id];
}

if(id===rootId){
nodes={};
rootId=null;
} else {
let p=nodes[nodes[id].parent];
if(p.left===id) p.left=null;
if(p.right===id) p.right=null;
del(id);
}

await saveTree();
await loadTree();
}

// ---------------- RECALC ----------------
function count(id){
if(!id) return 0;
let n=nodes[id];
let c=0;
if(n.left) c+=1+count(n.left);
if(n.right) c+=1+count(n.right);
return c;
}

function recalc(){
Object.values(nodes).forEach(n=>{
let m=count(n.id);
n.members=m;
n.pairs=Math.floor(m/2);
n.commission=n.pairs*3;
});
}

// ---------------- RENDER LIST ----------------
function renderList(){
let tb=document.getElementById("listBody");
tb.innerHTML="";

let arr=Object.values(nodes).sort((a,b)=>a.name.localeCompare(b.name));
document.getElementById("custCount").innerText=arr.length+" Customers";

arr.forEach((n,i)=>{
let tr=document.createElement("tr");
tr.innerHTML=`
<td>${i+1}</td>
<td>${n.name}</td>
<td>${n.members}</td>
<td>${n.pairs}</td>
<td>₹${n.commission}</td>
<td><button class='btn btn-secondary btn-sm' onclick="openTree('${n.id}')">Tree</button></td>
<td><button class='btn btn-danger btn-sm' onclick="deleteNode('${n.id}')">Del</button></td>
`;
tb.appendChild(tr);
});
}

// ---------------- RENDER TREE ----------------
function openTree(id){
currentRoot=id;
renderTree();
}

function renderTree(){
let n=nodes[currentRoot];
if(!n){
document.getElementById("treeArea").innerHTML="No Tree Found";
return;
}

document.getElementById("treeInfo").innerHTML=
`<b>${n.name}</b> (M:${n.members} P:${n.pairs} ₹${n.commission})`;

let html="";
function build(ids){
if(!ids.length) return;
html+=`<div style='text-align:center'>`;
let next=[];

ids.forEach(id=>{
let n=nodes[id];
html+=`
<div class="tree-node ${id===rootId?'tree-node-main':''}">
<b>${n.name}</b><br>
<small>M:${n.members} P:${n.pairs} ₹${n.commission}</small>
<div class="tree-actions">
<button class='btn btn-secondary btn-sm' onclick="askSide('${n.id}')">+Member</button>
</div>
</div>
`;
if(n.left) next.push(n.left);
if(n.right) next.push(n.right);
});
html+=`</div>`;

if(next.length) build(next);
}

build([currentRoot]);
document.getElementById("treeArea").innerHTML=html;
}

function askSide(id){
let side=prompt("Left=L , Right=R").toLowerCase();
if(side==="l") addChild(id,"left");
else addChild(id,"right");
}

// ---------------- WITHDRAWALS ----------------
function loadWithdrawals(){
wdCol.orderBy("createdAt","desc").onSnapshot(snap=>{
let body=document.getElementById("wdBody");
body.innerHTML="";
let i=0;

snap.forEach(doc=>{
let d=doc.data();
i++;

let statusClass="status-pending";
if(d.status==="approved") statusClass="status-approved";
if(d.status==="rejected") statusClass="status-rejected";

body.innerHTML+=`
<tr>
<td>${i}</td>
<td>${d.customerName}</td>
<td>₹${d.amount}</td>
<td>${d.walletType}</td>
<td><span class='${statusClass}'>${d.status}</span></td>
<td>
<button class='btn btn-secondary btn-sm' onclick="updateWD('${doc.id}','approved')" ${d.status!=='pending'?'disabled':''}>Approve</button>
<button class='btn btn-danger btn-sm' onclick="updateWD('${doc.id}','rejected')" ${d.status!=='pending'?'disabled':''}>Reject</button>
</td>
</tr>`;
});

document.getElementById("wdCount").innerText=i;
});
}

async function updateWD(id,status){
await wdCol.doc(id).update({status});
}
</script>
</body>
</html>
