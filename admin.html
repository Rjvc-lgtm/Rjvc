<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>RJVC Binary Tree Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#020617;color:#e5e7eb}
.wrap{max-width:1200px;margin:auto;padding:14px}
h2{margin-top:0}
.small{font-size:13px;color:#94a3b8}
.center{text-align:center}

.btn{padding:8px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb;color:#111827}
.btn-danger{background:#dc2626;color:#fff}

.card{background:#0b1320;border-radius:14px;padding:16px}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:center}
th{background:#020617}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="wrap">
  <div class="card" style="max-width:400px;margin:60px auto;">
    <h2 class="center">Admin Login</h2>
    <input id="adminId" placeholder="admin" style="width:100%;padding:10px;margin-top:8px">
    <input id="adminPass" type="password" placeholder="1234" style="width:100%;padding:10px;margin-top:8px">
    <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="login()">Login</button>
    <div id="loginError" class="small" style="color:#f87171;display:none">Wrong login</div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPage" style="display:none">

<div class="wrap">
  <h2>Binary Tree Admin</h2>
  <div class="small">
    ‡§π‡§∞ customer ‡§ï‡•á ‡§∏‡§æ‡§Æ‡§®‡•á +‚Çπ20 button ‡§π‡•à<br>
    Delete ‡§ï‡•á ‡§¨‡§æ‡§¶ tre

<!-- CREATE ROOT -->
<!-- ================= PART-C : TREE BUTTON ================= -->
<div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
  
  <button class="btn btn-primary"
    onclick="document.getElementById('treeSection').style.display='block'">
    üå≥ Tree Dekho (Admin)
  </button>

  <a href="tree.html" target="_blank">
    <button class="btn btn-secondary">
      üîç Full Screen Tree
    </button>
  </a>

</div>
</div>

<!-- CUSTOMER LIST -->
<div class="wrap">
  <h2>Customer List</h2>
  <table>...</table>
</div>
  <!-- ===== STEP-1 : CUSTOMER SUMMARY CARD ===== -->
<div class="wrap">
  <div class="card" style="background:#eef6ff">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Customer List (Tree Nodes)</h3>
      <div class="small" id="totalCustomers">0 Customers</div>
    </div>

    <div class="card" style="margin-top:10px;background:#f8fbff">
      <div class="small">‡§ï‡•Å‡§≤ Pairs (‡§™‡•Ç‡§∞‡§æ Tree)</div>
      <h2 id="totalPairs">0</h2>
    </div>

    <div class="card" style="margin-top:10px;background:#f8fbff">
      <div class="small">‡§ï‡•Å‡§≤ Binary Income (‡§∏‡§≠‡•Ä IDs ‡§∏‡•á)</div>
      <h2 id="totalBinaryIncome">‚Çπ0</h2>
    </div>
  </div>
</div>
<!-- ===== STEP-1 END ===== -->
<!-- ================= PART-D START ================= -->
<style>
.action-btn{
  padding:4px 8px;
  font-size:12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  margin:2px;
}
.btn-tree{background:#2563eb;color:#fff}
.btn-del{background:#dc2626;color:#fff}
</style>

<script>
  /* ===== STEP-2 : TREE BUTTON FUNCTION ===== */

function openTreeForCustomer(customerId){
  // tree.html page open kare with customer id
  window.location.href = "tree.html?root=" + customerId;
}
/* ================= PART-D : DELETE + TREE ================= */

/* üîπ Customer table me Tree + Delete button add */
function enhanceCustomerTable(){
  const rows = document.querySelectorAll("#customerTable tr");
  rows.forEach((tr,idx)=>{
    if(tr.dataset.enhanced) return;
    tr.dataset.enhanced="yes";

    const nameCell = tr.children[1];
    const custName = nameCell.innerText;

    const btnWrap = document.createElement("div");

    const treeBtn = document.createElement("button");
    treeBtn.innerText="üå≥ Tree";
    treeBtn.className="action-btn btn-tree";
    treeBtn.onclick=()=>openSingleTree(custName);

    const delBtn = document.createElement("button");
    delBtn.innerText="üóë Delete";
    delBtn.className="action-btn btn-del";
    delBtn.onclick=()=>deleteCustomerOnly(custName);

    btnWrap.appendChild(treeBtn);
    btnWrap.appendChild(delBtn);
    nameCell.appendChild(btnWrap);
  });
}

/* üîπ Sirf selected customer ka tree */
function openSingleTree(name){
  localStorage.setItem("treeRootName",name);
  window.open("tree.html","_blank");
}

/* üîπ Customer delete (subtree nahi) */
async function deleteCustomerOnly(name){
  if(!confirm(name+" delete karna hai?")) return;

  let targetId=null;
  Object.keys(nodes).forEach(id=>{
    if(nodes[id].name===name) targetId=id;
  });
  if(!targetId){ alert("Customer not found"); return }

  const node = nodes[targetId];
  const parentId = node.parentId;

  /* üîÅ children auto reattach */
  const children=[];
  if(node.leftId) children.push(node.leftId);
  if(node.rightId) children.push(node.rightId);

  if(parentId){
    const parentRef = treeCol.doc(parentId);
    const parent = nodes[parentId];
    let updates={};

    if(parent.leftId===targetId) updates.leftId=null;
    if(parent.rightId===targetId) updates.rightId=null;
    await parentRef.update(updates);

    for(let cid of children){
      await attachBalanced(parentId,cid);
    }
  }

  await treeCol.doc(targetId).delete();
  alert("Customer deleted & tree balanced");
}

/* üîπ Auto balance left/right */
async function attachBalanced(parentId,childId){
  const parent = nodes[parentId];
  const leftCount = countSide(parent.leftId);
  const rightCount = countSide(parent.rightId);

  let side = leftCount<=rightCount ? "leftId":"rightId";
  await treeCol.doc(parentId).update({[side]:childId});
  await treeCol.doc(childId).update({parentId});
}

function countSide(id){
  if(!id) return 0;
  const n = nodes[id];
  return 1 + countSide(n.leftId) + countSide(n.rightId);
}

/* üîÑ table render ke baad call */
const oldRender = renderTable;
renderTable = function(){
  oldRender();
  setTimeout(enhanceCustomerTable,100);
};
</script>
<!-- ================= PART-D END ================= -->
<!-- üîΩüîΩ YAHI PASTE KARE PART-B üîΩüîΩ -->

<!-- ================= TREE VIEW (PART-B) ================= -->
<div id="treeSection" class="wrap" style="display:none">
  <div class="card">
    <h3>Binary Tree View</h3>
    <div class="small">
      Admin yahan se tree dekh sakta hai
    </div>

    <div id="treeContainer" style="margin-top:14px"></div>

    <button class="btn btn-secondary" style="margin-top:12px"
      onclick="document.getElementById('treeSection').style.display='none'">
      Close Tree
    </button>
  </div>
</div>

</div>  <!-- adminPage end -->

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
  authDomain: "rjvc-plan.firebaseapp.com",
  projectId: "rjvc-plan"
});

const db = firebase.firestore();
const treeCol = db.collection("TreeNodes");

let nodes = {};

/* LOGIN */
function login(){
  if(adminId.value==="admin" && adminPass.value==="1234"){
    loginPage.style.display="none";
    adminPage.style.display="block";
    loadData();
  }else loginError.style.display="block";
}
function logout(){ location.reload(); }

/* LOAD DATA */
function loadData(){
  treeCol.onSnapshot(snap=>{
    nodes={};
    snap.forEach(d=>nodes[d.id]=d.data());
    renderTable();
  });
}

/* CREATE ROOT */
function createRoot(){
  if(!rootName.value||!rootPass.value) return alert("Fill both");
  treeCol.add({
    name:rootName.value,
    password:rootPass.value,
    monthsPaid:1,
    parentId:null,leftId:null,rightId:null
  });
  rootName.value="";rootPass.value="";
}

/* ===================== PART-1 ADD ‚Çπ20 ===================== */
async function addTwentyRupees(id){
  try{
    const ref = treeCol.doc(id);
    const snap = await ref.get();
    if(!snap.exists) return alert("Customer not found");

    const current = snap.data().monthsPaid || 0;
    await ref.update({ monthsPaid: current + 1 });

    alert("‚Çπ20 added successfully ‚úÖ");
  }catch(e){
    alert("Error: "+e.message);
  }
}

/* TABLE */
function renderTable(){
  customerTable.innerHTML="";
  let i=1;
  Object.entries(nodes).forEach(([id,n])=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i++}</td>
      <td>${n.name||""}</td>
      <td>${n.monthsPaid||0} x ‚Çπ20</td>
      <td>

        <!-- üå≥ TREE BUTTON (ADD) -->
        <button class="btn btn-secondary"
          onclick="openTreeView('${id}')">
          üå≥ Tree
        </button>

        <button class="btn btn-primary"
          onclick="addTwentyRupees('${id}')">
          +‚Çπ20
        </button>

        <button class="btn btn-danger"
          onclick="deleteCustomerByAdmin_SAFE('${id}','${n.name}')">
          Delete
        </button>
      </td>
    `;
    customerTable.appendChild(tr);
  });
  enhanceCustomerTable();
}
</script>

<!-- SAFE DELETE + AUTO BALANCE (ADD ONLY, ‡§™‡§π‡§≤‡•á ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ) -->
<script>
async function deleteCustomerByAdmin_SAFE(id,name){
  if(!confirm(name+" delete?")) return;
  let snap=await treeCol.doc(id).get();
  if(!snap.exists) return;
  await treeCol.doc(id).delete();
  alert("Deleted");
}
</script>

</body>
</html>
