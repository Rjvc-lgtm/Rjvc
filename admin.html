<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Binary Tree Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:#f3f4f6;color:#111827;}
    h1,h2,h3{margin:0 0 8px;}

    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.15);padding:22px;max-width:480px;width:100%;}
    label{display:block;font-size:14px;margin-bottom:4px;}
    input{width:100%;padding:10px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:15px;outline:none;}
    input:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.25);}
    .btn{border:none;border-radius:999px;padding:10px 18px;font-size:15px;font-weight:600;cursor:pointer;}
    .btn-primary{background:#2563eb;color:#fff;}
    .btn-secondary{background:#e5e7eb;color:#111827;}
    .btn-danger{background:#dc2626;color:#fff;}
    .btn-sm{padding:6px 10px;font-size:12px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .mt-1{margin-top:4px;}
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .flex{display:flex;}
    .between{justify-content:space-between;align-items:center;}
    .center{text-align:center;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{font-size:12px;text-transform:uppercase;color:#6b7280;}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;background:#dbeafe;color:#1d4ed8;}
    .wrap{max-width:1100px;width:100%;margin:24px auto;padding:0 8px;}
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(15,23,42,.1);padding:18px;margin-bottom:18px;}
    .wallets{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;}
    .wallet-box{flex:1 1 180px;background:#eff6ff;border-radius:14px;padding:10px 12px;}
    .wallet-title{font-size:12px;color:#4b5563;}
    .wallet-value{font-size:18px;font-weight:700;color:#1d4ed8;}
    .small{font-size:12px;color:#6b7280;}
    .error{color:#dc2626;font-size:13px;margin-top:6px;}
    .ok{color:#166534;font-size:13px;margin-top:6px;}

    /* Tree panel */
    .tree-panel{background:#020617;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:8px;position:relative;overflow:visible;}
    .tree-root-label{font-size:13px;color:#a5b4fc;margin-bottom:4px;}

    /* Compact node styling (updated) */
    .tree-level{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      text-align:center;
      margin:10px 0;
    }
    .tree-node-wrap{display:flex;justify-content:center;width:auto;min-width:120px;}
    .tree-node{
      padding:8px 10px;
      border-radius:10px;
      background:#111827;
      border:1px solid #3f4752;
      font-size:12px;
      min-width:120px;
      box-shadow:0 6px 12px rgba(2,6,23,0.35);
    }
    .tree-node-main{background:#1d4ed8;border-color:#7fb4ff;}
    .tree-node-name{font-weight:700;color:#e6eefc;font-size:13px;text-align:center;}
    .tree-node-meta{font-size:10px;color:#cbd5e1;margin-top:6px;text-align:center;}
    .tree-node-actions{margin-top:6px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
    .tree-node-actions .btn-sm{padding:5px 8px;font-size:11px;border-radius:8px;}

    .profit-panel{background:#0f172a;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:10px;}
    .profit-boxes{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .profit-box{flex:1 1 160px;background:#020617;border-radius:14px;padding:10px 12px;border:1px solid #1e293b;}
    .profit-label{font-size:12px;color:#9ca3af;}
    .profit-value{font-size:18px;font-weight:700;}

    /* overlay container for SVG */
    .overlay-wrap{position:relative; width:100%;}

    @media(max-width:720px){
      .panel{padding:14px;}
      table{font-size:12px;}
      .tree-node{min-width:110px;padding:6px 8px;}
      .tree-node-name{font-size:12px;}
      .tree-node-meta{font-size:9px;}
    }
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page">
  <div class="card">
    <h1 class="center">RJVC Admin Login</h1>
    <p class="center" style="font-size:13px;color:#6b7280;margin-bottom:16px;">
      यह पेज सिर्फ admin के लिए है।
    </p>
    <label>Admin ID</label>
    <input id="adminId" placeholder="जैसे: admin" />
    <div class="mt-2"></div>
    <label>Password</label>
    <input id="adminPass" type="password" placeholder="जैसे: 1234" />
    <button class="btn btn-primary mt-3" style="width:100%;" onclick="handleAdminLogin()">
      Login
    </button>
    <div id="loginError" class="error" style="display:none;">गलत ID या Password</div>
    <p style="margin-top:12px;font-size:12px;color:#6b7280;">
      Default: <b>ID: admin</b>, <b>Password: 1234</b>
    </p>
  </div>
</div>

<!-- ADMIN MAIN PAGE -->
<div id="adminPage" style="display:none;">
  <div class="wrap">
    <!-- HEADER -->
    <div class="panel flex between">
      <div>
        <h2>Binary Tree Admin (Firebase)</h2>
        <div class="small">
          हर ID जब भी  <b>20₹</b> देती है उसे एक <b>cycle</b> माना गया है।<br/>
          Binary pairs commission (per cycle):  
          1–4 level: ₹10, 5: ₹8, 6: ₹7, 7: ₹6, 8: ₹5, 9: ₹4, 10+ : ₹3।<br/>
          जिन IDs के नाम में <b>“sub”</b> आता है, उनकी कुल commission का <b>80%</b> उनकी main ID के <b>Bonus Wallet</b> में जाता है  
          (20% company के पास – customer को नहीं दिखता)।
        </div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- CREATE ROOT CUSTOMER -->
    <div class="panel">
      <h3>नया Customer बनाएं (Root level)</h3>
      <div class="flex" style="gap:10px;flex-wrap:wrap;margin-top:8px;">
        <div style="flex:1 1 200px;">
          <label>Customer Name</label>
          <input id="rootName" placeholder="जैसे: Rajesh" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Customer Password (Login के लिए)</label>
          <input id="rootPass" placeholder="जैसे: 1234" />
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="createRootCustomer()">
        Root में नया Customer जोड़ें
      </button>
      <div id="rootMsg" class="ok" style="display:none;"></div>
      <p class="small" style="margin-top:6px;">
        एक main ID बनाओ, उसके नीचे +Member से उसकी sub IDs जोड़ो।  
        जब भी customer 20₹ दे, नीचे की list में <b>+₹20</b> button दबाओ, system अपने-आप commission + bonus wallets update करेगा।
      </p>
    </div>

    <!-- COMPANY BUSINESS REPORT -->
    <div class="panel">
      <h3>Company Business Report (Auto)</h3>
      <p class="small">
        पूरा tree से calculation: <b>सभी cycles × 20₹ = Business Income</b>,  
        minus total binary payout (सभी commission wallets) = <b>Company Profit</b>।
      </p>

      <div class="profit-panel">
        <div class="profit-boxes">
          <div class="profit-box">
            <div class="profit-label">Total Business Income (सभी cycles × 20₹)</div>
            <div class="profit-value" id="bizTotalIncome">₹0</div>
          </div>
          <div class="profit-box">
            <div class="profit-label">Total Binary Income (Members को)</div>
            <div class="profit-value" id="bizBinaryPayout">₹0</div>
          </div>
          <div class="profit-box">
            <div class="profit-label">Company Profit (₹)</div>
            <div class="profit-value" id="bizCompanyProfit">₹0</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="small">Business Chart (Income vs Payout vs Profit)</div>
          <canvas id="businessChart" width="400" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- CUSTOMER LIST -->
    <div class="panel">
      <div class="flex between">
        <h3>Customer List (Tree Nodes)</h3>
        <span class="badge" id="totalCustomersBadge">0 Customers</span>
      </div>
      <div class="wallets">
        <div class="wallet-box">
          <div class="wallet-title">कुल Pairs (पूरा Tree)</div>
          <div id="totalPairs" class="wallet-value">0</div>
        </div>
        <div class="wallet-box">
          <div class="wallet-title">कुल Binary Income (सभी IDs से)</div>
          <div id="totalCommission" class="wallet-value">₹0</div>
        </div>
      </div>
      <div class="mt-3" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name / Login</th>
              <th>Members<br/>(Total)</th>
              <th>Left / Right Members</th>
              <th>Pairs</th>
              <th>Level</th>
              <th>20₹ Cycles</th>
              <th>Binary Income<br/>(₹)</th>
              <th>Payout</th>
              <th>Tree</th>
              <th>Del</th>
            </tr>
          </thead>
          <tbody id="customerTableBody"></tbody>
        </table>
      </div>
      <p class="small" style="margin-top:6px;">
        Binary logic: हर 2 member = 1 pair.  
        Commission पहले pair से निकलेगी, फिर जितनी बार 20₹ का payment (cycles) हुआ है, उतनी बार income count होगी।  
        सिर्फ जिन IDs के नाम में “sub” आता है, उनकी कुल commission से 80% उनकी main ID के Bonus Wallet में जाता है।
      </p>
    </div>

    <!-- TREE VIEW -->
    <div class="tree-panel">
      <div class="flex between">
        <div>
          <div class="tree-root-label">Binary Tree View</div>
          <div id="treeRootInfo" style="font-size:13px;">अभी कोई root select नहीं है।</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="showFullRootTree()">सिर्फ Root दिखाओ</button>
      </div>

      <!-- Combined diagram wrapper: svg overlay + nodes in same parent -->
      <div class="tree-diagram-wrap" style="position:relative; margin-top:10px; min-height:120px;">
        <div id="treeViewArea" style="position:relative; font-size:12px; min-height:120px; padding-bottom:20px;"></div>
        <svg id="treeSvg" style="position:absolute; left:0; top:0; width:100%; height:0; pointer-events:none; overflow:visible; z-index:1;"></svg>
      </div>
    </div>

  </div>
</div>

<!-- FIREBASE CDN -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

<script>
  /************ Firebase config – RJVC PLAN ************/
  const firebaseConfig = {
    apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
    authDomain: "rjvc-plan.firebaseapp.com",
    projectId: "rjvc-plan",
    storageBucket: "rjvc-plan.firebasestorage.app",
    messagingSenderId: "265431528728",
    appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d",
    measurementId: "G-1Y7PN96H93"
  };

  firebase.initializeApp(firebaseConfig);
  try { firebase.analytics(); } catch(e) {}

  const db       = firebase.firestore();
  const treeCol  = db.collection("TreeNodes");
  const usersCol = db.collection("Users");

  /************ Simple Admin Login ************/
  const ADMIN_ID       = "admin";
  const ADMIN_PASSWORD = "1234";

  function handleAdminLogin(){
    const id   = document.getElementById("adminId").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    const err  = document.getElementById("loginError");

    if(id === ADMIN_ID && pass === ADMIN_PASSWORD){
      err.style.display = "none";
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("adminPage").style.display = "block";
      startSubscriptions();
    }else{
      err.style.display = "block";
    }
  }

  function logout(){
    document.getElementById("adminPage").style.display = "none";
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("adminPass").value = "";
  }

  /************ Tree data in memory ************/
  let nodesById         = {};
  let rootId            = null;
  let currentTreeRootId = null;
  let treeUnsub         = null;

  function startSubscriptions(){
    if(treeUnsub) treeUnsub();
    treeUnsub = treeCol.orderBy("createdAt","asc").onSnapshot(snap=>{
      nodesById = {};
      rootId = null;
      snap.forEach(doc=>{
        const d = doc.data();
        nodesById[doc.id] = Object.assign({id:doc.id}, d);
      });

      // root = जिसकी parentId null है
      Object.values(nodesById).forEach(n=>{
        if(!n.parentId) rootId = n.id;
      });

      recalcAll();
      renderTable();
      renderTree();

      // small redraw after snapshot
      setTimeout(()=>{ try{ drawConnections(); }catch(e){} }, 160);
    }, err=>{
      console.error("snapshot err", err);
    });
  }

  /************ Create Root Customer ************/
  async function createRootCustomer(){
    const name = document.getElementById("rootName").value.trim();
    const pass = document.getElementById("rootPass").value.trim();
    const msg  = document.getElementById("rootMsg");
    msg.style.display = "none";

    if(!name || !pass){
      msg.textContent = "Name और Password दोनों जरूरी हैं।";
      msg.className = "error";
      msg.style.display = "block";
      return;
    }

    try{
      const newDoc = await treeCol.add({
        name,
        password: pass,
        parentId: null,
        leftId: null,
        rightId: null,
        mainAccountId: null,
        monthsPaid: 1, // joining पर पहली 20₹ cycle मानी
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await newDoc.update({ mainAccountId: newDoc.id });

      await usersCol.doc(newDoc.id).set({
        name,
        password: pass,
        loginName: name,
        loginPassword: pass,
        commissionWallet: 0,
        bonusWallet: 0,
        mainAccountId: newDoc.id,
        monthsPaid: 1,
        payoutBlocked: false
      }, {merge:true});

      document.getElementById("rootName").value = "";
      document.getElementById("rootPass").value = "";

      msg.textContent = "Customer root में सफलतापूर्वक जोड़ा गया।";
      msg.className = "ok";
      msg.style.display = "block";
    }catch(err){
      msg.textContent = "Error: " + err.message;
      msg.className = "error";
      msg.style.display = "block";
    }
  }

  /************ Utility – descendants / left / right count ************/
  function countDescendants(nodeId){
    const node = nodesById[nodeId];
    if(!node) return 0;
    let c = 0;
    if(node.leftId)  c += 1 + countDescendants(node.leftId);
    if(node.rightId) c += 1 + countDescendants(node.rightId);
    return c;
  }

  function countSideMembers(nodeId, sideField){
    const node = nodesById[nodeId];
    if(!node || !node[sideField]) return 0;
    const childId = node[sideField];
    return 1 + countDescendants(childId);
  }

  /************ helper: sub-name check + base main name ************/
  function getBaseMainName(name){
    if(!name) return null;
    const lower = name.toLowerCase();
    const idx = lower.indexOf("sub");
    if(idx === -1) return null;
    return lower.slice(0, idx).trim();
  }

  function isSubName(name){
    return getBaseMainName(name) !== null;
  }

  function findMainByName(baseName){
    if(!baseName) return null;
    const target = baseName.trim();
    let foundId = null;
    Object.values(nodesById).forEach(n=>{
      if(n.name && n.name.toLowerCase().trim() === target){
        foundId = n.id;
      }
    });
    return foundId;
  }

  /************ Main account decide (NAME BASED) ************/
  function getMainAccountId(node){
    if(!node) return null;

    if(!isSubName(node.name)){
      return node.id;
    }

    const base = getBaseMainName(node.name);
    const byName = findMainByName(base);
    if(byName) return byName;

    let current = node;
    while(current.parentId && nodesById[current.parentId]){
      const parent = nodesById[current.parentId];
      if(!parent) break;
      if(!isSubName(parent.name)){
        return parent.id;
      }
      current = parent;
    }
    return node.id;
  }

  /************ Commission Slabs (per pair) ************/
  const LEVEL_RATES = [
    { level:1, pairs:1,   rate:10 },
    { level:2, pairs:2,   rate:10 },
    { level:3, pairs:4,   rate:10 },
    { level:4, pairs:8,   rate:10 },
    { level:5, pairs:16,  rate:8  },
    { level:6, pairs:32,  rate:7  },
    { level:7, pairs:64,  rate:6  },
    { level:8, pairs:128, rate:5  },
    { level:9, pairs:256, rate:4  },
    { level:10,pairs:512, rate:3  }
  ];

  function computeCommissionForPairs(totalPairs){
    let remaining   = totalPairs;
    let commission  = 0;

    for(let i=0;i<LEVEL_RATES.length && remaining>0;i++){
      const slab = LEVEL_RATES[i];
      const usePairs = Math.min(remaining, slab.pairs);
      commission += usePairs * slab.rate;
      remaining  -= usePairs;
    }
    if(remaining > 0){
      const lastRate = LEVEL_RATES[LEVEL_RATES.length-1].rate;
      commission += remaining * lastRate;
    }
    return commission;
  }

  let globalTotalPairs       = 0;
  let globalTotalCommission  = 0;
  let globalTotalCustomers   = 0;
  let globalTotalBusinessInc = 0;

  function recalcAll(){
    globalTotalPairs       = 0;
    globalTotalCommission  = 0;
    globalTotalCustomers   = Object.keys(nodesById).length;
    globalTotalBusinessInc = 0;

    const list = Object.values(nodesById);

    list.forEach(n=>{
      const members    = countDescendants(n.id);
      const leftCount  = countSideMembers(n.id,"leftId");
      const rightCount = countSideMembers(n.id,"rightId");
      const pairs      = Math.floor(members/2);

      const cycles     = n.monthsPaid || 1;
      const perCycleComm = computeCommissionForPairs(pairs);
      const totalComm  = perCycleComm * cycles;

      n.members            = members;
      n.leftCount          = leftCount;
      n.rightCount         = rightCount;
      n.pairs              = pairs;
      n.commissionPerCycle = perCycleComm;
      n.commission         = totalComm;

      globalTotalPairs      += pairs;
      globalTotalCommission += totalComm;
      globalTotalBusinessInc += cycles * 20;
    });

    const companyProfit = globalTotalBusinessInc - globalTotalCommission;

    document.getElementById("totalPairs").textContent      = globalTotalPairs;
    document.getElementById("totalCommission").textContent = "₹" + globalTotalCommission;

    document.getElementById("bizTotalIncome").textContent   = "₹" + globalTotalBusinessInc;
    document.getElementById("bizBinaryPayout").textContent  = "₹" + globalTotalCommission;
    document.getElementById("bizCompanyProfit").textContent = "₹" + companyProfit;

    drawBusinessChart(globalTotalBusinessInc, globalTotalCommission, companyProfit);

    updateUsersWallets().catch(err=>console.error(err));
  }

  /************ Users wallets update (commission + bonus 80%) ************/
  async function updateUsersWallets(){
    const list = Object.values(nodesById);
    const bonusMap = {}; // mainId -> total bonus

    list.forEach(n=>{
      const mainId = getMainAccountId(n);
      n.mainAccountId = mainId;

      treeCol.doc(n.id).set({ mainAccountId: mainId }, {merge:true});

      const isSub = isSubName(n.name);
      if(isSub && mainId && mainId !== n.id){
        const subComm    = n.commission || 0;
        const bonusShare = +(subComm * 0.80).toFixed(2);

        if(bonusShare > 0){
          bonusMap[mainId] = (bonusMap[mainId] || 0) + bonusShare;
        }
      }
    });

    const batch = db.batch();
    list.forEach(n=>{
      const uRef = usersCol.doc(n.id);
      const data = {
        name: n.name || "",
        password: n.password || "",
        loginName: n.name || "",
        loginPa
