<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #e6ebff;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    h1 {
      text-align: center;
      margin: 6px 0 2px;
      color: #102a6b;
    }
    h2 {
      margin: 14px 0 6px;
      font-size: 18px;
      color: #102a6b;
    }
    .subtitle {
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    button {
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .btn-primary {
      background: #0066ff;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }
    .btn-danger {
      background: #ffebe6;
      color: #c0392b;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .col {
      flex: 1 1 180px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 6px 6px;
      text-align: left;
    }
    th {
      background: #f0f3ff;
    }
    .card {
      margin-top: 14px;
      padding: 10px;
      border-radius: 12px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #e6fffb;
      color: #006d75;
      margin-left: 4px;
    }
    .status-active {
      background: #d9f7be;
      color: #135200;
    }
    .status-block {
      background: #fff1f0;
      color: #a8071a;
    }
    .wallet-text {
      font-size: 11px;
      color: #333;
      line-height: 1.5;
    }

    /* ====== RJVC Binary Tree View ====== */
    .binary-tree-card {
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      background: #fff7e6;
      border: 1px solid #ffd8a8;
      font-size: 12px;
    }

    .binary-tree {
      margin-top: 8px;
      text-align: center;
    }

    .tree-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 26px;
      margin-bottom: 10px;
    }

    .tree-node {
      min-width: 110px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #111827;
      color: #ffffff;
      font-size: 11px;
      line-height: 1.25;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    .tree-node.main {
      background: #0b3b91;
      font-weight: 600;
    }

    .tree-node.sub {
      background: #111827;
    }

    .tree-line-h {
      height: 2px;
      background: #cbd5ff;
      margin: 0 auto 6px auto;
      width: 120px;
    }

    .tree-line-h-wide {
      width: 180px;
      height: 2px;
      background: #cbd5ff;
      margin: 0 auto 6px auto;
    }

    .tree-line-v {
      width: 2px;
      height: 16px;
      background: #cbd5ff;
      margin: 0 auto;
    }

    .tree-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    @media (max-width: 480px) {
      .tree-row {
        gap: 18px;
      }
      .tree-node {
        min-width: 96px;
        font-size: 10px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>RJVC ADMIN PANEL</h1>

    <!-- नया Customer Create करें -->
    <div class="card">
      <h2>नया Customer Create करें</h2>
      <div class="subtitle">
        यहाँ से admin new customer बनाएगा। हर customer के साथ 1 Main ID + 5 Sub IDs अपने आप बनेंगी।
      </div>
      <div class="row">
        <div class="col">
          <label>Customer Name</label>
          <input id="newName" type="text" placeholder="जैसे: रमेश" />
        </div>
        <div class="col">
          <label>Mobile Number</label>
          <input id="newMobile" type="tel" placeholder="10 digit number" />
        </div>
      </div>
      <button class="btn-primary" onclick="createCustomer()">Create Customer</button>
      <span id="createMsg" style="font-size:11px; margin-left:6px; color:#0b8457;"></span>
    </div>

    <!-- Customer List -->
    <div class="card">
      <h2>Customer List (1 Main + 5 Sub IDs)</h2>
      <div class="subtitle">
        यहाँ से आप Member add कर सकते हैं, Commission / Bonus देख सकते हैं
        और Tree View सिर्फ admin के लिए है (customer को नहीं दिखेगा)।  
        हर member 20 रुपये देता है, जिसका 15% = ₹3 per member binary earning माना गया है।
      </div>
      <div style="max-height: 320px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ID Type</th>
              <th>RJVC ID</th>
              <th>Name</th>
              <th>Mobile</th>
              <th>Members<br>(This ID)</th>
              <th>Pairs<br>(= Members)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- JS से rows आएँगी -->
          </tbody>
        </table>
      </div>
      <div id="walletSummary" class="wallet-text" style="margin-top:6px;"></div>
    </div>

    <!-- Tree View -->
    <div class="binary-tree-card" id="treeCard" style="display:none;">
      <div style="font-weight:600; margin-bottom:4px;">
        Tree View (केवल Admin के लिए)
      </div>
      <div id="treeTitle" style="font-size:11px; color:#555;">
        यहाँ चुनी हुई Main ID का tree दिखेगा।
      </div>

      <div class="binary-tree" id="binaryTreeArea">
        <!-- JS से tree layout -->
      </div>

      <div id="treePairDetail"
           style="margin-top:6px; font-size:11px; text-align:left;">
        <!-- JS से pairs / commission detail -->
      </div>
    </div>

    <!-- Withdrawal Requests -->
    <div class="card" style="margin-top:14px;">
      <h2>Withdrawal Requests (Approve / Reject)</h2>
      <div class="subtitle">
        यह सूची customer side से की गई सभी withdrawal requests दिखाती है।  
        यहाँ से आप केवल status बदलते हैं (wallet पहले ही customer side से adjust हो चुका होता है)।
      </div>
      <div style="max-height:260px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Mobile</th>
              <th>Amount (₹)</th>
              <th>Wallet</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="withdrawTableBody">
            <!-- JS से rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "rjvc_admin_customers";
    const WITHDRAW_KEY = "rjvc_withdrawals";
    const PER_MEMBER_AMOUNT = 3; // 20 रुपये का 15%

    function loadCustomers() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveCustomers(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function formatNumber(n) {
      return Number(n || 0).toLocaleString("en-IN");
    }

    function randomRJVCCode(existing) {
      let code;
      let used = new Set(existing || []);
      do {
        const num = Math.floor(1000 + Math.random() * 9000);
        code = "RJVC" + num;
      } while (used.has(code));
      return code;
    }

    function createCustomer() {
      const name = (document.getElementById("newName").value || "").trim();
      const mobile = (document.getElementById("newMobile").value || "").trim();
      const msg = document.getElementById("createMsg");
      msg.innerText = "";

      if (!name || !mobile || mobile.length < 10) {
        alert("कृपया सही नाम और 10 digit मोबाइल नंबर भरें।");
        return;
      }

      const customers = loadCustomers();
      if (customers.some(c => c.mobile === mobile)) {
        alert("इस मोबाइल नंबर के साथ customer पहले से मौजूद है।");
        return;
      }

      const allCodes = [];
      customers.forEach(c => {
        allCodes.push(c.mainId);
        if (Array.isArray(c.ids)) {
          c.ids.forEach(id => allCodes.push(id.code));
        }
      });

      const baseCode = randomRJVCCode(allCodes);

      const ids = [
        { type: "main", index: 0, code: baseCode, members: 0, pairs: 0 },
        { type: "sub", index: 1, code: baseCode + "-1", members: 0, pairs: 0 },
        { type: "sub", index: 2, code: baseCode + "-2", members: 0, pairs: 0 },
        { type: "sub", index: 3, code: baseCode + "-3", members: 0, pairs: 0 },
        { type: "sub", index: 4, code: baseCode + "-4", members: 0, pairs: 0 },
        { type: "sub", index: 5, code: baseCode + "-5", members: 0, pairs: 0 }
      ];

      const customer = {
        id: Date.now(),
        name,
        mobile,
        mainId: baseCode,
        status: "active",
        walletCommission: 0,
        walletBonus: 0,
        ids,
        createdAt: new Date().toISOString()
      };

      customers.push(customer);
      saveCustomers(customers);
      renderCustomers();

      document.getElementById("newName").value = "";
      document.getElementById("newMobile").value = "";
      msg.innerText = "Customer सफलतापूर्वक बनाया गया ✓  RJVC ID: " + baseCode;
    }

    function recalcPairsAndWallets(customer) {
      customer.walletCommission = 0;
      customer.walletBonus = 0;

      if (!customer.ids) return;

      customer.ids.forEach(id => {
        const members = Number(id.members || 0);
        const pairs = members; // यहाँ 1 member = 1 pair माना गया है
        id.pairs = pairs;

        const earning = pairs * PER_MEMBER_AMOUNT;

        if (id.type === "main") {
          customer.walletCommission += earning;
        } else if (id.type === "sub") {
          customer.walletBonus += earning;
        }
      });
    }

    function addMembers(customerId, kind, index) {
      const customers = loadCustomers();
      const ci = customers.findIndex(c => c.id === customerId);
      if (ci === -1) return;

      const howManyStr = prompt("कितने नये member add करने हैं? (Number)");
      if (howManyStr === null) return;
      const howMany = parseInt(howManyStr, 10);
      if (!howMany || howMany <= 0) {
        alert("कृपया valid संख्या डालें।");
        return;
      }

      const cust = customers[ci];
      if (!cust.ids) return;

      let target;
      if (kind === "main") {
        target = cust.ids.find(i => i.type === "main");
      } else {
        target = cust.ids.find(i => i.type === "sub" && i.index === index);
      }
      if (!target) return;

      target.members = Number(target.members || 0) + howMany;

      recalcPairsAndWallets(cust);
      customers[ci] = cust;
      saveCustomers(customers);
      renderCustomers();
      if (currentTreeMainId === cust.mainId) {
        showTreeForCustomer(cust.mainId);
      }
    }

    function deleteCustomer(customerId) {
      if (!confirm("क्या आप इस customer को पूरी तरह delete करना चाहते हैं?")) return;

      let customers = loadCustomers();
      const deleted = customers.find(c => c.id === customerId);
      customers = customers.filter(c => c.id !== customerId);
      saveCustomers(customers);
      renderCustomers();

      if (deleted && deleted.mainId === currentTreeMainId) {
        document.getElementById("treeCard").style.display = "none";
        currentTreeMainId = null;
      }
    }

    function toggleStatus(customerId) {
      const customers = loadCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;
      const c = customers[idx];
      c.status = c.status === "active" ? "blocked" : "active";
      customers[idx] = c;
      saveCustomers(customers);
      renderCustomers();
    }

    function renderCustomers() {
      const tbody = document.getElementById("customerTableBody");
      const walletSummary = document.getElementById("walletSummary");
      const customers = loadCustomers();
      tbody.innerHTML = "";
      let totalCommission = 0;
      let totalBonus = 0;

      customers.forEach(cust => {
        recalcPairsAndWallets(cust); // safety
        totalCommission += cust.walletCommission || 0;
        totalBonus += cust.walletBonus || 0;

        // पहले main row
        const mainId = cust.ids.find(i => i.type === "main");
        const mainTr = document.createElement("tr");
        mainTr.innerHTML = `
          <td>
            Main ID
            <span class="tag ${cust.status === "active" ? "status-active" : "status-block"}">
              ${cust.status === "active" ? "Active" : "Blocked"}
            </span>
          </td>
          <td>${mainId ? mainId.code : cust.mainId}</td>
          <td>${cust.name}</td>
          <td>${cust.mobile}</td>
          <td>${mainId ? mainId.members || 0 : 0}</td>
          <td>${mainId ? mainId.pairs || 0 : 0}</td>
          <td>
            <button class="btn-small btn-secondary"
              onclick="addMembers(${cust.id}, 'main', 0)">+ Members (Main)</button><br/>
            <button class="btn-small btn-secondary"
              onclick="showTreeForCustomer('${cust.mainId}')">Tree View</button><br/>
            <button class="btn-small btn-secondary"
              onclick="toggleStatus(${cust.id})">
              ${cust.status === "active" ? "Block" : "Unblock"}
            </button><br/>
            <button class="btn-small btn-danger"
              onclick="deleteCustomer(${cust.id})">Delete Customer</button>
          </td>
        `;
        tbody.appendChild(mainTr);

        // फिर 5 sub IDs
        const subIds = cust.ids.filter(i => i.type === "sub")
                               .sort((a,b)=>a.index-b.index);

        subIds.forEach(sub => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>Sub ID ${sub.index}</td>
            <td>${sub.code}</td>
            <td>${cust.name}</td>
            <td>${cust.mobile}</td>
            <td>${sub.members || 0}</td>
            <td>${sub.pairs || 0}</td>
            <td>
              <button class="btn-small btn-secondary"
                onclick="addMembers(${cust.id}, 'sub', ${sub.index})">
                + Members (Sub ${sub.index})
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

      walletSummary.innerHTML =
        "कुल Commission Wallet (सभी customers): ₹" + formatNumber(totalCommission) +
        "<br>कुल Bonus Wallet (सभी customers): ₹" + formatNumber(totalBonus);
    }

    // ===== Tree View =====
    let currentTreeMainId = null;

    function normalizeIds(cust) {
      const res = {
        main:  { code: cust.mainId || "" },
        sub1:  { code: "" },
        sub2:  { code: "" },
        sub3:  { code: "" },
        sub4:  { code: "" },
        sub5:  { code: "" },
        // members & pairs भी store करेंगे
        sub1m: 0, sub2m: 0, sub3m: 0, sub4m: 0, sub5m: 0,
        sub1p: 0, sub2p: 0, sub3p: 0, sub4p: 0, sub5p: 0,
        mainm: 0, mainp: 0
      };

      if (cust.ids && Array.isArray(cust.ids)) {
        cust.ids.forEach(id => {
          if (id.type === "main") {
            res.main.code = id.code;
            res.mainm = id.members || 0;
            res.mainp = id.pairs || 0;
          } else if (id.type === "sub") {
            if (id.index === 1) {
              res.sub1.code = id.code;
              res.sub1m = id.members || 0;
              res.sub1p = id.pairs || 0;
            }
            if (id.index === 2) {
              res.sub2.code = id.code;
              res.sub2m = id.members || 0;
              res.sub2p = id.pairs || 0;
            }
            if (id.index === 3) {
              res.sub3.code = id.code;
              res.sub3m = id.members || 0;
              res.sub3p = id.pairs || 0;
            }
            if (id.index === 4) {
              res.sub4.code = id.code;
              res.sub4m = id.members || 0;
              res.sub4p = id.pairs || 0;
            }
            if (id.index === 5) {
              res.sub5.code = id.code;
              res.sub5m = id.members || 0;
              res.sub5p = id.pairs || 0;
            }
          }
        });
      }

      if (!res.main.code && cust.mainId) res.main.code = cust.mainId;
      if (!res.sub1.code && cust.mainId) res.sub1.code = cust.mainId + "-1";
      if (!res.sub2.code && cust.mainId) res.sub2.code = cust.mainId + "-2";
      if (!res.sub3.code && cust.mainId) res.sub3.code = cust.mainId + "-3";
      if (!res.sub4.code && cust.mainId) res.sub4.code = cust.mainId + "-4";
      if (!res.sub5.code && cust.mainId) res.sub5.code = cust.mainId + "-5";

      return res;
    }

    function showTreeForCustomer(mainIdCode) {
      const customers = loadCustomers();
      const cust = customers.find(c => c.mainId === mainIdCode);
      if (!cust) {
        alert("इस Main ID के लिए कोई डाटा नहीं मिला।");
        return;
      }
      recalcPairsAndWallets(cust);
      currentTreeMainId = mainIdCode;

      const ids = normalizeIds(cust);

      const treeCard = document.getElementById("treeCard");
      const title = document.getElementById("treeTitle");
      treeCard.style.display = "block";
      title.innerText =
        cust.name + " (" + cust.mobile + ") की IDs का Tree – 1 Main + 5 Sub IDs.";

      const area = document.getElementById("binaryTreeArea");
      area.innerHTML = `
        <!-- Main -->
        <div class="tree-row">
          <div class="tree-node main">
            Main ID<br>${ids.main.code}
          </div>
        </div>

        <!-- line main -> (sub1, sub2) -->
        <div class="tree-line-v"></div>
        <div class="tree-line-h-wide"></div>

        <!-- Sub 1 & Sub 2 -->
        <div class="tree-row">
          <div class="tree-node sub">
            Sub ID 1<br>${ids.sub1.code}
          </div>
          <div class="tree-node sub">
            Sub ID 2<br>${ids.sub2.code}
          </div>
        </div>

        <!-- Sub 1 के नीचे Sub 3 ; Sub 2 के नीचे Sub 4 & Sub 5 -->
        <div class="tree-row">
          <div class="tree-col">
            <div class="tree-line-v"></div>
            <div class="tree-line-h"></div>
            <div class="tree-node sub">
              Sub ID 3<br>${ids.sub3.code}
            </div>
          </div>

          <div class="tree-col">
            <div class="tree-line-v"></div>
            <div class="tree-line-h-wide"></div>
            <div class="tree-row">
              <div class="tree-node sub">
                Sub ID 4<br>${ids.sub4.code}
              </div>
              <div class="tree-node sub">
                Sub ID 5<br>${ids.sub5.code}
              </div>
            </div>
          </div>
        </div>
      `;

      const detail = document.getElementById("treePairDetail");
      detail.innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">Binary Pair Detail:</div>
        <div>Main ID Members: ${ids.mainm || 0}
          → Pairs: ${ids.mainp || ids.mainm || 0}
          → Commission Wallet में: ₹${formatNumber((cust.walletCommission || 0))}</div>
        <div>Sub ID 1 Members: ${ids.sub1m || 0}
          → Pairs: ${ids.sub1p || ids.sub1m || 0}</div>
        <div>Sub ID 2 Members: ${ids.sub2m || 0}
          → Pairs: ${ids.sub2p || ids.sub2m || 0}</div>
        <div>Sub ID 3 Members: ${ids.sub3m || 0}
          → Pairs: ${ids.sub3p || ids.sub3m || 0}</div>
        <div>Sub ID 4 Members: ${ids.sub4m || 0}
          → Pairs: ${ids.sub4p || ids.sub4m || 0}</div>
        <div>Sub ID 5 Members: ${ids.sub5m || 0}
          → Pairs: ${ids.sub5p || ids.sub5m || 0}</div>
        <div style="margin-top:4px;">
          इन सभी Sub IDs के pairs से बनने वाला सारा amount
          सिर्फ Main ID के Bonus Wallet में जुड़ता है
          (Commission Wallet पर नहीं आता)।<br>
          Main ID के खुद के members से बनने वाला amount Commission Wallet में जाता है।
        </div>
        <div style="margin-top:4px;">
          Current Bonus Wallet (Main ID): ₹${formatNumber(cust.walletBonus || 0)}
        </div>
      `;
    }

    // ===== Withdrawal Requests =====
    function loadWithdrawals() {
      try {
        return JSON.parse(localStorage.getItem(WITHDRAW_KEY) || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveWithdrawals(list) {
      localStorage.setItem(WITHDRAW_KEY, JSON.stringify(list));
    }

    function setWithdrawStatus(id, status) {
      const list = loadWithdrawals();
      const idx = list.findIndex(w => String(w.id) === String(id));
      if (idx === -1) return;
      list[idx].status = status;
      saveWithdrawals(list);
      renderWithdrawals();
    }

    function renderWithdrawals() {
      const tbody = document.getElementById("withdrawTableBody");
      const list = loadWithdrawals();
      tbody.innerHTML = "";

      list.sort((a,b)=> (b.createdAt || "").localeCompare(a.createdAt || ""));

      list.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.name || ""}</td>
          <td>${w.mobile || ""}</td>
          <td>₹${formatNumber(w.amount || 0)}</td>
          <td>${w.source === "bonus" ? "Bonus Wallet" : "Commission Wallet"}</td>
          <td>${w.status || "Pending"}</td>
          <td>
            <button class="btn-small btn-secondary"
              onclick="setWithdrawStatus(${w.id}, 'Paid')">Approve</button>
            <button class="btn-small btn-danger"
              onclick="setWithdrawStatus(${w.id}, 'Rejected')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== On Load =====
    window.addEventListener("load", function () {
      renderCustomers();
      renderWithdrawals();
    });
  </script>
</body>
</html>
