<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background:#eef3ff; }

    .center-wrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:24px;
      max-width:420px;
      width:100%;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
    }
    h1,h2,h3,h4{margin:0 0 12px;}
    label{display:block;font-size:14px;margin-bottom:4px;}
    input,button,select{
      font-size:16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #cfd5ff;
      width:100%;
    }
    input:focus{outline:none;border-color:#3366ff;box-shadow:0 0 0 2px rgba(51,102,255,0.15);}
    button{
      border:none;
      background:#0052ff;
      color:#fff;
      font-weight:600;
      cursor:pointer;
    }
    button.secondary{
      background:#f1f4ff;
      color:#1f2933;
      border:1px solid #cfd5ff;
    }
    button.danger{
      background:#ff4b4b;
    }
    button.small{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      width:auto;
    }
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .mb-2{margin-bottom:8px;}
    .flex{display:flex;}
    .flex-between{display:flex;justify-content:space-between;align-items:center;}
    .flex-wrap{display:flex;flex-wrap:wrap;}
    .gap-2{gap:8px;}
    .gap-3{gap:12px;}
    .badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:#dcfce7;
      color:#166534;
      font-weight:600;
    }
    .text-center{text-align:center;}
    .text-right{text-align:right;}
    .text-sm{font-size:13px;}
    .error{color:#dc2626;font-size:14px;margin-top:8px;}
    .success{color:#15803d;font-size:14px;margin-top:8px;}

    /* Admin layout */
    #adminSection{
      display:none;
      min-height:100vh;
    }
    .admin-shell{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .topbar-title{
      font-size:20px;
      font-weight:700;
    }
    .wallet-strip{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .wallet-box{
      flex:1 1 180px;
      background:#0f172a;
      color:#e5e7eb;
      padding:16px 18px;
      border-radius:18px;
      box-shadow:0 10px 25px rgba(15,23,42,0.5);
    }
    .wallet-label{font-size:13px;opacity:0.85;}
    .wallet-amount{font-size:26px;font-weight:700;margin-top:4px;}
    .wallet-sub{font-size:12px;opacity:0.8;margin-top:4px;}

    .grid-2{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap:16px;
    }
    @media(max-width:900px){
      .grid-2{grid-template-columns:1fr;}
      .wallet-box{flex:1 1 100%;}
    }
    .panel{
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 25px rgba(15,23,42,0.08);
    }
    .panel-header{
      font-size:16px;
      font-weight:600;
      margin-bottom:8px;
    }
    .table-wrapper{
      overflow-x:auto;
      margin-top:8px;
    }
    table{
      border-collapse:collapse;
      width:100%;
      font-size:13px;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th{background:#f3f4ff;font-weight:600;}
    tr:last-child td{border-bottom:none;}

    /* Tree section */
    #treeSection{
      display:none;
      margin-top:16px;
    }
    .tree-card{
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 25px rgba(15,23,42,0.08);
      margin-top:12px;
    }
    .tree-main-node{
      background:#1d4ed8;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:15px;
      text-align:center;
      font-weight:600;
      margin:0 auto 12px;
      min-width:220px;
    }
    .tree-sub-node{
      background:#0f172a;
      color:#e5e7eb;
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      text-align:center;
      margin:6px auto;
      min-width:200px;
    }
    .tree-line{
      width:2px;
      height:16px;
      background:#cbd5f5;
      margin:0 auto;
    }
    .tree-row{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .node-actions{
      margin-top:4px;
      display:flex;
      justify-content:center;
      gap:4px;
      flex-wrap:wrap;
    }
    .node-meta{
      font-size:11px;
      margin-top:4px;
      text-align:center;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#e0f2fe;
      color:#0f172a;
      margin-right:4px;
      margin-top:2px;
    }
  </style>
</head>
<body>

<!-- ========== LOGIN SECTION ========== -->
<div id="loginSection" class="center-wrapper">
  <div class="card">
    <h1 class="text-center">Admin Login</h1>
    <p class="text-sm text-center mb-2">नीचे अपना <b>Admin ID</b> और <b>Password</b> डालें।</p>
    <div class="mt-3">
      <label for="adminId">Admin ID</label>
      <input id="adminId" type="text" autocomplete="username" placeholder="जैसे: admin" />
    </div>
    <div class="mt-3">
      <label for="adminPassword">Password</label>
      <input id="adminPassword" type="password" autocomplete="current-password" placeholder="जैसे: 1234" />
    </div>
    <button class="mt-4" onclick="handleAdminLogin()">Login</button>
    <div id="loginError" class="error" style="display:none;">गलत ID या Password!</div>

    <p class="text-sm mt-4" style="opacity:.8;">
      <b>Demo ID:</b> admin<br/>
      <b>Demo Password:</b> 1234
    </p>
  </div>
</div>

<!-- ========== ADMIN SECTION ========== -->
<div id="adminSection">
  <div class="admin-shell">
    <div class="topbar">
      <div class="topbar-title">RJVC ADMIN PANEL</div>
      <button class="secondary small" onclick="logoutAdmin()">Logout</button>
    </div>

    <!-- Big Wallet Strip -->
    <div class="wallet-strip">
      <div class="wallet-box">
        <div class="wallet-label">कुल Commission Wallet (सभी customers)</div>
        <div class="wallet-amount" id="totalCommissionWallet">₹0</div>
        <div class="wallet-sub">Binary earning – केवल Main IDs के wallets</div>
      </div>
      <div class="wallet-box">
        <div class="wallet-label">कुल Bonus Wallet (सभी customers)</div>
        <div class="wallet-amount" id="totalBonusWallet">₹0</div>
        <div class="wallet-sub">Sub IDs की सारी commission, Main IDs के bonus के रूप में</div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Create Customer -->
      <div class="panel">
        <div class="panel-header">नया Customer Create करें</div>
        <p class="text-sm" style="opacity:.8;">
          यहाँ से नया customer जोड़ें। System अपने आप 1 Main ID + 5 Sub IDs बनाएगा।
        </p>
        <div class="mt-2">
          <label for="custName">Customer Name</label>
          <input id="custName" type="text" placeholder="जैसे: राजेश" />
        </div>
        <div class="mt-2">
          <label for="custMobile">Mobile Number</label>
          <input id="custMobile" type="tel" maxlength="10" placeholder="10 digit mobile" />
        </div>
        <div class="mt-2">
          <label for="custPassword">Customer Password</label>
          <input id="custPassword" type="text" placeholder="Login password (जैसे: 1234)" />
        </div>
        <button class="mt-3" onclick="createCustomer()">Create Customer</button>
        <div id="createMsg" class="success" style="display:none;"></div>
      </div>

      <!-- Customer list -->
      <div class="panel">
        <div class="panel-header">Customer List (1 Main + 5 Sub IDs)</div>
        <p class="text-sm" style="opacity:.8;">
          यहाँ से आप customers देख सकते हैं, tree खोल सकते हैं, या delete कर सकते हैं।
        </p>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>RJVC ID (Main)</th>
                <th>Name</th>
                <th>Mobile</th>
                <th>Total Members<br/>(पूरी Tree)</th>
                <th>Commission<br/>Wallet (₹)</th>
                <th>Bonus<br/>Wallet (₹)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customerTableBody">
              <!-- rows via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BIG TREE SECTION -->
    <div id="treeSection">
      <div class="flex-between mt-4">
        <h2 style="font-size:18px;">Tree View (केवल Admin के लिए)</h2>
        <button class="secondary small" onclick="closeTree()">Close Tree</button>
      </div>
      <p class="text-sm" style="opacity:.8;">
        किसी भी node पर <b>+ Member</b> या <b>- Member</b> दबाकर members बदलें। Auto pair = members/2,
        प्रति pair ₹3 earning. Sub IDs की सारी earning ऊपर Main ID के Bonus Wallet में जुड़ती है।
      </p>

      <div class="tree-card" id="treeCard" style="display:none;">
        <div class="flex-between mb-2">
          <div>
            <div id="treeCustomerName" style="font-weight:600;"></div>
            <div class="text-sm" id="treeCustomerMobile" style="opacity:.8;"></div>
          </div>
          <div class="text-right text-sm">
            <div>Commission Wallet: <b id="treeCommWallet">₹0</b></div>
            <div>Bonus Wallet: <b id="treeBonusWallet">₹0</b></div>
          </div>
        </div>

        <!-- Edit customer basic info -->
        <div class="flex gap-2 mt-2 flex-wrap">
          <input id="editName" class="flex-1" placeholder="Change name" />
          <input id="editMobile" class="flex-1" placeholder="Change mobile" />
          <input id="editPassword" class="flex-1" placeholder="Change password" />
          <button class="small" onclick="saveCustomerEdit()">Save</button>
          <button class="danger small" onclick="deleteCurrentCustomer()">Delete Customer</button>
        </div>

        <!-- Actual Tree -->
        <div class="mt-4" id="treeNodesContainer">
          <!-- nodes via JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /************** STORAGE & MODEL **************/
  const STORAGE_KEY = "rjvc_customers_v2";
  let customers = [];
  let currentTreeId = null; // main RJVC id which is currently open in tree

  function loadCustomers() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      customers = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(customers)) customers = [];
    } catch (e) {
      customers = [];
    }
  }

  function saveCustomers() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(customers));
  }

  function generateNewMainId() {
    // simple incremental RJVC id
    const base = 1000 + customers.length;
    return "RJVC" + base;
  }

  function findCustomer(mainId) {
    return customers.find(c => c.mainId === mainId) || null;
  }

  /************** ADMIN LOGIN **************/
  function handleAdminLogin() {
    const id = document.getElementById("adminId").value.trim();
    const pass = document.getElementById("adminPassword").value.trim();
    const errEl = document.getElementById("loginError");

    if (id === "admin" && pass === "1234") {
      localStorage.setItem("rjvc_admin_logged_in", "1");
      errEl.style.display = "none";
      showAdminSection();
    } else {
      errEl.style.display = "block";
    }
  }

  function checkAdminLoginOnLoad() {
    const isLogged = localStorage.getItem("rjvc_admin_logged_in") === "1";
    if (isLogged) {
      showAdminSection(false);
    }
  }

  function showAdminSection(scrollTop = true) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("adminSection").style.display = "block";
    if (scrollTop) window.scrollTo(0, 0);
    loadCustomers();
    refreshCustomerTable();
    refreshWalletStrip();
  }

  function logoutAdmin() {
    localStorage.removeItem("rjvc_admin_logged_in");
    currentTreeId = null;
    document.getElementById("adminSection").style.display = "none";
    document.getElementById("loginSection").style.display = "flex";
  }

  /************** CREATE CUSTOMER **************/
  function createCustomer() {
    const name = document.getElementById("custName").value.trim();
    const mobile = document.getElementById("custMobile").value.trim();
    const password = document.getElementById("custPassword").value.trim();
    const msgEl = document.getElementById("createMsg");

    if (!name || !mobile || mobile.length !== 10 || !password) {
      msgEl.style.display = "block";
      msgEl.className = "error";
      msgEl.textContent = "कृपया नाम, 10 digit mobile और password सही से भरें।";
      return;
    }

    const mainId = generateNewMainId();
    const subIds = [
      mainId + "-1",
      mainId + "-2",
      mainId + "-3",
      mainId + "-4",
      mainId + "-5",
    ];

    const newCustomer = {
      mainId,
      name,
      mobile,
      password,
      active: true,
      subIds,
      members: {
        main: 0,
        sub1: 0,
        sub2: 0,
        sub3: 0,
        sub4: 0,
        sub5: 0,
      },
      commissionWallet: 0, // केवल main
      bonusWallet: 0       // केवल main (sub ids से आने वाला)
    };

    customers.push(newCustomer);
    saveCustomers();
    refreshCustomerTable();
    refreshWalletStrip();

    msgEl.style.display = "block";
    msgEl.className = "success";
    msgEl.textContent = "Customer सफलतापूर्वक बनाया गया ✔ RJVC ID: " + mainId;

    // clear form
    document.getElementById("custName").value = "";
    document.getElementById("custMobile").value = "";
    document.getElementById("custPassword").value = "";
  }

  /************** COMMISSION / BONUS CALC **************/
  const EARNING_PER_PAIR = 3; // ₹3 per pair
  const MEMBERS_PER_PAIR = 2;

  function calculateEarningsForCustomer(cust) {
    const m = cust.members || {};
    const mainPairs = Math.floor((m.main || 0) / MEMBERS_PER_PAIR);
    const sub1Pairs = Math.floor((m.sub1 || 0) / MEMBERS_PER_PAIR);
    const sub2Pairs = Math.floor((m.sub2 || 0) / MEMBERS_PER_PAIR);
    const sub3Pairs = Math.floor((m.sub3 || 0) / MEMBERS_PER_PAIR);
    const sub4Pairs = Math.floor((m.sub4 || 0) / MEMBERS_PER_PAIR);
    const sub5Pairs = Math.floor((m.sub5 || 0) / MEMBERS_PER_PAIR);

    const mainEarn = mainPairs * EARNING_PER_PAIR;
    const sub1Earn = sub1Pairs * EARNING_PER_PAIR;
    const sub2Earn = sub2Pairs * EARNING_PER_PAIR;
    const sub3Earn = sub3Pairs * EARNING_PER_PAIR;
    const sub4Earn = sub4Pairs * EARNING_PER_PAIR;
    const sub5Earn = sub5Pairs * EARNING_PER_PAIR;

    const bonusEarn = sub1Earn + sub2Earn + sub3Earn + sub4Earn + sub5Earn;

    cust.commissionWallet = mainEarn;
    cust.bonusWallet = bonusEarn;

    const totalMembers =
      (m.main || 0) +
      (m.sub1 || 0) +
      (m.sub2 || 0) +
      (m.sub3 || 0) +
      (m.sub4 || 0) +
      (m.sub5 || 0);

    return {
      mainPairs,
      sub1Pairs,
      sub2Pairs,
      sub3Pairs,
      sub4Pairs,
      sub5Pairs,
      mainEarn,
      sub1Earn,
      sub2Earn,
      sub3Earn,
      sub4Earn,
      sub5Earn,
      totalMembers,
    };
  }

  function refreshWalletStrip() {
    let totalComm = 0;
    let totalBonus = 0;
    customers.forEach(c => {
      calculateEarningsForCustomer(c);
      totalComm += c.commissionWallet || 0;
      totalBonus += c.bonusWallet || 0;
    });
    saveCustomers();
    document.getElementById("totalCommissionWallet").textContent = "₹" + totalComm;
    document.getElementById("totalBonusWallet").textContent = "₹" + totalBonus;
  }

  /************** CUSTOMER TABLE **************/
  function refreshCustomerTable() {
    const tbody = document.getElementById("customerTableBody");
    tbody.innerHTML = "";

    if (!customers.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 7;
      td.textContent = "अभी कोई customer नहीं है। ऊपर से नया customer create करें।";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    customers.forEach(cust => {
      const stats = calculateEarningsForCustomer(cust);

      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.textContent = cust.mainId;
      if (cust.active) {
        const b = document.createElement("div");
        b.className = "badge";
        b.textContent = "Active";
        tdId.appendChild(document.createElement("br"));
        tdId.appendChild(b);
      }
      tr.appendChild(tdId);

      const tdName = document.createElement("td");
      tdName.textContent = cust.name;
      tr.appendChild(tdName);

      const tdMob = document.createElement("td");
      tdMob.textContent = cust.mobile;
      tr.appendChild(tdMob);

      const tdMembers = document.createElement("td");
      tdMembers.textContent = stats.totalMembers;
      tr.appendChild(tdMembers);

      const tdComm = document.createElement("td");
      tdComm.textContent = "₹" + (cust.commissionWallet || 0);
      tr.appendChild(tdComm);

      const tdBonus = document.createElement("td");
      tdBonus.textContent = "₹" + (cust.bonusWallet || 0);
      tr.appendChild(tdBonus);

      const tdActions = document.createElement("td");
      const btnTree = document.createElement("button");
      btnTree.className = "small";
      btnTree.textContent = "Tree View";
      btnTree.onclick = () => openTree(cust.mainId);
      tdActions.appendChild(btnTree);

      const btnDel = document.createElement("button");
      btnDel.className = "small danger mt-2";
      btnDel.style.display = "block";
      btnDel.textContent = "Delete";
      btnDel.onclick = () => {
        if (confirm("पक्का इस customer को delete करना है?")) {
          customers = customers.filter(x => x.mainId !== cust.mainId);
          saveCustomers();
          if (currentTreeId === cust.mainId) {
            currentTreeId = null;
            closeTree();
          }
          refreshCustomerTable();
          refreshWalletStrip();
        }
      };
      tdActions.appendChild(btnDel);

      tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });

    refreshWalletStrip();
  }

  /************** TREE VIEW **************/
  function openTree(mainId) {
    const cust = findCustomer(mainId);
    if (!cust) return;

    currentTreeId = mainId;
    calculateEarningsForCustomer(cust);
    saveCustomers();
    refreshWalletStrip();

    document.getElementById("treeSection").style.display = "block";
    document.getElementById("treeCard").style.display = "block";

    document.getElementById("treeCustomerName").textContent =
      cust.name + " (" + cust.mainId + ")";
    document.getElementById("treeCustomerMobile").textContent =
      "Mobile: " + cust.mobile + " | Password: " + cust.password;
    document.getElementById("treeCommWallet").textContent =
      "₹" + (cust.commissionWallet || 0);
    document.getElementById("treeBonusWallet").textContent =
      "₹" + (cust.bonusWallet || 0);

    document.getElementById("editName").value = cust.name;
    document.getElementById("editMobile").value = cust.mobile;
    document.getElementById("editPassword").value = cust.password;

    renderTreeNodes(cust);
    window.scrollTo({ top: document.body.scrollHeight / 4, behavior: "smooth" });
  }

  function closeTree() {
    document.getElementById("treeSection").style.display = "none";
    currentTreeId = null;
  }

  function renderTreeNodes(cust) {
    const container = document.getElementById("treeNodesContainer");
    container.innerHTML = "";

    const stats = calculateEarningsForCustomer(cust);

    // MAIN NODE
    const mainDiv = document.createElement("div");
    mainDiv.className = "tree-main-node";
    mainDiv.textContent = "Main ID – " + cust.mainId;

    const mainMeta = document.createElement("div");
    mainMeta.className = "node-meta";
    mainMeta.innerHTML =
      `<span class="pill">Members: ${cust.members.main}</span>` +
      `<span class="pill">Pairs: ${stats.mainPairs}</span>` +
      `<span class="pill">Earning: ₹${stats.mainEarn}</span>`;

    const mainActions = document.createElement("div");
    mainActions.className = "node-actions";
    mainActions.innerHTML = `
      <button class="small" onclick="changeMembers('${cust.mainId}','main',1)">+ Member</button>
      <button class="small secondary" onclick="changeMembers('${cust.mainId}','main',-1)">- Member</button>
    `;

    container.appendChild(mainDiv);
    container.appendChild(mainMeta);
    container.appendChild(mainActions);
    container.appendChild(createLine());

    // SUB IDS ROWS (2 + 3 जैसा look बनाने के लिए)
    const row1 = document.createElement("div");
    row1.className = "tree-row";
    const row2 = document.createElement("div");
    row2.className = "tree-row";

    const subConfigs = [
      { key: "sub1", label: "Sub ID 1", id: cust.subIds[0], pairs: stats.sub1Pairs, earn: stats.sub1Earn, members: cust.members.sub1 },
      { key: "sub2", label: "Sub ID 2", id: cust.subIds[1], pairs: stats.sub2Pairs, earn: stats.sub2Earn, members: cust.members.sub2 },
      { key: "sub3", label: "Sub ID 3", id: cust.subIds[2], pairs: stats.sub3Pairs, earn: stats.sub3Earn, members: cust.members.sub3 },
      { key: "sub4", label: "Sub ID 4", id: cust.subIds[3], pairs: stats.sub4Pairs, earn: stats.sub4Earn, members: cust.members.sub4 },
      { key: "sub5", label: "Sub ID 5", id: cust.subIds[4], pairs: stats.sub5Pairs, earn: stats.sub5Earn, members: cust.members.sub5 },
    ];

    subConfigs.forEach((cfg, idx) => {
      const node = document.createElement("div");
      node.style.minWidth = "210px";

      const box = document.createElement("div");
      box.className = "tree-sub-node";
      box.textContent = cfg.label + " – " + cfg.id;
      node.appendChild(box);

      const meta = document.createElement("div");
      meta.className = "node-meta";
      meta.innerHTML =
        `<span class="pill">Members: ${cfg.members}</span>` +
        `<span class="pill">Pairs: ${cfg.pairs}</span>` +
        `<span class="pill">Earn: ₹${cfg.earn}</span>`;
      node.appendChild(meta);

      const acts = document.createElement("div");
      acts.className = "node-actions";
      acts.innerHTML = `
        <button class="small" onclick="changeMembers('${cust.mainId}','${cfg.key}',1)">+ Member</button>
        <button class="small secondary" onclick="changeMembers('${cust.mainId}','${cfg.key}',-1)">- Member</button>
      `;
      node.appendChild(acts);

      if (idx < 2) row1.appendChild(node);
      else row2.appendChild(node);
    });

    container.appendChild(row1);
    container.appendChild(createLine());
    container.appendChild(row2);
  }

  function createLine() {
    const d = document.createElement("div");
    d.className = "tree-line";
    return d;
  }

  function changeMembers(mainId, key, delta) {
    const cust = findCustomer(mainId);
    if (!cust) return;
    if (!cust.members) cust.members = { main:0, sub1:0, sub2:0, sub3:0, sub4:0, sub5:0 };

    const current = cust.members[key] || 0;
    let next = current + delta;
    if (next < 0) next = 0;
    cust.members[key] = next;

    calculateEarningsForCustomer(cust);
    saveCustomers();
    refreshCustomerTable();
    refreshWalletStrip();
    if (currentTreeId === mainId) openTree(mainId); // re-render tree
  }

  /************** EDIT & DELETE IN TREE **************/
  function saveCustomerEdit() {
    if (!currentTreeId) return;
    const cust = findCustomer(currentTreeId);
    if (!cust) return;

    cust.name = document.getElementById("editName").value.trim() || cust.name;
    cust.mobile = document.getElementById("editMobile").value.trim() || cust.mobile;
    cust.password = document.getElementById("editPassword").value.trim() || cust.password;

    saveCustomers();
    refreshCustomerTable();
    openTree(currentTreeId);
    alert("Customer details अपडेट हो गए।");
  }

  function deleteCurrentCustomer() {
    if (!currentTreeId) return;
    if (!confirm("पक्का इस customer को पूरा delete करना है?")) return;

    customers = customers.filter(c => c.mainId !== currentTreeId);
    saveCustomers();
    currentTreeId = null;
    refreshCustomerTable();
    refreshWalletStrip();
    closeTree();
  }

  /************** ON LOAD **************/
  loadCustomers();
  checkAdminLoginOnLoad();
</script>
</body>
</html>
