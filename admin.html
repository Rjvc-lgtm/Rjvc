<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      padding: 12px;
      background: #e6ebff;
    }
    .app {
      max-width: 980px;
      margin: 0 auto 24px;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      text-align: center;
      color: #102a6b;
    }
    h2 {
      margin: 10px 0 6px;
      font-size: 18px;
      color: #102a6b;
    }
    p.subtitle {
      margin: 0 0 10px;
      font-size: 12px;
      color: #555;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      margin: 2px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #0066ff;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }
    .btn-danger {
      background: #ffccc7;
      color: #a8071a;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 4px;
    }
    .badge-pill {
      background: #f0f5ff;
      color: #102a6b;
    }
    .card {
      margin-top: 12px;
      padding: 10px 10px 12px;
      border-radius: 12px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 8px;
    }
    .col {
      flex: 1 1 160px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11px;
    }
    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 5px 4px;
      text-align: left;
    }
    th {
      background: #f4f6ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .small {
      font-size: 11px;
      color: #777;
    }
    .money {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .table-wrapper {
      max-height: 340px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e4e7ff;
      background: #fff;
    }
    .tree-card {
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      background: #fffef6;
      border: 1px solid #ffe58f;
      font-size: 12px;
    }
    .tree-main {
      text-align: center;
      margin-bottom: 8px;
    }
    .tree-main span {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: #1a237e;
      color: #fff;
      font-size: 12px;
    }
    .tree-subs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-top: 6px;
    }
    .tree-node {
      padding: 5px 8px;
      border-radius: 999px;
      background: #f0f0ff;
      font-size: 11px;
      text-align: center;
    }
    .tree-node strong {
      display: block;
    }
    .status-pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #f6ffed;
      color: #237804;
    }
    .status-pending {
      background: #fffbe6;
      color: #ad8b00;
    }
    .status-rejected {
      background: #fff1f0;
      color: #a8071a;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>RJVC ADMIN PANEL</h1>

    <!-- Create Customer -->
    <div class="card">
      <h2>नया Customer Create करें</h2>
      <p class="subtitle">
        हर नए customer के लिए system खुद-ब-खुद 1 Main ID और 5 Sub IDs बनाएगा।
        Binary joining आप मैनुअली करेंगे।
      </p>

      <div class="row">
        <div class="col">
          <label>Customer Name</label>
          <input id="custName" type="text" placeholder="जैसे: रमेश" />
        </div>
        <div class="col">
          <label>Mobile Number</label>
          <input id="custMobile" type="tel" placeholder="10 digit number" />
        </div>
      </div>
      <button class="btn-primary" onclick="createCustomer()">Create Customer</button>
      <span id="createMsg" class="small"></span>
      <div class="small" style="margin-top:4px;">
        Note: 1 customer = 1 Main ID + 5 Sub IDs (RJVC code auto generate होगा)।
      </div>
    </div>

    <!-- Customer List -->
    <div class="card">
      <h2>Customer List (1 Main + 5 Sub IDs)</h2>
      <p class="subtitle">
        यहाँ से आप Binary Member मैनुअली add कर सकते हैं, Commission / Bonus wallet देख सकते हैं
        और Tree View केवल admin के लिए देख सकते हैं (customer को नहीं दिखेगा)।  
        <br />
        <strong>Entry:</strong> 1 member = ₹20, <strong>Per Pair:</strong> ₹3 (15%)
      </p>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID Type</th>
              <th>RJVC ID</th>
              <th>Name</th>
              <th>Mobile</th>
              <th>Left</th>
              <th>Right</th>
              <th>Pairs</th>
              <th class="money">Comm. Wallet</th>
              <th class="money">Bonus Wallet</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- JS से rows -->
          </tbody>
        </table>
      </div>
      <div class="small" id="customerSummary"></div>
    </div>

    <!-- Tree View -->
    <div id="treeCard" class="tree-card" style="display:none;">
      <h2>Tree View (केवल Admin के लिए)</h2>
      <div class="small" id="treeInfo"></div>
      <div id="treeContent"></div>
    </div>

    <!-- Withdrawal Requests -->
    <div class="card">
      <h2>Withdrawal Requests (Approve / Reject)</h2>
      <p class="subtitle">
        यह सूची customer side से की गई सभी withdrawal requests दिखाती है।  
        Approve करने पर status बदल जाएगी। Reject करने पर amount वापस wallet में चला जाएगा।
      </p>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Mobile</th>
              <th class="money">Amount (₹)</th>
              <th>Wallet</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="withdrawTableBody">
            <!-- JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ---- CONSTANTS ----
    const ENTRY_AMOUNT = 20; // हर member से
    const PAIR_PERCENT = 0.15; // 15%
    const PAIR_AMOUNT = ENTRY_AMOUNT * PAIR_PERCENT; // 3 रुपये प्रति pair

    // ---- HELPERS ----
    function formatMoney(n) {
      return Number(n || 0).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    function getCustomers() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_customers") || "[]");
      } catch (e) {
        return [];
      }
    }
    function saveCustomers(list) {
      localStorage.setItem("rjvc_customers", JSON.stringify(list));
    }
    function getWithdrawals() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_withdrawals") || "[]");
      } catch (e) {
        return [];
      }
    }
    function saveWithdrawals(list) {
      localStorage.setItem("rjvc_withdrawals", JSON.stringify(list));
    }

    function nextMainIdNumber() {
      const key = "rjvc_last_main_id";
      let last = parseInt(localStorage.getItem(key) || "4600", 10);
      last += 1;
      localStorage.setItem(key, String(last));
      return last;
    }

    function ensureStructure(cust) {
      // wallets
      if (typeof cust.walletBalance !== "number") cust.walletBalance = 0;
      if (typeof cust.bonusBalance !== "number") cust.bonusBalance = 0;

      // main + sub IDs
      if (!cust.rjvcMainId) {
        const num = nextMainIdNumber();
        cust.rjvcMainId = "RJVC" + num;
      }
      if (!cust.subIds || !Array.isArray(cust.subIds) || cust.subIds.length < 5) {
        const base = cust.rjvcMainId;
        cust.subIds = [];
        for (let i = 1; i <= 5; i++) {
          cust.subIds.push(base + "-" + i);
        }
      }

      // binary data
      if (!cust.binary) cust.binary = {};
      const keys = ["main", "sub1", "sub2", "sub3", "sub4", "sub5"];
      keys.forEach((k) => {
        if (!cust.binary[k]) {
          cust.binary[k] = { left: 0, right: 0, pairs: 0 };
        } else {
          cust.binary[k].left = cust.binary[k].left || 0;
          cust.binary[k].right = cust.binary[k].right || 0;
          cust.binary[k].pairs = cust.binary[k].pairs || 0;
        }
      });
      return cust;
    }

    function getJoinedTotal(cust) {
      ensureStructure(cust);
      let total = 0;
      Object.values(cust.binary).forEach((node) => {
        total += (node.left || 0) + (node.right || 0);
      });
      return total;
    }

    // ---- CREATE CUSTOMER ----
    function createCustomer() {
      const name = (document.getElementById("custName").value || "").trim();
      const mobile = (document.getElementById("custMobile").value || "").trim();
      const msg = document.getElementById("createMsg");
      msg.textContent = "";

      if (!name || !mobile || mobile.length < 10) {
        msg.textContent = "Name और सही mobile number भरें।";
        msg.style.color = "#cf1322";
        return;
      }

      const list = getCustomers();
      if (list.some((c) => c.mobile === mobile)) {
        msg.textContent = "इस mobile नंबर के लिए customer पहले से मौजूद है।";
        msg.style.color = "#cf1322";
        return;
      }

      const record = {
        id: Date.now(),
        name,
        mobile,
        walletBalance: 0,
        bonusBalance: 0,
        joinedMembers: 0,
        createdAt: new Date().toISOString()
      };
      ensureStructure(record);
      list.push(record);
      saveCustomers(list);

      document.getElementById("custName").value = "";
      document.getElementById("custMobile").value = "";
      msg.textContent = "Customer सफलतापूर्वक बनाया गया ✔";
      msg.style.color = "#389e0d";

      renderCustomers();
    }

    // ---- BINARY ADD MEMBER ----
    function addBinaryMember(custId, nodeKey, side) {
      const list = getCustomers();
      const idx = list.findIndex((c) => String(c.id) === String(custId));
      if (idx === -1) return;

      const cust = ensureStructure(list[idx]);
      const node = cust.binary[nodeKey];
      if (!node) return;

      if (side === "L") node.left += 1;
      else node.right += 1;

      const oldPairs = node.pairs || 0;
      const newPairs = Math.min(node.left, node.right);
      const addedPairs = newPairs - oldPairs;
      node.pairs = newPairs;

      let income = addedPairs * PAIR_AMOUNT; // 3 रुपये प्रति pair
      if (income > 0) {
        if (nodeKey === "main") {
          cust.walletBalance = (cust.walletBalance || 0) + income;
          alert(
            cust.name +
              " की Main ID पर " +
              addedPairs +
              " नया pair complete हुआ। Commission Wallet में ₹" +
              formatMoney(income) +
              " जोड़े गए।"
          );
        } else {
          cust.bonusBalance = (cust.bonusBalance || 0) + income;
          alert(
            cust.name +
              " की " +
              nodeKey.toUpperCase() +
              " के नीचे " +
              addedPairs +
              " pair complete हुआ। Amount ₹" +
              formatMoney(income) +
              " Main ID के Bonus Wallet में गया।"
          );
        }
      }

      cust.joinedMembers = getJoinedTotal(cust);
      list[idx] = cust;
      saveCustomers(list);
      renderCustomers();
      if (currentTreeCustomerId === custId) {
        renderTree(cust);
      }
    }

    // ---- DELETE CUSTOMER ----
    function deleteCustomer(custId) {
      if (!confirm("क्या आप सच में इस customer को delete करना चाहते हैं?")) return;

      const list = getCustomers();
      const idx = list.findIndex((c) => String(c.id) === String(custId));
      if (idx === -1) return;
      const cust = list[idx];

      const newList = list.filter((c) => String(c.id) !== String(custId));
      saveCustomers(newList);

      // संबंधित withdrawal requests भी हटा दें
      let w = getWithdrawals();
      w = w.filter((r) => r.mobile !== cust.mobile);
      saveWithdrawals(w);

      if (currentTreeCustomerId === custId) {
        currentTreeCustomerId = null;
        document.getElementById("treeCard").style.display = "none";
      }

      renderCustomers();
      renderWithdrawals();
    }

    // ---- TREE VIEW ----
    let currentTreeCustomerId = null;

    function showTreeFor(custId) {
      const list = getCustomers();
      const cust = list.find((c) => String(c.id) === String(custId));
      if (!cust) return;
      currentTreeCustomerId = custId;
      renderTree(ensureStructure(cust));
    }

    function renderTree(cust) {
      const card = document.getElementById("treeCard");
      const info = document.getElementById("treeInfo");
      const content = document.getElementById("treeContent");

      card.style.display = "block";

      const totalJoined = getJoinedTotal(cust);
      info.textContent =
        cust.name +
        " (" +
        cust.mobile +
        ") | Total Joined Members (पूरी tree): " +
        totalJoined +
        " | Commission Wallet: ₹" +
        formatMoney(cust.walletBalance) +
        " | Bonus Wallet: ₹" +
        formatMoney(cust.bonusBalance);

      const b = cust.binary;

      content.innerHTML = `
        <div class="tree-main">
          <span>Main ID: ${cust.rjvcMainId}</span>
        </div>
        <div class="tree-subs">
          ${cust.subIds
            .map((sid, idx) => {
              const key = "sub" + (idx + 1);
              const node = b[key] || { left: 0, right: 0, pairs: 0 };
              return `
              <div class="tree-node">
                <strong>Sub ID ${idx + 1}</strong>
                ${sid}<br/>
                L: ${node.left} | R: ${node.right} | Pairs: ${node.pairs}
              </div>`;
            })
            .join("")}
        </div>
      `;
    }

    // ---- RENDER CUSTOMERS TABLE ----
    function renderCustomers() {
      const tbody = document.getElementById("customerTableBody");
      const summary = document.getElementById("customerSummary");
      const list = getCustomers().map((c) => ensureStructure(c));

      let rows = "";
      let totalComm = 0;
      let totalBonus = 0;

      list.forEach((cust) => {
        const b = cust.binary;
        const joined = getJoinedTotal(cust);
        totalComm += cust.walletBalance || 0;
        totalBonus += cust.bonusBalance || 0;

        // MAIN ROW
        rows += `
          <tr>
            <td><strong>Main ID</strong></td>
            <td>${cust.rjvcMainId}</td>
            <td>${cust.name}</td>
            <td>${cust.mobile}</td>
            <td>${b.main.left}</td>
            <td>${b.main.right}</td>
            <td>${b.main.pairs}</td>
            <td class="money">₹${formatMoney(cust.walletBalance)}</td>
            <td class="money">₹${formatMoney(cust.bonusBalance)}</td>
            <td>
              <button class="btn-secondary" onclick="addBinaryMember('${cust.id}','main','L')">+L(Main)</button>
              <button class="btn-secondary" onclick="addBinaryMember('${cust.id}','main','R')">+R(Main)</button>
              <button class="btn-secondary" onclick="showTreeFor('${cust.id}')">Tree</button>
              <button class="btn-danger" onclick="deleteCustomer('${cust.id}')">Delete</button>
              <div class="small">Total Members: ${joined}</div>
            </td>
          </tr>
        `;

        // SUB ROWS (1..5)
        cust.subIds.forEach((sid, index) => {
          const key = "sub" + (index + 1);
          const node = b[key];
          rows += `
            <tr>
              <td>Sub ID ${index + 1}</td>
              <td>${sid}</td>
              <td>${cust.name}</td>
              <td>${cust.mobile}</td>
              <td>${node.left}</td>
              <td>${node.right}</td>
              <td>${node.pairs}</td>
              <td class="money">-</td>
              <td class="money">-</td>
              <td>
                <button class="btn-secondary" onclick="addBinaryMember('${cust.id}','${key}','L')">+L(Sub ${index + 1})</button>
                <button class="btn-secondary" onclick="addBinaryMember('${cust.id}','${key}','R')">+R(Sub ${index + 1})</button>
              </td>
            </tr>
          `;
        });
      });

      tbody.innerHTML = rows || `<tr><td colspan="10" class="small">अभी कोई customer नहीं है। ऊपर से नया customer create करें।</td></tr>`;

      summary.textContent =
        "Total Customers: " +
        list.length +
        " | कुल Commission Wallet: ₹" +
        formatMoney(totalComm) +
        " | कुल Bonus Wallet: ₹" +
        formatMoney(totalBonus);
    }

    // ---- WITHDRAWALS ----
    function renderWithdrawals() {
      const tbody = document.getElementById("withdrawTableBody");
      const list = getWithdrawals();
      if (!list.length) {
        tbody.innerHTML =
          '<tr><td colspan="6" class="small">अभी कोई withdrawal request नहीं है।</td></tr>';
        return;
      }
      let rows = "";
      list
        .slice()
        .sort((a, b) => b.createdAt.localeCompare(a.createdAt))
        .forEach((w) => {
          let cls = "status-pill";
          if (w.status === "Pending") cls += " status-pending";
          else if (w.status === "Rejected") cls += " status-rejected";

          rows += `
            <tr>
              <td>${w.name || ""}</td>
              <td>${w.mobile || ""}</td>
              <td class="money">₹${formatMoney(w.amount)}</td>
              <td>${w.source === "bonus" ? "Bonus" : "Commission"}</td>
              <td><span class="${cls}">${w.status}</span></td>
              <td>
                ${
                  w.status === "Pending"
                    ? `
                  <button class="btn-primary" onclick="setWithdrawalStatus('${w.id}','Approved')">Approve</button>
                  <button class="btn-danger" onclick="setWithdrawalStatus('${w.id}','Rejected')">Reject</button>
                `
                    : "-"
                }
              </td>
            </tr>
          `;
        });
      tbody.innerHTML = rows;
    }

    function setWithdrawalStatus(id, status) {
      const list = getWithdrawals();
      const idx = list.findIndex((w) => String(w.id) === String(id));
      if (idx === -1) return;
      const w = list[idx];
      if (w.status !== "Pending") return;

      w.status = status;
      w.updatedAt = new Date().toISOString();
      list[idx] = w;
      saveWithdrawals(list);

      if (status === "Rejected") {
        // refund
        const customers = getCustomers();
        const cIdx = customers.findIndex((c) => c.mobile === w.mobile);
        if (cIdx !== -1) {
          const cust = ensureStructure(customers[cIdx]);
          if (w.source === "bonus") {
            cust.bonusBalance = (cust.bonusBalance || 0) + (w.amount || 0);
          } else {
            cust.walletBalance = (cust.walletBalance || 0) + (w.amount || 0);
          }
          customers[cIdx] = cust;
          saveCustomers(customers);
          renderCustomers();
        }
      }

      renderWithdrawals();
    }

    // ---- INIT ----
    window.addEventListener("load", function () {
      // ensure structure for all existing customers
      const list = getCustomers().map((c) => ensureStructure(c));
      saveCustomers(list);
      renderCustomers();
      renderWithdrawals();
    });
  </script>
</body>
</html>
