<!DOCTYPE html>    
<html lang="hi">    
<head>    
  <meta charset="UTF-8" />    
  <title>RJVC Binary Tree Admin</title>    
  <meta name="viewport" content="width=device-width, initial-scale=1" />    
  <style>    
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}    
    body{margin:0;background:#f3f4f6;color:#111827;}    
    h1,h2,h3{margin:0 0 8px;}    
    
    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}    
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.15);padding:22px;max-width:480px;width:100%;}    
    label{display:block;font-size:14px;margin-bottom:4px;}    
    input{width:100%;padding:10px 12px;border-radius:999px;border:1px solid #d1d5db;font-size:15px;outline:none;}    
    input:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.25);}    
    .btn{border:none;border-radius:999px;padding:10px 18px;font-size:15px;font-weight:600;cursor:pointer;}    
    .btn-primary{background:#2563eb;color:#fff;}    
    .btn-secondary{background:#e5e7eb;color:#111827;}    
    .btn-danger{background:#dc2626;color:#fff;}    
    .btn-sm{padding:6px 10px;font-size:12px;}    
    .btn:disabled{opacity:.5;cursor:not-allowed;}    
    .mt-1{margin-top:4px;}    
    .mt-2{margin-top:8px;}    
    .mt-3{margin-top:12px;}    
    .mt-4{margin-top:16px;}    
    .flex{display:flex;}    
    .between{justify-content:space-between;align-items:center;}    
    .center{text-align:center;}    
    table{width:100%;border-collapse:collapse;font-size:13px;}    
    th,td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left;}    
    th{font-size:12px;text-transform:uppercase;color:#6b7280;}    
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;background:#dbeafe;color:#1d4ed8;}    
    .wrap{max-width:1100px;width:100%;margin:24px auto;padding:0 8px;}    
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(15,23,42,.1);padding:18px;margin-bottom:18px;}    
    .wallets{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;}    
    .wallet-box{flex:1 1 180px;background:#eff6ff;border-radius:14px;padding:10px 12px;}    
    .wallet-title{font-size:12px;color:#4b5563;}    
    .wallet-value{font-size:18px;font-weight:700;color:#1d4ed8;}    
    .small{font-size:12px;color:#6b7280;}    
    .error{color:#dc2626;font-size:13px;margin-top:6px;}    
    .ok{color:#166534;font-size:13px;margin-top:6px;}    
    
    .tree-panel{background:#020617;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:8px;}    
    .tree-root-label{font-size:13px;color:#a5b4fc;margin-bottom:4px;}    
    .tree-level{text-align:center;margin:8px 0;}    
    .tree-node-wrap{display:inline-block;margin:6px;}    
    .tree-node{padding:6px 10px;border-radius:12px;background:#111827;border:1px solid #4b5563;font-size:12px;min-width:140px;}    
    .tree-node-main{background:#1d4ed8;border-color:#93c5fd;}    
    .tree-node-name{font-weight:600;}    
    .tree-node-meta{font-size:10px;color:#9ca3af;margin-top:2px;}    
    .tree-node-actions{margin-top:6px;display:flex;gap:4px;justify-content:center;flex-wrap:wrap;}    
    .tree-node-actions .btn-sm{padding:3px 6px;font-size:10px;}    
    
    .profit-panel{background:#0f172a;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:10px;}    
    .profit-boxes{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}    
    .profit-box{flex:1 1 160px;background:#020617;border-radius:14px;padding:10px 12px;border:1px solid #1e293b;}    
    .profit-label{font-size:12px;color:#9ca3af;}    
    .profit-value{font-size:18px;font-weight:700;}    
    
    canvas{max-width:100%;}    
    
    @media(max-width:720px){    
      .panel{padding:14px;}    
      table{font-size:12px;}    
    }    
  </style>    
</head>    
<body>    
    
<!-- LOGIN PAGE -->    
<div id="loginPage" class="page">    
  <div class="card">    
    <h1 class="center">RJVC Admin Login</h1>    
    <p class="center" style="font-size:13px;color:#6b7280;margin-bottom:16px;">    
      ‡§Ø‡§π ‡§™‡•á‡§ú ‡§∏‡§ø‡§∞‡•ç‡§´ admin ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à‡•§    
    </p>    
    <label>Admin ID</label>    
    <input id="adminId" placeholder="‡§ú‡•à‡§∏‡•á: admin" />    
    <div class="mt-2"></div>    
    <label>Password</label>    
    <input id="adminPass" type="password" placeholder="‡§ú‡•à‡§∏‡•á: 1234" />    
    <button class="btn btn-primary mt-3" style="width:100%;" onclick="handleAdminLogin()">    
      Login    
    </button>    
    <div id="loginError" class="error" style="display:none;">‡§ó‡§≤‡§§ ID ‡§Ø‡§æ Password</div>    
    <p style="margin-top:12px;font-size:12px;color:#6b7280;">    
      Default: <b>ID: admin</b>, <b>Password: 1234</b>    
    </p>    
  </div>    
</div>    
    
<!-- ADMIN MAIN PAGE -->    
<div id="adminPage" style="display:none;">    
  <div class="wrap">    
    <!-- HEADER -->    
    <div class="panel flex between">    
      <div>    
        <h2>Binary Tree Admin (Firebase)</h2>    
        <div class="small">    
          ‡§π‡§∞ ID ‡§∏‡•á <b>20‚Çπ joining income</b> ‡§Æ‡§æ‡§®‡•Ä ‡§ó‡§à ‡§π‡•à‡•§<br/>    
          Binary pairs commission (per pair):      
          1‚Äì4 level: ‚Çπ10, 5: ‚Çπ8, 6: ‚Çπ7, 7: ‚Çπ6, 8: ‚Çπ5, 9: ‚Çπ4, 10+ : ‚Çπ3‡•§<br/>    
          ‡§ú‡§ø‡§® IDs ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§Æ‡•á‡§Ç <b>‚Äúsub‚Äù</b> ‡§Ü‡§§‡§æ ‡§π‡•à, ‡§â‡§®‡§ï‡•Ä commission ‡§ï‡§æ <b>80%</b> ‡§â‡§®‡§ï‡•Ä main ID ‡§ï‡•á <b>Bonus Wallet</b> ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§§‡§æ ‡§π‡•à      
          (20% company ‡§ï‡•á ‡§™‡§æ‡§∏ ‚Äì customer ‡§ï‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§§‡§æ)‡•§    
        </div>    
      </div>    
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>    
    </div>    
    
    <!-- CREATE ROOT CUSTOMER -->    
    <div class="panel">    
      <h3>‡§®‡§Ø‡§æ Customer ‡§¨‡§®‡§æ‡§è‡§Ç (Root level)</h3>    
      <div class="flex" style="gap:10px;flex-wrap:wrap;margin-top:8px;">    
        <div style="flex:1 1 200px;">    
          <label>Customer Name</label>    
          <input id="rootName" placeholder="‡§ú‡•à‡§∏‡•á: Rajesh" />    
        </div>    
        <div style="flex:1 1 200px;">    
          <label>Customer Password (Login ‡§ï‡•á ‡§≤‡§ø‡§è)</label>    
          <input id="rootPass" placeholder="‡§ú‡•à‡§∏‡•á: 1234" />    
        </div>    
      </div>    
      <button class="btn btn-primary mt-3" onclick="createRootCustomer()">    
        Root ‡§Æ‡•á‡§Ç ‡§®‡§Ø‡§æ Customer ‡§ú‡•ã‡§°‡§º‡•á‡§Ç    
      </button>    
      <div id="rootMsg" class="ok" style="display:none;"></div>    
      <p class="small" style="margin-top:6px;">    
        ‡§è‡§ï main ID ‡§¨‡§®‡§æ‡§ì, ‡§â‡§∏‡§ï‡•á ‡§®‡•Ä‡§ö‡•á +Member ‡§∏‡•á ‡§â‡§∏‡§ï‡•Ä sub IDs ‡§ú‡•ã‡§°‡§º‡•ã‡•§      
        System ‡§Ö‡§™‡§®‡•á-‡§Ü‡§™ commission + bonus wallets calculate ‡§ï‡§∞‡•á‡§ó‡§æ‡•§    
      </p>    
    </div>    
    
    <!-- COMPANY BUSINESS REPORT -->    
    <div class="panel">    
      <h3>Company Business Report (Auto)</h3>    
      <p class="small">    
        ‡§™‡•Ç‡§∞‡§æ tree ‡§∏‡•á calculation: <b>IDs √ó 20‚Çπ = Business Income</b>,      
        minus total binary payout (‡§∏‡§≠‡•Ä commission wallets) = <b>Company Profit</b>‡•§    
      </p>    
    
      <div class="profit-panel">    
        <div class="profit-boxes">    
          <div class="profit-box">    
            <div class="profit-label">Total Business Income (‡§∏‡§≠‡•Ä IDs √ó 20‚Çπ)</div>    
            <div class="profit-value" id="bizTotalIncome">‚Çπ0</div>    
          </div>    
          <div class="profit-box">    
            <div class="profit-label">Total Binary Pairs Income (Members ‡§ï‡•ã)</div>    
            <div class="profit-value" id="bizBinaryPayout">‚Çπ0</div>    
          </div>    
          <div class="profit-box">    
            <div class="profit-label">Company Profit (‚Çπ)</div>    
            <div class="profit-value" id="bizCompanyProfit">‚Çπ0</div>    
          </div>    
        </div>    
    
        <div class="mt-3">    
          <div class="small">Business Chart (Income vs Payout vs Profit)</div>    
          <canvas id="businessChart" width="400" height="220"></canvas>    
        </div>    
      </div>    
    </div>    
    
    <!-- CUSTOMER LIST -->    
    <div class="panel">    
      <div class="flex between">    
        <h3>Customer List (Tree Nodes)</h3>    
        <span class="badge" id="totalCustomersBadge">0 Customers</span>    
      </div>    
      <div class="wallets">    
        <div class="wallet-box">    
          <div class="wallet-title">‡§ï‡•Å‡§≤ Pairs (‡§™‡•Ç‡§∞‡§æ Tree)</div>    
          <div id="totalPairs" class="wallet-value">0</div>    
        </div>    
        <div class="wallet-box">    
          <div class="wallet-title">‡§ï‡•Å‡§≤ Binary Income (‡§∏‡§≠‡•Ä IDs ‡§∏‡•á)</div>    
          <div id="totalCommission" class="wallet-value">‚Çπ0</div>    
        </div>    
      </div>    
      <div class="mt-3" style="overflow-x:auto;">    
        <table>    
          <thead>    
            <tr>    
              <th>#</th>    
              <th>Name / Login</th>    
              <th>Members<br/>(Total)</th>    
              <th>Left / Right Members</th>    
              <th>Pairs</th>    
              <th>Level</th>    
              <th>Binary Income<br/>(‚Çπ)</th>    
              <th>Payout</th>    
              <th>Tree</th>    
              <th>Del</th>    
            </tr>    
          </thead>    
          <tbody id="customerTableBody"></tbody>    
        </table>    
      </div>    
      <p class="small" style="margin-top:6px;">    
        Binary logic: ‡§π‡§∞ 2 member = 1 pair.      
        Commission level-wise slab ‡§∏‡•á ‡§®‡§ø‡§ï‡§≤‡•á‡§ó‡§æ‡•§      
        ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§ú‡§ø‡§® IDs ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§Æ‡•á‡§Ç ‚Äúsub‚Äù ‡§Ü‡§§‡§æ ‡§π‡•à, ‡§â‡§®‡§ï‡•Ä commission ‡§∏‡•á 80% ‡§â‡§®‡§ï‡•Ä main ID ‡§ï‡•á Bonus Wallet ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§    
      </p>    
    </div>    
    
    <!-- TREE VIEW -->    
    <div class="tree-panel">    
      <div class="flex between">    
        <div>    
          <div class="tree-root-label">Binary Tree View</div>    
          <div id="treeRootInfo" style="font-size:13px;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à root select ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</div>    
        </div>    
        <button class="btn btn-secondary btn-sm" onclick="showFullRootTree()">‡§∏‡§ø‡§∞‡•ç‡§´ Root ‡§¶‡§ø‡§ñ‡§æ‡§ì</button>    
      </div>    
      <div id="treeViewArea" style="margin-top:10px;font-size:12px;">‡§Ö‡§≠‡•Ä tree ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§</div>    
    </div>    
    
  </div>    
</div>    
    
<!-- FIREBASE CDN -->    
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>    
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>    
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script><script>    
  /************ Firebase config ‚Äì RJVC PLAN ************/    
  const firebaseConfig = {    
    apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",    
    authDomain: "rjvc-plan.firebaseapp.com",    
    projectId: "rjvc-plan",    
    storageBucket: "rjvc-plan.firebasestorage.app",    
    messagingSenderId: "265431528728",    
    appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d",    
    measurementId: "G-1Y7PN96H93"    
  };    
    
  firebase.initializeApp(firebaseConfig);    
  try { firebase.analytics(); } catch(e) {}    
    
  const db       = firebase.firestore();    
  const treeCol  = db.collection("TreeNodes");    
  const usersCol = db.collection("Users");    
    
  /************ Simple Admin Login ************/    
  const ADMIN_ID       = "admin";    
  const ADMIN_PASSWORD = "1234";    
    
  function handleAdminLogin(){    
    const id   = document.getElementById("adminId").value.trim();    
    const pass = document.getElementById("adminPass").value.trim();    
    const err  = document.getElementById("loginError");    
    
    if(id === ADMIN_ID && pass === ADMIN_PASSWORD){    
      err.style.display = "none";    
      document.getElementById("loginPage").style.display = "none";    
      document.getElementById("adminPage").style.display = "block";    
      startSubscriptions();    
    }else{    
      err.style.display = "block";    
    }    
  }    
    
  function logout(){    
    document.getElementById("adminPage").style.display = "none";    
    document.getElementById("loginPage").style.display = "flex";    
    document.getElementById("adminPass").value = "";    
  }    
    
  /************ Tree data in memory ************/    
  let nodesById         = {};    
  let rootId            = null;    
  let currentTreeRootId = null;    
  let treeUnsub         = null;    
    
  function startSubscriptions(){    
    if(treeUnsub) treeUnsub();    
    treeUnsub = treeCol.orderBy("createdAt","asc").onSnapshot(snap=>{    
      nodesById = {};    
      rootId = null;    
      snap.forEach(doc=>{    
        const d = doc.data();    
        nodesById[doc.id] = Object.assign({id:doc.id}, d);    
      });    
    
      // root = ‡§ú‡§ø‡§∏‡§ï‡•Ä parentId null ‡§π‡•à    
      Object.values(nodesById).forEach(n=>{    
        if(!n.parentId) rootId = n.id;    
      });    
    
      recalcAll();    
      renderTable();    
      renderTree();    
    });    
  }    
    
  /************ Create Root Customer ************/    
  async function createRootCustomer(){    
    const name = document.getElementById("rootName").value.trim();    
    const pass = document.getElementById("rootPass").value.trim();    
    const msg  = document.getElementById("rootMsg");    
    msg.style.display = "none";    
    
    if(!name || !pass){    
      msg.textContent = "Name ‡§î‡§∞ Password ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡§Ç‡•§";    
      msg.className = "error";    
      msg.style.display = "block";    
      return;    
    }    
    
    try{    
      const newDoc = await treeCol.add({    
        name,    
        password: pass,    
        parentId: null,    
        leftId: null,    
        rightId: null,    
        mainAccountId: null,    
        createdAt: firebase.firestore.FieldValue.serverTimestamp()    
      });    
    
      await newDoc.update({ mainAccountId: newDoc.id });    
    
      await usersCol.doc(newDoc.id).set({    
        name,    
        password: pass,    
        commissionWallet: 0,    
        bonusWallet: 0,    
        mainAccountId: newDoc.id,    
        payoutBlocked: false    
      }, {merge:true});    
    
      document.getElementById("rootName").value = "";    
      document.getElementById("rootPass").value = "";    
    
      msg.textContent = "Customer root ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§";    
      msg.className = "ok";    
      msg.style.display = "block";    
    }catch(err){    
      msg.textContent = "Error: " + err.message;    
      msg.className = "error";    
      msg.style.display = "block";    
    }    
  }    
    
  /************ Utility ‚Äì descendants / left / right count ************/    
  function countDescendants(nodeId){    
    const node = nodesById[nodeId];    
    if(!node) return 0;    
    let c = 0;    
    if(node.leftId)  c += 1 + countDescendants(node.leftId);    
    if(node.rightId) c += 1 + countDescendants(node.rightId);    
    return c;    
  }    
    
  function countSideMembers(nodeId, sideField){    
    const node = nodesById[nodeId];    
    if(!node || !node[sideField]) return 0;    
    const childId = node[sideField];    
    return 1 + countDescendants(childId);    
  }    
    
  function getMainAccountId(node){    
    if(node.mainAccountId) return node.mainAccountId;    
    let current = node;    
    while(current.parentId && nodesById[current.parentId]){    
      current = nodesById[current.parentId];    
    }    
    return current.id;    
  }    
    
  /************ Commission Slabs (per pair) ************/    
  const LEVEL_RATES = [    
    { level:1, pairs:1,   rate:10 },    
    { level:2, pairs:2,   rate:10 },    
    { level:3, pairs:4,   rate:10 },    
    { level:4, pairs:8,   rate:10 },    
    { level:5, pairs:16,  rate:8  },    
    { level:6, pairs:32,  rate:7  },    
    { level:7, pairs:64,  rate:6  },    
    { level:8, pairs:128, rate:5  },    
    { level:9, pairs:256, rate:4  },    
    { level:10,pairs:512, rate:3  }    
  ];    
    
  function computeCommissionForPairs(totalPairs){    
    let remaining   = totalPairs;    
    let commission  = 0;    
    
    for(let i=0;i<LEVEL_RATES.length && remaining>0;i++){    
      const slab = LEVEL_RATES[i];    
      const usePairs = Math.min(remaining, slab.pairs);    
      commission += usePairs * slab.rate;    
      remaining  -= usePairs;    
    }    
    if(remaining > 0){    
      const lastRate = LEVEL_RATES[LEVEL_RATES.length-1].rate;    
      commission += remaining * lastRate;    
    }    
    return commission;    
  }    
    
  let globalTotalPairs       = 0;    
  let globalTotalCommission  = 0;    
  let globalTotalCustomers   = 0;    
  let globalTotalBusinessInc = 0;    
    
  function recalcAll(){    
    globalTotalPairs      = 0;    
    globalTotalCommission = 0;    
    globalTotalCustomers  = Object.keys(nodesById).length;    
    
    const list = Object.values(nodesById);    
    
    list.forEach(n=>{    
      const members    = countDescendants(n.id);    
      const leftCount  = countSideMembers(n.id,"leftId");    
      const rightCount = countSideMembers(n.id,"rightId");    
    
      // üîÅ AUTO PAIRS: ‡§π‡§∞ 2 member = 1 pair    
      const pairs      = Math.floor(members/2);    
      const comm       = computeCommissionForPairs(pairs);    
    
      n.members    = members;    
      n.leftCount  = leftCount;    
      n.rightCount = rightCount;    
      n.pairs      = pairs;    
      n.commission = comm;    
    
      globalTotalPairs      += pairs;    
      globalTotalCommission += comm;    
    });    
    
    globalTotalBusinessInc = globalTotalCustomers * 20;    
    const companyProfit = globalTotalBusinessInc - globalTotalCommission;    
    
    document.getElementById("totalPairs").textContent      = globalTotalPairs;    
    document.getElementById("totalCommission").textContent = "‚Çπ" + globalTotalCommission;    
    
    document.getElementById("bizTotalIncome").textContent   = "‚Çπ" + globalTotalBusinessInc;    
    document.getElementById("bizBinaryPayout").textContent  = "‚Çπ" + globalTotalCommission;    
    document.getElementById("bizCompanyProfit").textContent = "‚Çπ" + companyProfit;    
    
    drawBusinessChart(globalTotalBusinessInc, globalTotalCommission, companyProfit);    
    
    updateUsersWallets().catch(err=>console.error(err));    
  }    
    
  /************ Users wallets update (commission + bonus 80%) ************/    
  async function updateUsersWallets(){    
    const list = Object.values(nodesById);    
    const bonusMap = {}; // mainId -> total bonus    
    
    list.forEach(n=>{    
      const mainId = getMainAccountId(n);    
      n.mainAccountId = mainId;    
    
      treeCol.doc(n.id).set({ mainAccountId: mainId }, {merge:true});    
    
      const name = (n.name || "").toLowerCase();    
      const isSubIdByName = name.includes("sub");    
    
      if(isSubIdByName && mainId !== n.id){    
        const subComm    = n.commission || 0;    
        const bonusShare = +(subComm * 0.80).toFixed(2);    
        bonusMap[mainId] = (bonusMap[mainId] || 0) + bonusShare;    
      }    
    });    
    
    const batch = db.batch();    
    list.forEach(n=>{    
      const rawName   = n.name || "";    
      const cleanName = rawName.trim();    
      const pass      = (n.password || "").trim();    
    
      const uRef  = usersCol.doc(n.id);    
      const data = {    
        name: cleanName,    
        loginName: cleanName,    
        password: pass,    
        loginPassword: pass,    
        commissionWallet: n.commission || 0,    
        bonusWallet: +( (bonusMap[n.id] || 0).toFixed(2) ),    
        mainAccountId: n.mainAccountId || n.id    
      };    
      batch.set(uRef, data, {merge:true});    
    });    
    
    await batch.commit();    
  }    
    
  /************ Payout toggle ************/    
  async function togglePayout(id){    
    const uRef = usersCol.doc(id);    
    const snap = await uRef.get();    
    const cur  = snap.exists && snap.data().payoutBlocked ? true : false;    
    await uRef.set({payoutBlocked: !cur},{merge:true});    
  }    
    
  /************ Table render ************/    
  function renderTable(){    
    const tbody = document.getElementById("customerTableBody");    
    tbody.innerHTML = "";    
    const list = Object.values(nodesById);    
    list.sort((a,b)=>a.name.localeCompare(b.name));    
    
    document.getElementById("totalCustomersBadge").textContent =    
      list.length + " Customers";    
    
    list.forEach((n,idx)=>{    
      const leftC  = n.leftCount  || 0;    
      const rightC = n.rightCount || 0;    
    
      const pairs = n.pairs || 0;    
      let levelLabel = "-";    
      if(pairs>0){    
        let remaining = pairs;    
        for(let i=0;i<LEVEL_RATES.length;i++){    
          const slab = LEVEL_RATES[i];    
          if(remaining <= slab.pairs){    
            levelLabel = "Level " + slab.level;    
            break;    
          }    
          remaining -= slab.pairs;    
        }    
      }    
    
      const tr = document.createElement("tr");    
      tr.innerHTML = `    
        <td>${idx+1}</td>    
        <td>    
          ${n.name}<br/>    
          <span class="small">Login: ${n.name} / ${n.password || ""}</span>    
        </td>    
        <td>${n.members || 0}</td>    
        <td>L:${leftC} ¬∑ R:${rightC}</td>    
        <td>${n.pairs || 0}</td>    
        <td>${levelLabel}</td>    
        <td>‚Çπ${n.commission || 0}</td>    
        <td>    
          <button class="btn btn-sm btn-secondary" onclick="togglePayout('${n.id}')">    
            Toggle    
          </button>    
        </td>    
        <td><button class="btn btn-secondary btn-sm" onclick="viewTreeFrom('${n.id}')">Tree</button></td>    
        <td><button class="btn btn-danger btn-sm" onclick="deleteCustomer('${n.id}')">Del</button></td>    
      `;    
      tbody.appendChild(tr);    
    });    
  }    
    
  /************ Tree view ************/    
  function viewTreeFrom(id){    
    currentTreeRootId = id;    
    renderTree();    
  }    
  function showFullRootTree(){    
    currentTreeRootId = rootId;    
    renderTree();    
  }    
    
  function renderTree(){    
    const area = document.getElementById("treeViewArea");    
    const info = document.getElementById("treeRootInfo");    
    
    if(!Object.keys(nodesById).length){    
      info.textContent = "Tree ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§ ‡§™‡§π‡§≤‡•á ‡§ï‡•ã‡§à customer ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§";    
      area.textContent = "";    
      return;    
    }    
    
    const startId   = currentTreeRootId || rootId;    
    const startNode = nodesById[startId];    
    if(!startNode){    
      info.textContent = "Tree root ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";    
      area.textContent = "";    
      return;    
    }    
    
    info.innerHTML = `‡§Ö‡§≠‡•Ä tree <b>${startNode.name}</b> ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à    
      (Members: ${startNode.members||0}, Pairs: ${startNode.pairs||0}, Binary Income: ‚Çπ${startNode.commission||0})`;    
    
    let html = "";    
    
    function buildLevel(ids){    
      if(!ids.length) return;    
      html += `<div class="tree-level">`;    
      ids.forEach(id=>{    
        const n = nodesById[id];    
        if(!n) return;    
        const isMainTreeRoot = (id === rootId);    
        const leftC  = n.leftCount  || 0;    
        const rightC = n.rightCount || 0;    
        html += `    
          <div class="tree-node-wrap">    
            <div class="tree-node ${isMainTreeRoot ? "tree-node-main":""}">    
              <div class="tree-node-name">${n.name}</div>    
              <div class="tree-node-meta">    
                L:${leftC} ¬∑ R:${rightC} ¬∑ M:${n.members||0} ¬∑ P:${n.pairs||0} ¬∑ ‚Çπ${n.commission||0}    
              </div>    
              <div class="tree-node-actions">    
                <button class="btn btn-secondary btn-sm" onclick="treeAddMember('${n.id}')">+Member</button>    
                <button class="btn btn-secondary btn-sm" onclick="editCustomer('${n.id}')">Edit</button>    
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${n.id}')">Del</button>    
              </div>    
            </div>    
          </div>`;    
      });    
      html += `</div>`;    
    
      const next = [];    
      ids.forEach(id=>{    
        const n = nodesById[id];    
        if(!n) return;    
        if(n.leftId)  next.push(n.leftId);    
        if(n.rightId) next.push(n.rightId);    
      });    
      if(next.length) buildLevel(next);    
    }    
    
    buildLevel([startId]);    
    area.innerHTML = html;    
  }    
    
  /************ Add / Edit / Delete ************/    
    
  function treeAddMember(parentId){    
    const sideAns = prompt("‡§ï‡§ø‡§∏ side ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§π‡•à? Left = L ‡§Ø‡§æ 1, Right = R ‡§Ø‡§æ 2");    
    if(!sideAns) return;    
    const s = sideAns.trim().toLowerCase();    
    let sideField = null;    
    if(s==="l" || s==="1") sideField = "leftId";    
    else if(s==="r" || s==="2") sideField = "rightId";    
    else{    
      alert("‡§ó‡§≤‡§§ choice, L/1 ‡§Ø‡§æ R/2 ‡§≤‡§ø‡§ñ‡•á‡§Ç");    
      return;    
    }    
    
    const name = prompt("‡§®‡§Ø‡§æ member ‡§ï‡§æ ‡§®‡§æ‡§Æ?");    
    if(!name) return;    
    const pass = prompt("‡§â‡§∏‡§ï‡§æ login password?");    
    if(!pass) return;    
    
    addMember(parentId, sideField, name, pass);    
  }    
    
  // ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç member ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§™‡§∞ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ subtree ‡§®‡•Ä‡§ö‡•á shift ‡§π‡•ã ‡§ï‡§∞ 2‚Äì2 seats ‡§Æ‡•á‡§Ç redistribute    
  async function addMember(parentId, sideField, name, pass){    
    try{    
      const parentRef  = treeCol.doc(parentId);    
      const parentSnap = await parentRef.get();    
      if(!parentSnap.exists){    
        alert("Parent ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");    
        return;    
      }    
      const parent = parentSnap.data();    
      const existingChildId = parent[sideField] || null;    
    
      const mainForChild = parent.mainAccountId || parentId;    
    
      const newRef = await treeCol.add({    
        name,    
        password: pass,    
        parentId: parentId,    
        leftId: null,    
        rightId: null,    
        mainAccountId: mainForChild,    
        createdAt: firebase.firestore.FieldValue.serverTimestamp()    
      });    
      const newId = newRef.id;    
    
      await usersCol.doc(newId).set({    
        name,    
        password: pass,    
        commissionWallet: 0,    
        bonusWallet: 0,    
        mainAccountId: mainForChild,    
        payoutBlocked: false    
      }, {merge:true});    
    
      if(!existingChildId){    
        const update = {};    
        update[sideField] = newId;    
        await parentRef.update(update);    
        return;    
      }    
    
      const subtreeIds = [];    
      const queue = [existingChildId];    
      while(queue.length){    
        const nid = queue.shift();    
        if(!nodesById[nid]) continue;    
        subtreeIds.push(nid);    
        const nd = nodesById[nid];    
        if(nd.leftId)  queue.push(nd.leftId);    
        if(nd.rightId) queue.push(nd.rightId);    
      }    
    
      const parentUpdate = {};    
      parentUpdate[sideField] = newId;    
      await parentRef.update(parentUpdate);    
    
      const linkMap = {};    
      subtreeIds.forEach(id=>{    
        linkMap[id] = {parentId:null,leftId:null,rightId:null};    
      });    
    
      const parentsQueue = [newId];    
      let idx = 0;    
      const newNodeLinks = {leftId:null,rightId:null};    
    
      while(idx < subtreeIds.length && parentsQueue.length){    
        const pId = parentsQueue.shift();    
        for(let k=0;k<2 && idx<subtreeIds.length;k++){    
          const childId = subtreeIds[idx++];    
          if(pId === newId){    
            if(!newNodeLinks.leftId) newNodeLinks.leftId = childId;    
            else newNodeLinks.rightId = childId;    
          }else{    
            const pLink = linkMap[pId];    
            if(!pLink.leftId) pLink.leftId = childId;    
            else pLink.rightId = childId;    
          }    
          linkMap[childId].parentId = (pId === newId ? newId : pId);    
          parentsQueue.push(childId);    
        }    
      }    
    
      const batch = db.batch();    
    
      batch.update(newRef, {    
        leftId:  newNodeLinks.leftId  || null,    
        rightId: newNodeLinks.rightId || null    
      });    
    
      subtreeIds.forEach(id=>{    
        const l = linkMap[id];    
        const ref = treeCol.doc(id);    
        batch.update(ref, {    
          parentId: l.parentId || null,    
          leftId:   l.leftId   || null,    
          rightId:  l.rightId  || null    
        });    
      });    
    
      await batch.commit();    
    
    }catch(err){    
      alert("Error: " + err.message);    
    }    
  }    
    
  async function editCustomer(id){    
    const node = nodesById[id];    
    if(!node) return;    
    const newName = prompt("‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ?", node.name);    
    if(!newName) return;    
    const newPass = prompt("‡§®‡§Ø‡§æ password? (‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º‡•ã ‡§§‡•ã ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§π‡•Ä ‡§∞‡§π‡•á‡§ó‡§æ)", node.password || "");    
    const update = { name:newName };    
    if(newPass && newPass.trim()) update.password = newPass.trim();    
    
    try{    
      await treeCol.doc(id).update(update);    
      await usersCol.doc(id).set(update,{merge:true});    
    }catch(err){    
      alert("Error: " + err.message);    
    }    
  }    
    
  async function deleteCustomer(id){    
    const node = nodesById[id];    
    if(!node) return;    
    if(!confirm(`"${node.name}" ‡§î‡§∞ ‡§â‡§∏‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ subtree delete ‡§π‡•ã‡§ó‡§æ, ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç?`)) return;    
    
    if(node.parentId){    
      const parentRef = treeCol.doc(node.parentId);    
      const parent    = nodesById[node.parentId];    
      if(parent){    
        const upd = {};    
        if(parent.leftId === id)  upd.leftId  = null;    
        if(parent.rightId === id) upd.rightId = null;    
        await parentRef.update(upd);    
      }    
    }    
    
    async function deleteSubTree(nid){    
      const n = nodesById[nid];    
      if(!n) return;    
      if(n.leftId)  await deleteSubTree(n.leftId);    
      if(n.rightId) await deleteSubTree(n.rightId);    
      await treeCol.doc(nid).delete();    
      await usersCol.doc(nid).delete();    
    }    
    await deleteSubTree(id);    
  }    
    
  /************ Business Chart ************/    
  function drawBusinessChart(totalIncome, binaryPayout, companyProfit){    
    const canvas = document.getElementById("businessChart");    
    if(!canvas) return;    
    const ctx = canvas.getContext("2d");    
    ctx.clearRect(0,0,canvas.width,canvas.height);    
    
    const labels = ["Business Income","Binary Payout","Company Profit"];    
    const values = [totalIncome, binaryPayout, companyProfit];    
    const maxVal = Math.max(1, ...values);    
    const barWidth = 60;    
    const gap = 40;    
    const originX = 40;    
    const originY = canvas.height - 30;    
    
    ctx.strokeStyle = "#9ca3af";    
    ctx.beginPath();    
    ctx.moveTo(originX, 10);    
    ctx.lineTo(originX, originY);    
    ctx.lineTo(canvas.width - 10, originY);    
    ctx.stroke();    
    
    for(let i=0;i<values.length;i++){    
      const x = originX + gap + i*(barWidth+gap);    
      const h = (values[i]/maxVal) * (originY-40);    
      const y = originY - h;    
    
      ctx.fillStyle = i===0 ? "#3b82f6" : (i===1 ? "#f97316" : "#22c55e");    
      ctx.fillRect(x, y, barWidth, h);    
    
      ctx.fillStyle = "#111827";    
      ctx.font = "11px system-ui";    
      ctx.textAlign = "center";    
      ctx.fillText(labels[i], x+barWidth/2, originY+14);    
      ctx.fillText("‚Çπ"+values[i], x+barWidth/2, y-4);    
    }    
  }    
</script>    
    
</body>    
</html>
