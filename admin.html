<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>RJVC Binary Tree Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#020617;color:#e5e7eb}
.wrap{max-width:1200px;margin:auto;padding:14px}
h2{margin:0 0 8px}
.small{font-size:12px;color:#94a3b8}
.center{text-align:center}

.btn{padding:8px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb;color:#111827}
.btn-danger{background:#dc2626;color:#fff}

.card{background:#0b1320;border-radius:14px;padding:16px;margin-bottom:14px}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:center}
th{background:#020617}

.treeBox{
  background:#020617;
  border-radius:14px;
  padding:12px;
  overflow:auto;
}
canvas{width:100%;height:520px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="wrap">
  <div class="card" style="max-width:380px;margin:80px auto">
    <h2 class="center">Admin Login</h2>
    <input id="adminId" placeholder="admin" style="width:100%;padding:10px;margin-top:8px">
    <input id="adminPass" type="password" placeholder="1234" style="width:100%;padding:10px;margin-top:8px">
    <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="login()">Login</button>
    <div id="loginError" class="small" style="color:#f87171;display:none">Wrong login</div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPage" style="display:none">

<div class="wrap">

<h2>RJVC Admin Panel</h2>

<div class="card">
  <input id="rootName" placeholder="Root name">
  <input id="rootPass" placeholder="Password" style="margin-top:6px">
  <button class="btn btn-primary" style="margin-top:8px" onclick="createRoot()">Create Root</button>
</div>

<div class="card">
  <h3>Customer List</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>₹20 Cycles</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="customerTable"></tbody>
  </table>
</div>

<div class="card">
  <h3>Binary Tree View</h3>
  <div class="treeBox">
    <canvas id="treeCanvas"></canvas>
  </div>
</div>

</div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
  authDomain: "rjvc-plan.firebaseapp.com",
  projectId: "rjvc-plan"
});

const db = firebase.firestore();
const treeCol = db.collection("TreeNodes");

let nodes = {};
let rootId = null;

/* LOGIN */
function login(){
  if(adminId.value==="admin" && adminPass.value==="1234"){
    loginPage.style.display="none";
    adminPage.style.display="block";
    loadData();
  }else loginError.style.display="block";
}

/* LOAD DATA */
function loadData(){
  treeCol.onSnapshot(snap=>{
    nodes={}; rootId=null;
    snap.forEach(d=>{
      nodes[d.id]=d.data();
      if(!d.data().parentId) rootId=d.id;
    });
    renderTable();
    drawTree();
  });
}

/* CREATE ROOT */
function createRoot(){
  if(!rootName.value||!rootPass.value) return alert("Fill both");
  treeCol.add({
    name:rootName.value,
    password:rootPass.value,
    parentId:null,leftId:null,rightId:null,
    monthsPaid:1
  });
  rootName.value="";rootPass.value="";
}

/* TABLE */
function renderTable(){
  customerTable.innerHTML="";
  let i=1;
  Object.entries(nodes).forEach(([id,n])=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i++}</td>
      <td>${n.name}</td>
      <td>${n.monthsPaid||1}</td>
      <td>
        <button class="btn btn-secondary" onclick="add20('${id}')">+₹20</button>
        <button class="btn btn-danger" onclick="deleteSafe('${id}')">Delete</button>
      </td>
    `;
    customerTable.appendChild(tr);
  });
}

/* ADD ₹20 */
async function add20(id){
  const ref=treeCol.doc(id);
  const snap=await ref.get();
  await ref.update({monthsPaid:(snap.data().monthsPaid||1)+1});
}

/* SAFE DELETE + AUTO BALANCE */
async function deleteSafe(id){
  const node=nodes[id];
  if(!node) return;
  if(!confirm(node.name+" delete?")) return;

  const parentId=node.parentId;
  const kids=[node.leftId,node.rightId].filter(Boolean);

  if(parentId){
    const p=nodes[parentId];
    let upd={};
    if(p.leftId===id) upd.leftId=null;
    if(p.rightId===id) upd.rightId=null;
    await treeCol.doc(parentId).update(upd);

    for(const cid of kids){
      await attachBalanced(parentId,cid);
    }
  }

  await treeCol.doc(id).delete();
}

/* BALANCE */
async function attachBalanced(parentId,childId){
  const p=nodes[parentId];
  if(!p.leftId){
    await treeCol.doc(parentId).update({leftId:childId});
  }else if(!p.rightId){
    await treeCol.doc(parentId).update({rightId:childId});
  }else{
    await attachBalanced(p.leftId,childId);
  }
  await treeCol.doc(childId).update({parentId});
}

/* DRAW TREE (AUTO SMALL) */
function drawTree(){
  const c=document.getElementById("treeCanvas");
  const ctx=c.getContext("2d");
  c.width=c.clientWidth; c.height=520;
  ctx.clearRect(0,0,c.width,c.height);
  if(!rootId) return;

  let levels=[[rootId]];
  for(let i=0;i<5;i++){
    let next=[];
    levels[i].forEach(id=>{
      let n=nodes[id];
      if(n.leftId) next.push(n.leftId);
      if(n.rightId) next.push(n.rightId);
    });
    if(next.length) levels.push(next);
  }

  let y=20;
  levels.forEach(lvl=>{
    let step=c.width/(lvl.length+1);
    lvl.forEach((id,i)=>{
      let x=step*(i+1);
      ctx.fillStyle="#2563eb";
      ctx.fillRect(x-50,y,100,36);
      ctx.fillStyle="#fff";
      ctx.fillText(nodes[id].name,x-40,y+22);
    });
    y+=80;
  });
}
</script>

</body>
  </html>
