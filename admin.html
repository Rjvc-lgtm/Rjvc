<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #e6ebff;
    }
    .app {
      max-width: 950px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    h1 {
      text-align: center;
      margin: 0 0 4px;
      font-size: 26px;
      color: #102a6b;
    }
    .sub-title-main {
      text-align: center;
      font-size: 13px;
      margin-bottom: 14px;
      color: #444;
    }

    h2 {
      margin: 12px 0 6px;
      font-size: 18px;
      color: #102a6b;
    }
    .section-card {
      margin-top: 12px;
      padding: 12px 12px 14px;
      border-radius: 14px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .col {
      flex: 1 1 180px;
    }
    button {
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #0066ff;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
      margin-top: 4px;
    }
    .btn-danger {
      background: #ff4d4f;
      color: #fff;
    }

    .small {
      font-size: 11px;
      color: #777;
    }
    .success-msg {
      font-size: 12px;
      color: #0b8a00;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f1f3ff;
      font-weight: 600;
    }
    td.num {
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .badge-active {
      background: #e6fffb;
      color: #006d75;
    }
    .badge-blocked {
      background: #fff1f0;
      color: #cf1322;
    }

    /* Tree view */
    .tree-card {
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: #f5f7ff;
      border: 1px solid #d6ddff;
      font-size: 12px;
    }
    .tree-center {
      text-align: center;
      margin-bottom: 10px;
    }
    .tree-node {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #102a6b;
      color: #fff;
      font-size: 12px;
      min-width: 110px;
    }
    .tree-row {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 10px;
    }
    .tree-col {
      text-align: center;
      position: relative;
    }
    .tree-line-horizontal {
      height: 2px;
      background: #c0c6ff;
      margin: 4px 40px 10px;
    }
    .tree-line-vertical {
      width: 2px;
      background: #c0c6ff;
      height: 14px;
      margin: 0 auto;
    }

    .tree-note {
      margin-top: 8px;
      font-size: 11px;
      color: #555;
      white-space: pre-line;
    }

    .muted {
      color: #999;
    }

    /* Withdrawals */
    .status-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-block;
    }
    .status-pending { background: #fffbe6; color: #925400; }
    .status-paid    { background: #f6ffed; color: #389e0d; }
    .status-reject  { background: #fff1f0; color: #cf1322; }

    @media (max-width: 640px) {
      table {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>RJVC ADMIN PANEL</h1>
    <div class="sub-title-main">
      यहाँ से आप Customers बना सकते हैं, Tree देख सकते हैं, Commission / Bonus manage कर सकते हैं।
    </div>

    <!-- NEW CUSTOMER -->
    <div class="section-card">
      <h2>नया Customer Create करें</h2>
      <div class="row">
        <div class="col">
          <label>Customer Name</label>
          <input id="newName" type="text" placeholder="जैसे: रमेश" />
        </div>
        <div class="col">
          <label>Mobile Number</label>
          <input id="newMobile" type="tel" placeholder="10 digit number" />
        </div>
      </div>
      <button class="btn-primary" onclick="createCustomer()">Create Customer</button>
      <div id="createMsg" class="success-msg"></div>
    </div>

    <!-- CUSTOMER LIST -->
    <div class="section-card">
      <h2>Customer List (1 Main + 3 Sub IDs)</h2>
      <div class="small">
        यहाँ से आप Member add कर सकते हैं, Commission / Bonus देख सकते हैं और Tree View सिर्फ admin के लिए है
        (customer को नहीं दिखेगा)।
      </div>
      <div style="overflow-x:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ID Type</th>
              <th>RJVC ID</th>
              <th>Name</th>
              <th>Mobile</th>
              <th class="num">Joined Members<br/>(Total Tree)</th>
              <th class="num">Commission Wallet<br/>(Main ID)</th>
              <th class="num">Bonus Wallet<br/>(Main ID)</th>
              <th>Status / Actions</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- JS से rows आएँगी -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- TREE VIEW -->
    <div class="section-card">
      <h2>Tree View (केवल Admin के लिए)</h2>
      <div class="small">
        ऊपर किसी Main ID की row में <b>Tree View</b> बटन दबाएँ – यहाँ पूरा Main + 3 Sub IDs का tree दिखेगा।
      </div>
      <div id="treeContainer" class="tree-card muted">
        अभी कोई customer select नहीं किया है।
      </div>
    </div>

    <!-- WITHDRAWAL REQUESTS -->
    <div class="section-card">
      <h2>Withdrawal Requests (Approve / Reject)</h2>
      <div class="small">यह सूची customer side से की गई सभी withdrawal requests दिखाती है।</div>
      <div style="overflow-x:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Mobile</th>
              <th class="num">Amount (₹)</th>
              <th>Wallet</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="withdrawTableBody">
            <!-- JS से rows आएँगी -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ----------------- Helpers -----------------
    function formatNumber(n) {
      return Number(n || 0).toLocaleString("en-IN");
    }

    function getSettings() {
      try {
        const s = JSON.parse(localStorage.getItem("rjvc_settings") || "{}");
        if (!s.perMember) s.perMember = 16; // default 16₹
        return s;
      } catch (e) {
        return { perMember: 16 };
      }
    }

    function getCustomers() {
      try {
        let list = JSON.parse(localStorage.getItem("rjvc_customers") || "[]");
        // पुराने data को भी ठीक कर दें
        list = list.map((c, idx) => {
          if (!c.rjvcBase) {
            // अगर पहले से कोई code नहीं है तो नया बना दें
            c.rjvcBase = c.rjvcBase || c.rjvcId || ("RJVC" + (3000 + idx));
          }
          c.joinedMain  = c.joinedMain  || 0;
          c.joinedSub1  = c.joinedSub1  || 0;
          c.joinedSub2  = c.joinedSub2  || 0;
          c.joinedSub3  = c.joinedSub3  || 0;
          if (typeof c.joinedMembers !== "number") {
            c.joinedMembers =
              c.joinedMain + c.joinedSub1 + c.joinedSub2 + c.joinedSub3;
          }
          c.walletBalance = c.walletBalance || 0; // Commission Wallet
          c.bonusBalance  = c.bonusBalance  || 0; // Bonus Wallet
          c.status = c.status || "Active";
          return c;
        });
        return list;
      } catch (e) {
        return [];
      }
    }

    function saveCustomers(list) {
      localStorage.setItem("rjvc_customers", JSON.stringify(list));
    }

    function getWithdrawals() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_withdrawals") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveWithdrawals(list) {
      localStorage.setItem("rjvc_withdrawals", JSON.stringify(list));
    }

    function generateRJVCCode() {
      const num = Math.floor(1000 + Math.random() * 9000);
      return "RJVC" + num;
    }

    // ----------------- Create Customer -----------------
    function createCustomer() {
      const name = (document.getElementById("newName").value || "").trim();
      const mobile = (document.getElementById("newMobile").value || "").trim();
      const msg = document.getElementById("createMsg");
      msg.textContent = "";

      if (!name || !mobile || mobile.length < 10) {
        alert("कृपया सही नाम और 10 digit mobile number भरें।");
        return;
      }

      const customers = getCustomers();
      const exists = customers.find(c => c.mobile === mobile);
      if (exists) {
        alert("इस mobile number के लिए customer पहले से मौजूद है।");
        return;
      }

      const base = generateRJVCCode();
      const id = Date.now();

      const record = {
        id,
        name,
        mobile,
        rjvcBase: base,
        joinedMain: 0,
        joinedSub1: 0,
        joinedSub2: 0,
        joinedSub3: 0,
        joinedMembers: 0,
        walletBalance: 0,
        bonusBalance: 0,
        state: "normal",
        currentLevel: 0,
        nextLevel: null,
        remainingForNext: 0,
        nextLevelIncome: 0,
        totalIncome: 0,
        status: "Active",
        createdAt: new Date().toISOString()
      };

      customers.push(record);
      saveCustomers(customers);
      renderCustomers();

      document.getElementById("newName").value = "";
      document.getElementById("newMobile").value = "";

      msg.textContent = "Customer सफलतापूर्वक बनाया गया ✔ (Main + 3 Sub IDs auto create हो गए हैं)";
      setTimeout(() => { msg.textContent = ""; }, 4000);
    }

    // ----------------- Render Customers -----------------
    function renderCustomers() {
      const tbody = document.getElementById("customerTableBody");
      const customers = getCustomers().sort((a, b) =>
        (a.createdAt || 0) > (b.createdAt || 0) ? -1 : 1
      );

      let html = "";
      customers.forEach(c => {
        const totalJoined =
          (c.joinedMain || 0) +
          (c.joinedSub1 || 0) +
          (c.joinedSub2 || 0) +
          (c.joinedSub3 || 0);
        const commission = c.walletBalance || 0;
        const bonus = c.bonusBalance || 0;

        function row(idType, nodeKey, label) {
          const base = c.rjvcBase || "RJVC0000";
          let rjvcId = base;
          if (nodeKey === "sub1") rjvcId = base + "-1";
          if (nodeKey === "sub2") rjvcId = base + "-2";
          if (nodeKey === "sub3") rjvcId = base + "-3";

          const isMain = nodeKey === "main";
          const rowCommission = isMain ? commission : 0;
          const rowBonus = isMain ? bonus : 0;

          return `
            <tr>
              <td>${idType}</td>
              <td>${rjvcId}</td>
              <td>${c.name || ""}</td>
              <td>${c.mobile || ""}</td>
              <td class="num">${formatNumber(totalJoined)}</td>
              <td class="num">₹${formatNumber(rowCommission)}</td>
              <td class="num">₹${formatNumber(rowBonus)}</td>
              <td>
                ${isMain
                  ? `<span class="badge ${c.status === "Active" ? "badge-active" : "badge-blocked"}">
                       ${c.status}
                     </span><br/>`
                  : ""
                }
                <button class="btn-secondary btn-small" onclick="addMember(${c.id}, '${nodeKey}')">
                  + Member (${label})
                </button><br/>
                ${isMain ? `
                  <button class="btn-secondary btn-small" onclick="showTree(${c.id})">
                    Tree View
                  </button><br/>
                  <button class="btn-secondary btn-small" onclick="manualBonus(${c.id})">
                    Manual Bonus
                  </button><br/>
                  <button class="btn-secondary btn-small" onclick="editCustomer(${c.id})">
                    Edit
                  </button><br/>
                  <button class="btn-small ${c.status === "Active" ? "btn-danger" : "btn-secondary"}"
                          onclick="toggleStatus(${c.id})">
                    ${c.status === "Active" ? "Block" : "Unblock"}
                  </button><br/>
                  <button class="btn-danger btn-small" onclick="deleteCustomer(${c.id})">
                    Delete
                  </button>
                ` : ""}
              </td>
            </tr>
          `;
        }

        html += row("Main ID", "main", "Main");
        html += row("Sub ID 1", "sub1", "Sub 1");
        html += row("Sub ID 2", "sub2", "Sub 2");
        html += row("Sub ID 3", "sub3", "Sub 3");
      });

      if (!html) {
        html = `<tr><td colspan="8" class="muted">अभी तक कोई customer नहीं बनाया गया है।</td></tr>`;
      }

      tbody.innerHTML = html;
    }

    // ----------------- Add Member / Commission Logic -----------------
    function addMember(customerId, nodeKey) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;
      const c = customers[idx];

      if (c.status !== "Active") {
        alert("यह customer अभी Blocked है, पहले Unblock करें।");
        return;
      }

      const label =
        nodeKey === "main" ? "Main ID" :
        nodeKey === "sub1" ? "Sub ID 1" :
        nodeKey === "sub2" ? "Sub ID 2" : "Sub ID 3";

      let countStr = prompt(label + " के नीचे कितने नए members add करने हैं?", "1");
      if (countStr === null) return;
      const count = parseInt(countStr, 10);
      if (!count || count <= 0) {
        alert("Valid number दर्ज करें।");
        return;
      }

      const per = getSettings().perMember || 16;
      const totalCommission = count * per;

      if (nodeKey === "main") {
        // सीधे Commission Wallet
        c.joinedMain = (c.joinedMain || 0) + count;
        c.walletBalance = (c.walletBalance || 0) + totalCommission;
      } else {
        // Sub IDs → 15% company share, 85% bonus main को
        const companyShare = Math.round(totalCommission * 0.15);
        const bonusToMain = totalCommission - companyShare;

        if (nodeKey === "sub1") {
          c.joinedSub1 = (c.joinedSub1 || 0) + count;
        } else if (nodeKey === "sub2") {
          c.joinedSub2 = (c.joinedSub2 || 0) + count;
        } else if (nodeKey === "sub3") {
          c.joinedSub3 = (c.joinedSub3 || 0) + count;
        }

        c.bonusBalance = (c.bonusBalance || 0) + bonusToMain;
      }

      c.joinedMembers =
        (c.joinedMain || 0) +
        (c.joinedSub1 || 0) +
        (c.joinedSub2 || 0) +
        (c.joinedSub3 || 0);

      saveCustomers(customers);
      renderCustomers();

      alert("Members और commission / bonus सफलतापूर्वक अपडेट हो गए हैं।");
    }

    // ----------------- Manual Bonus -----------------
    function manualBonus(customerId) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;
      const c = customers[idx];

      let amtStr = prompt(
        (c.name || "") + " के Bonus Wallet में कितना manual bonus जोड़ना है? (₹)", "0"
      );
      if (amtStr === null) return;
      const amt = parseFloat(amtStr || "0");
      if (!amt || amt <= 0) {
        alert("Valid amount दर्ज करें।");
        return;
      }

      c.bonusBalance = (c.bonusBalance || 0) + amt;
      saveCustomers(customers);
      renderCustomers();
      alert("Bonus Wallet सफलतापूर्वक अपडेट हो गया है।");
    }

    // ----------------- Edit / Block / Delete -----------------
    function editCustomer(customerId) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;
      const c = customers[idx];

      const newName = prompt("नया नाम दर्ज करें:", c.name || "") || c.name;
      const newMobile = prompt("नया mobile number दर्ज करें:", c.mobile || "") || c.mobile;

      c.name = newName.trim();
      c.mobile = newMobile.trim();

      saveCustomers(customers);
      renderCustomers();
    }

    function toggleStatus(customerId) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;
      const c = customers[idx];

      c.status = c.status === "Active" ? "Blocked" : "Active";
      saveCustomers(customers);
      renderCustomers();
    }

    function deleteCustomer(customerId) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === customerId);
      if (idx === -1) return;

      const c = customers[idx];

      if (!confirm(
        "क्या आप सच में इस customer को delete करना चाहते हैं?\n\n" +
        "Name: " + (c.name || "") + "\nMobile: " + (c.mobile || "") + "\n\n" +
        "ध्यान दें: इसकी पूरी Main ID + सभी Sub IDs का tree,\n" +
        "commission / bonus और इससे जुड़े withdrawal records भी हट जाएँगे।"
      )) {
        return;
      }

      let withdrawals = getWithdrawals();
      withdrawals = withdrawals.filter(w => w.customerId !== customerId);
      saveWithdrawals(withdrawals);

      customers.splice(idx, 1);
      saveCustomers(customers);
      renderCustomers();

      const treeDiv = document.getElementById("treeContainer");
      treeDiv.innerHTML = "अभी कोई customer select नहीं किया है।";
      treeDiv.classList.add("muted");

      alert("Customer और उसकी सभी IDs व withdrawals सफलतापूर्वक delete कर दिए गए हैं।");
    }

    // ----------------- Tree View -----------------
    function showTree(customerId) {
      const customers = getCustomers();
      const c = customers.find(x => x.id === customerId);
      if (!c) return;

      const base = c.rjvcBase || "RJVC0000";
      const mainId = base;
      const sub1 = base + "-1";
      const sub2 = base + "-2";
      const sub3 = base + "-3";

      const treeDiv = document.getElementById("treeContainer");
      treeDiv.classList.remove("muted");

      treeDiv.innerHTML = `
        <div class="tree-center">
          <div class="tree-node">Main ID<br/>${mainId}</div>
        </div>
        <div class="tree-line-horizontal"></div>
        <div class="tree-row">
          <div class="tree-col">
            <div class="tree-node">Sub ID 1<br/>${sub1}</div>
            <div class="tree-line-vertical"></div>
            <div class="tree-node">Sub ID 3<br/>${sub3}</div>
          </div>
          <div class="tree-col">
            <div class="tree-node">Sub ID 2<br/>${sub2}</div>
          </div>
        </div>
        <div class="tree-note">
इस Sub ID के नीचे जितनी commission बनेगी, उस में से 15% company share कटकर,
बचा हुआ 85% सिर्फ Main ID के Bonus Wallet में जाएगा (Commission Wallet पर नहीं आएगा)।
        </div>
      `;
    }

    // ----------------- Withdrawals -----------------
    function renderWithdrawals() {
      const tbody = document.getElementById("withdrawTableBody");
      const list = getWithdrawals().sort((a, b) =>
        (a.createdAt || 0) > (b.createdAt || 0) ? -1 : 1
      );

      let html = "";
      list.forEach(w => {
        const wallet =
          w.source === "bonus" ? "Bonus Wallet" : "Commission Wallet";
        let statusClass = "status-pending";
        if (w.status === "Paid") statusClass = "status-paid";
        if (w.status === "Rejected") statusClass = "status-reject";

        html += `
          <tr>
            <td>${w.name || ""}</td>
            <td>${w.mobile || ""}</td>
            <td class="num">₹${formatNumber(w.amount || 0)}</td>
            <td>${wallet}</td>
            <td><span class="status-pill ${statusClass}">${w.status}</span></td>
            <td>
              ${w.status === "Pending"
                ? `<button class="btn-secondary btn-small" onclick="approveWithdrawal(${w.id})">Approve</button>
                   <button class="btn-danger btn-small" onclick="rejectWithdrawal(${w.id})">Reject</button>`
                : `<span class="muted">—</span>`
              }
            </td>
          </tr>
        `;
      });

      if (!html) {
        html = `<tr><td colspan="6" class="muted">अभी कोई withdrawal request नहीं है।</td></tr>`;
      }

      tbody.innerHTML = html;
    }

    function approveWithdrawal(id) {
      const list = getWithdrawals();
      const idx = list.findIndex(w => w.id === id);
      if (idx === -1) return;
      list[idx].status = "Paid";
      saveWithdrawals(list);
      renderWithdrawals();
    }

    function rejectWithdrawal(id) {
      const list = getWithdrawals();
      const idx = list.findIndex(w => w.id === id);
      if (idx === -1) return;
      list[idx].status = "Rejected";
      saveWithdrawals(list);
      renderWithdrawals();
    }

    // ----------------- Init -----------------
    window.addEventListener("load", function () {
      renderCustomers();
      renderWithdrawals();
    });
  </script>
</body>
</html>
