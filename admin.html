<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>Binary Tree Admin Panel (RJVC Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    body{margin:0;background:#f2f5ff;}
    h1,h2,h3{margin:0 0 8px;}
    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:24px;max-width:480px;width:100%;}
    label{display:block;font-size:14px;margin-bottom:4px;}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #c5cbe3;font-size:15px;}
    input:focus{outline:none;border-color:#2952ff;box-shadow:0 0 0 2px rgba(41,82,255,.18);}
    .btn{border:none;border-radius:999px;padding:10px 18px;font-size:15px;font-weight:600;cursor:pointer;}
    .btn-primary{background:#2952ff;color:#fff;}
    .btn-secondary{background:#e2e7ff;color:#172554;}
    .btn-danger{background:#fee2e2;color:#991b1b;}
    .btn-sm{padding:6px 10px;font-size:12px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .flex{display:flex;}
    .between{justify-content:space-between;align-items:center;}
    .center{text-align:center;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{font-size:12px;text-transform:uppercase;color:#6b7280;}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#e5f3ff;color:#1d4ed8;}
    .wrap{max-width:1100px;width:100%;margin:24px auto;}
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px;margin-bottom:18px;}
    .tree-panel{background:#020617;color:#e5e7eb;border-radius:18px;padding:16px;margin-top:12px;}
    .tree-root-label{font-size:13px;color:#a5b4fc;margin-bottom:6px;}
    .wallets{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;}
    .wallet-box{flex:1 1 140px;background:#eff6ff;border-radius:14px;padding:10px 12px;}
    .wallet-title{font-size:12px;color:#4b5563;}
    .wallet-value{font-size:18px;font-weight:700;color:#1d4ed8;}
    .error{color:#dc2626;font-size:13px;margin-top:6px;}

    .tree-level{margin:8px 0;text-align:center;}
    .tree-node-wrap{display:inline-block;margin:6px;text-align:center;}
    .tree-node{
      padding:6px 10px;
      border-radius:12px;
      background:#111827;
      border:1px solid #4b5563;
      font-size:12px;
      min-width:120px;
    }
    .tree-node-main{background:#1d4ed8;border-color:#93c5fd;}
    .tree-node-name{font-weight:600;}
    .tree-node-meta{font-size:10px;color:#9ca3af;margin-top:2px;}
    .tree-node-actions{margin-top:6px;display:flex;gap:4px;justify-content:center;flex-wrap:wrap;}
    .tree-node-actions .btn-sm{padding:4px 6px;font-size:10px;}

    @media(max-width:720px){
      .wrap{padding:0 6px;}
      .panel{padding:12px;}
      table{font-size:12px;}
    }

    /* Weekly report */
    .grid2{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
    }
    .metric-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
    }
    .metric-box{
      border-radius:16px;
      color:#fff;
      padding:14px 16px;
    }
    .metric-title{font-size:13px;opacity:.95;margin-bottom:6px;}
    .metric-value{font-size:22px;font-weight:700;}
    .bg-blue{background:linear-gradient(135deg,#06b6d4,#0ea5e9);}
    .bg-orange{background:linear-gradient(135deg,#fb923c,#f97316);}
    .bg-green{background:linear-gradient(135deg,#22c55e,#16a34a);}
    .small{font-size:12px;color:#6b7280;margin-top:4px;}
    canvas{max-width:100%;}
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="page">
  <div class="card">
    <h1 class="center">Admin Login</h1>
    <p class="center" style="font-size:13px;color:#6b7280;margin-bottom:16px;">
      नीचे ID और Password डालें।
    </p>
    <label>Admin ID</label>
    <input id="adminId" placeholder="जैसे: admin" />
    <div class="mt-2"></div>
    <label>Password</label>
    <input id="adminPass" type="password" placeholder="जैसे: 1234" />
    <button class="btn btn-primary mt-3" style="width:100%;" onclick="handleAdminLogin()">
      Login
    </button>
    <div id="loginError" class="error" style="display:none;">गलत ID या Password</div>
    <p style="margin-top:12px;font-size:12px;color:#6b7280;">
      अभी के लिए default login: <b>ID: admin</b>, <b>Password: 1234</b><br/>
      (कोड में ऊपर बदल सकते हैं)
    </p>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" style="display:none;">
  <div class="wrap">
    <div class="panel flex between">
      <div>
        <h2>Binary Tree Admin (Firebase)</h2>
        <div style="font-size:13px;color:#4b5563;">
          हर customer 20₹ देता है, 2 members (1 pair) पर <b>3₹</b> binary earning auto calculate होगी।
        </div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- CREATE CUSTOMER ROOT -->
    <div class="panel">
      <h3>नया Customer बनाएं (Root level)</h3>
      <div class="flex" style="gap:10px;flex-wrap:wrap;margin-top:8px;">
        <div style="flex:1 1 200px;">
          <label>Customer Name</label>
          <input id="newName" placeholder="जैसे: Rajesh" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Customer Password (Login के लिए)</label>
          <input id="newPass" placeholder="जैसे: 1234" />
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="createRootCustomer()">
        Root में नया Customer जोड़ें
      </button>
      <p style="font-size:12px;color:#6b7280;margin-top:6px;">
        Root में नया customer add होगा। बाद में Tree view में किसी भी node पर 
        <b>+Member / Edit / Delete</b> से पूरा binary tree manage कर सकते हैं।
      </p>
    </div>

    <!-- CUSTOMER LIST -->
    <div class="panel">
      <div class="flex between">
        <h3>Customer List (Tree Nodes)</h3>
        <span class="badge" id="totalCustomersBadge">0 Customers</span>
      </div>
      <div class="wallets">
        <div class="wallet-box">
          <div class="wallet-title">कुल Pairs (पूरा Tree)</div>
          <div id="totalPairs" class="wallet-value">0</div>
        </div>
        <div class="wallet-box">
          <div class="wallet-title">कुल Commission (₹)</div>
          <div id="totalCommission" class="wallet-value">₹0</div>
        </div>
      </div>
      <div class="mt-3" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Members<br/>(नीचे)</th>
              <th>Pairs</th>
              <th>Commission<br/>(₹)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customerTableBody">
            <!-- JS से rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- TREE VIEW -->
    <div class="tree-panel">
      <div class="flex between">
        <div>
          <div class="tree-root-label">Binary Tree View</div>
          <div id="treeRootInfo" style="font-size:13px;margin-bottom:4px;">
            अभी कोई root select नहीं है।
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="showFullRootTree()">
          सिर्फ Root दिखाओ
        </button>
      </div>
      <div id="treeViewArea" style="margin-top:10px;font-size:12px;">
        अभी tree खाली है।
      </div>
    </div>

    <!-- WEEKLY BUSINESS REPORT (SUNDAY + WEDNESDAY) -->
    <div class="panel">
      <h3>Weekly Binary Business Report</h3>
      <div class="grid2">
        <div>
          <h4>Sunday (रविवार)</h4>
          <label>Income from Package Sale (₹)</label>
          <input id="sunIncome" type="number" placeholder="जैसे: 3000" />
          <label style="margin-top:8px;">Total Binary Pairs Income (Members को दिया) (₹)</label>
          <input id="sunMemberIncome" type="number" placeholder="जैसे: 1200" />
        </div>
        <div>
          <h4>Wednesday (बुधवार)</h4>
          <label>Income from Package Sale (₹)</label>
          <input id="wedIncome" type="number" placeholder="जैसे: 2100" />
          <label style="margin-top:8px;">Total Binary Pairs Income (Members को दिया) (₹)</label>
          <input id="wedMemberIncome" type="number" placeholder="जैसे: 1107" />
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculateWeekly()">
        Calculate Weekly Report (Firebase Save)
      </button>
      <div class="small">
        हर दिन Company Profit = Income − Members को दी गई binary income.  
        Weekly Profit = Sunday Profit + Wednesday Profit.
      </div>
    </div>

    <!-- WEEKLY OUTPUT + CHART -->
    <div class="panel">
      <h3>Weekly Result & Business Chart</h3>
      <div class="metric-grid">
        <div class="metric-box bg-blue">
          <div class="metric-title">Sunday Profit (Company)</div>
          <div class="metric-value" id="sunProfit">₹0</div>
        </div>
        <div class="metric-box bg-blue">
          <div class="metric-title">Wednesday Profit (Company)</div>
          <div class="metric-value" id="wedProfit">₹0</div>
        </div>
        <div class="metric-box bg-blue">
          <div class="metric-title">Total Weekly Income (Sun+Wed)</div>
          <div class="metric-value" id="weekIncome">₹0</div>
        </div>
        <div class="metric-box bg-orange">
          <div class="metric-title">Total Binary Pairs Income (Members को दिया)</div>
          <div class="metric-value" id="weekMembersIncome">₹0</div>
        </div>
        <div class="metric-box bg-green">
          <div class="metric-title">Total Weekly Company Profit</div>
          <div class="metric-value" id="weekProfit">₹0</div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <canvas id="weeklyChart" height="220"></canvas>
      </div>
    </div>

  </div>
</div>

<!-- Firebase + Chart.js -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  /************ Firebase Config (RJVC PLAN) ************/
  const firebaseConfig = {
    apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
    authDomain: "rjvc-plan.firebaseapp.com",
    projectId: "rjvc-plan",
    storageBucket: "rjvc-plan.firebasestorage.app",
    messagingSenderId: "265431528728",
    appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d",
    measurementId: "G-1Y7PN96H93"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const treeCol   = db.collection("TreeNodes");
  const weeklyCol = db.collection("WeeklyReports");

  /************ ADMIN LOGIN CONFIG ************/
  const ADMIN_ID = "admin";
  const ADMIN_PASSWORD = "1234";

  /************ DATA STRUCTURE (memory में) ************/
  let nodes = {};      // id -> node
  let rootId = null;   // parentId == null
  let currentTreeRootId = null;

  function createNodeObj(id, data){
    return {
      id,
      name: data.name || "",
      password: data.password || "",
      left: data.leftChildId || null,
      right: data.rightChildId || null,
      parent: data.parentId || null,
      members: data.members || 0,
      pairs: data.pairs || 0,
      commission: data.commission || 0
    };
  }

  /************ LOGIN ************/
  async function handleAdminLogin() {
    const id = document.getElementById("adminId").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    const err = document.getElementById("loginError");

    if (id === ADMIN_ID && pass === ADMIN_PASSWORD) {
      err.style.display = "none";
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("adminPage").style.display = "block";
      await loadDataFromFirebase();
      await loadWeeklyFromFirebase();
    } else {
      err.style.display = "block";
    }
  }

  function logout() {
    document.getElementById("adminPage").style.display = "none";
    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("adminPass").value = "";
  }

  /************ LOAD TREE FROM FIREBASE ************/
  async function loadDataFromFirebase(){
    nodes = {};
    rootId = null;
    try{
      const snap = await treeCol.get();
      snap.forEach(doc=>{
        const data = doc.data();
        nodes[doc.id] = createNodeObj(doc.id, data);
      });
      // root = कोई भी node जिसका parentId null है
      Object.values(nodes).forEach(n=>{
        if(!n.parent && !rootId){ rootId = n.id; }
      });
      recalcAll();   // members, pairs, commission calculate + save
      renderTable();
      renderTree();
    }catch(err){
      console.error("loadData error:", err);
      alert("Tree load error: " + err.message);
    }
  }

  /************ SAVE ONE NODE TO FIREBASE ************/
  async function saveNodeToFirebase(nodeId){
    const n = nodes[nodeId];
    if(!n) return;
    const payload = {
      name: n.name,
      password: n.password,
      parentId: n.parent || null,
      leftChildId: n.left || null,
      rightChildId: n.right || null,
      members: n.members || 0,
      pairs: n.pairs || 0,
      commission: n.commission || 0
    };
    await treeCol.doc(nodeId).set(payload, { merge:true });
  }

  /************ CREATE ROOT CUSTOMER ************/
  async function createRootCustomer() {
    const name = document.getElementById("newName").value.trim();
    const pass = document.getElementById("newPass").value.trim();
    if (!name || !pass) {
      alert("Name और Password दोनों भरें");
      return;
    }

    try{
      const docRef = await treeCol.add({
        name,
        password: pass,
        parentId: null,
        leftChildId: null,
        rightChildId: null,
        members: 0,
        pairs: 0,
        commission: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("newName").value = "";
      document.getElementById("newPass").value = "";
      await loadDataFromFirebase();
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  /************ ADD MEMBER ************/
  async function addMember(parentId, side) {
    const parent = nodes[parentId];
    if (!parent) {
      alert("Parent नहीं मिला");
      return;
    }

    const name = prompt("नया member का नाम?");
    if (!name) return;
    const pass = prompt("उसका login password?");
    if (!pass) return;

    try{
      // नया node Firestore में बनाओ
      const newDocRef = await treeCol.add({
        name,
        password: pass,
        parentId: parentId,
        leftChildId: null,
        rightChildId: null,
        members: 0,
        pairs: 0,
        commission: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      const newId = newDocRef.id;

      // memory में node
      nodes[newId] = createNodeObj(newId, {
        name,
        password: pass,
        parentId: parentId
      });

      const existingChildId = parent[side];

      // parent -> new child
      parent[side] = newId;
      nodes[parentId] = parent;
      await saveNodeToFirebase(parentId);

      if (existingChildId) {
        // पुराना child अब new node का left बनाओ
        const existingChild = nodes[existingChildId];
        nodes[newId].left = existingChildId;
        existingChild.parent = newId;
        await saveNodeToFirebase(existingChildId);
        await saveNodeToFirebase(newId);
      }

      await loadDataFromFirebase();
      currentTreeRootId = parentId;
      renderTree();
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  function treeAddMember(parentId) {
    const choice = prompt("किस side जोड़ना है? Left = L या 1, Right = R या 2");
    if (!choice) return;
    const c = choice.trim().toLowerCase();
    let side = null;
    if (c === "l" || c === "1") side = "left";
    else if (c === "r" || c === "2") side = "right";
    else {
      alert("गलत choice, L/1 या R/2 लिखें");
      return;
    }
    addMember(parentId, side);
  }

  /************ EDIT / DELETE ************/
  async function editCustomer(id) {
    const n = nodes[id];
    if (!n) return;
    const newName = prompt("नया नाम?", n.name);
    if (!newName) return;
    n.name = newName;
    nodes[id] = n;
    await saveNodeToFirebase(id);
    recalcAll();
    renderTable();
    renderTree();
  }

  async function deleteCustomer(id) {
    const n = nodes[id];
    if (!n) return;
    if (!confirm(`क्या आप "${n.name}" को delete करना चाहते हैं? उसके नीचे का सारा subtree भी delete होगा।`)) {
      return;
    }

    try{
      // अगर root delete कर रहे हैं
      if (rootId === id) {
        // पूरा TreeNodes collection साफ़ करना dangerous है,
        // इस code में सिर्फ उसी subtree को delete करेंगे:
        await deleteSubTreeFirebase(id);
        nodes = {};
        rootId = null;
        currentTreeRootId = null;
        renderTable();
        renderTree();
        return;
      }

      // parent से link हटाओ
      const pId = n.parent;
      if (pId && nodes[pId]) {
        const p = nodes[pId];
        if (p.left === id) p.left = null;
        if (p.right === id) p.right = null;
        nodes[pId] = p;
        await saveNodeToFirebase(pId);
      }

      await deleteSubTreeFirebase(id);
      await loadDataFromFirebase();
    }catch(err){
      alert("Error: " + err.message);
    }
  }

  async function deleteSubTreeFirebase(nodeId){
    const node = nodes[nodeId];
    if (!node) return;
    if (node.left)  await deleteSubTreeFirebase(node.left);
    if (node.right) await deleteSubTreeFirebase(node.right);
    delete nodes[nodeId];
    await treeCol.doc(nodeId).delete();
  }

  /************ CALCULATIONS ************/
  function countDesc(nodeId) {
    const node = nodes[nodeId];
    if (!node) return 0;
    let c = 0;
    if (node.left)  c += 1 + countDesc(node.left);
    if (node.right) c += 1 + countDesc(node.right);
    return c;
  }

  async function recalcAll() {
    let totalPairs = 0;
    let totalComm = 0;
    const updatePromises = [];

    Object.values(nodes).forEach(node => {
      const members = countDesc(node.id);
      const pairs = Math.floor(members / 2);
      const commission = pairs * 3;   // 3₹ per pair

      node.members = members;
      node.pairs = pairs;
      node.commission = commission;

      nodes[node.id] = node;

      totalPairs += pairs;
      totalComm += commission;

      // Firestore में भी update
      updatePromises.push(
        treeCol.doc(node.id).set({
          members,
          pairs,
          commission
        }, { merge:true })
      );
    });

    try{
      if(updatePromises.length){
        await Promise.all(updatePromises);
      }
    }catch(err){
      console.warn("recalcAll update error:", err);
    }

    document.getElementById("totalPairs").textContent = totalPairs;
    document.getElementById("totalCommission").textContent = "₹" + totalComm;
  }

  /************ TABLE RENDER ************/
  function renderTable() {
    const tbody = document.getElementById("customerTableBody");
    tbody.innerHTML = "";
    const list = Object.values(nodes);
    list.sort((a,b)=>a.name.localeCompare(b.name));

    document.getElementById("totalCustomersBadge").textContent =
      list.length + " Customers";

    list.forEach((node, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${node.name}</td>
        <td>${node.members}</td>
        <td>${node.pairs}</td>
        <td>₹${node.commission}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="viewTreeFrom('${node.id}')">Tree</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${node.id}')">Del</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  /************ TREE VIEW ************/
  function viewTreeFrom(id) {
    currentTreeRootId = id;
    renderTree();
  }

  function showFullRootTree() {
    currentTreeRootId = rootId;
    renderTree();
  }

  function renderTree() {
    const area = document.getElementById("treeViewArea");
    const info = document.getElementById("treeRootInfo");

    if (!Object.keys(nodes).length) {
      info.textContent = "Tree खाली है। पहले कोई customer जोड़ें।";
      area.textContent = "";
      return;
    }
    const startId = currentTreeRootId || rootId;
    const startNode = nodes[startId];
    if (!startNode) {
      info.textContent = "Tree root नहीं मिला।";
      area.textContent = "";
      return;
    }

    info.innerHTML = `अभी tree <b>${startNode.name}</b> से शुरू हो रहा है 
      (Members: ${startNode.members}, Pairs: ${startNode.pairs}, Commission: ₹${startNode.commission})`;

    let html = "";
    function buildLevel(ids) {
      if (!ids.length) return;
      html += `<div class="tree-level">`;
      ids.forEach(id => {
        const n = nodes[id];
        if (!n) return;
        const isRoot = (!nodes[n.parent]); // सबसे ऊपर वाला
        html += `
          <div class="tree-node-wrap">
            <div class="tree-node ${isRoot ? "tree-node-main":""}">
              <div class="tree-node-name">${n.name}</div>
              <div class="tree-node-meta">
                M:${n.members} · P:${n.pairs} · ₹${n.commission}
              </div>
              <div class="tree-node-actions">
                <button class="btn btn-secondary btn-sm" onclick="treeAddMember('${n.id}')">+Member</button>
                <button class="btn btn-secondary btn-sm" onclick="editCustomer('${n.id}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${n.id}')">Del</button>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;

      const next = [];
      ids.forEach(id=>{
        const n = nodes[id];
        if (!n) return;
        if (n.left)  next.push(n.left);
        if (n.right) next.push(n.right);
      });
      if (next.length) buildLevel(next);
    }

    buildLevel([startId]);
    area.innerHTML = html;
  }

  /************ WEEKLY BUSINESS (FIREBASE) ************/
  let weeklyChart = null;

  function formatINR(value){
    value = Number(value) || 0;
    return value.toLocaleString("en-IN",{maximumFractionDigits:0});
  }

  async function loadWeeklyFromFirebase(){
    try{
      const doc = await weeklyCol.doc("current").get();
      if(doc.exists){
        const d = doc.data();
        document.getElementById("sunIncome").value       = d.sunIncome       || 0;
        document.getElementById("sunMemberIncome").value = d.sunMemberIncome || 0;
        document.getElementById("wedIncome").value       = d.wedIncome       || 0;
        document.getElementById("wedMemberIncome").value = d.wedMemberIncome || 0;
      }else{
        // पहली बार demo values
        document.getElementById("sunIncome").value       = 3000;
        document.getElementById("sunMemberIncome").value = 1200;
        document.getElementById("wedIncome").value       = 2100;
        document.getElementById("wedMemberIncome").value = 1107;
      }
      calculateWeekly(false); // सिर्फ calculate, अभी save नहीं
    }catch(err){
      console.warn("Weekly load error:", err);
    }
  }

  async function calculateWeekly(saveToFirebase = true){
    const sunIncome       = Number(document.getElementById("sunIncome").value)       || 0;
    const sunMemberIncome = Number(document.getElementById("sunMemberIncome").value) || 0;
    const wedIncome       = Number(document.getElementById("wedIncome").value)       || 0;
    const wedMemberIncome = Number(document.getElementById("wedMemberIncome").value) || 0;

    const sunProfit = sunIncome - sunMemberIncome;
    const wedProfit = wedIncome - wedMemberIncome;

    const weekIncome        = sunIncome + wedIncome;
    const weekMembersIncome = sunMemberIncome + wedMemberIncome;
    const weekProfit        = sunProfit + wedProfit;

    document.getElementById("sunProfit").textContent        = "₹" + formatINR(sunProfit);
    document.getElementById("wedProfit").textContent        = "₹" + formatINR(wedProfit);
    document.getElementById("weekIncome").textContent       = "₹" + formatINR(weekIncome);
    document.getElementById("weekMembersIncome").textContent= "₹" + formatINR(weekMembersIncome);
    document.getElementById("weekProfit").textContent       = "₹" + formatINR(weekProfit);

    updateWeeklyChart(
      sunIncome, sunMemberIncome, sunProfit,
      wedIncome, wedMemberIncome, wedProfit
    );

    if(saveToFirebase){
      try{
        await weeklyCol.doc("current").set({
          sunIncome,
          sunMemberIncome,
          wedIncome,
          wedMemberIncome,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(err){
        alert("Weekly save error: " + err.message);
      }
    }
  }

  function updateWeeklyChart(
    sunIncome, sunMemberIncome, sunProfit,
    wedIncome, wedMemberIncome, wedProfit
  ){
    const ctx = document.getElementById("weeklyChart").getContext("2d");

    const labels = ["Sunday","Wednesday"];
    const incomeData = [sunIncome,       wedIncome];
    const memberData = [sunMemberIncome, wedMemberIncome];
    const profitData = [sunProfit,       wedProfit];

    if(weeklyChart){
      weeklyChart.data.labels = labels;
      weeklyChart.data.datasets[0].data = incomeData;
      weeklyChart.data.datasets[1].data = memberData;
      weeklyChart.data.datasets[2].data = profitData;
      weeklyChart.update();
      return;
    }

    weeklyChart = new Chart(ctx,{
      type:"bar",
      data:{
        labels:labels,
        datasets:[
          {label:"Income",         data:incomeData},
          {label:"Members Income", data:memberData},
          {label:"Company Profit", data:profitData}
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{
            beginAtZero:true,
            ticks:{
              callback:function(value){ return "₹"+formatINR(value); }
            }
          }
        },
        plugins:{
          legend:{position:"bottom"},
          tooltip:{
            callbacks:{
              label:function(ctx){
                return ctx.dataset.label + ": ₹" + formatINR(ctx.parsed.y);
              }
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
