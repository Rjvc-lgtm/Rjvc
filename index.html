<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>RJVC Binary Tree Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      background:#020617;
      color:#e5e7eb;
      font-family:system-ui;
    }
    .wrap{max-width:1200px;margin:auto;padding:12px;}
    .loginCard{
      max-width:420px;
      margin:80px auto;
      background:#071028;
      padding:18px;
      border-radius:12px;
    }
    input,select{
      width:100%;
      padding:10px;
      margin-top:6px;
      border-radius:6px;
      border:none;
    }
    button{
      margin-top:12px;
      padding:10px;
      width:100%;
      border:none;
      border-radius:20px;
      background:#2563eb;
      color:white;
      font-weight:600;
      cursor:pointer;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .canvas-wrap{
      margin-top:20px;
      display:flex;
      justify-content:center;
    }
  </style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="wrap">
  <div class="loginCard">
    <h2 style="text-align:center">Admin Login</h2>

    <label>Admin ID</label>
    <input id="adminId" value="admin">

    <label>Password</label>
    <input id="adminPass" type="password" value="1234">

    <button onclick="handleAdminLogin()">Login</button>

    <div id="loginError" style="color:red;display:none;text-align:center;margin-top:8px">
      Wrong ID or Password
    </div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" style="display:none">
  <div class="wrap">

    <div class="topbar">
      <h2>Binary Tree (Firebase)</h2>
      <button onclick="logout()" style="width:auto;padding:6px 16px">Logout</button>
    </div>

    <!-- ADD USER FORM -->
    <div style="margin:12px 0;display:flex;gap:8px;flex-wrap:wrap">
      <input id="newName" placeholder="User Name">
      <select id="parentId"></select>
      <select id="newPosition">
        <option value="left">Left</option>
        <option value="right">Right</option>
      </select>
      <button onclick="addUser()" style="width:auto;padding:8px 16px">Add User</button>
    </div>

    <!-- TREE -->
    <div class="canvas-wrap">
      <canvas id="treeCanvas" width="1200" height="520"></canvas>
    </div>

  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
    authDomain: "rjvc-plan.firebaseapp.com",
    projectId: "rjvc-plan"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function handleAdminLogin(){
    if(adminId.value==="admin" && adminPass.value==="1234"){
      loginPage.style.display="none";
      adminPage.style.display="block";
      loadTreeFromFirebase();
      loadParentsDropdown();
    }else{
      loginError.style.display="block";
    }
  }

  function logout(){
    adminPage.style.display="none";
    loginPage.style.display="block";
  }

  async function loadTreeFromFirebase(){
    const snap = await db.collection("users").get();
    const users = {};
    snap.forEach(d=>users[d.id]=d.data());
    drawFirebaseTree(users);
  }

  function drawFirebaseTree(users){
    const c = treeCanvas;
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle="#2563eb";
    ctx.strokeStyle="#94a3b8";
    ctx.textAlign="center";
    ctx.textBaseline="middle";

    const rootId = Object.keys(users).find(id=>users[id].position==="root");
    if(!rootId){ alert("Root not found"); return; }

    drawNodeAt(rootId,600,80);

    function drawNodeAt(id,x,y){
      const u = users[id];
      drawNode(x,y,u.name);

      Object.keys(users).forEach(cid=>{
        if(users[cid].parent===id){
          const off = users[cid].position==="left"?-200:200;
          const nx=x+off, ny=y+120;
          drawLine(x,y+26,nx,ny-26);
          drawNodeAt(cid,nx,ny);
        }
      });
    }
  }

  function drawNode(x,y,t){
    const ctx = treeCanvas.getContext("2d");
    ctx.beginPath();
    ctx.arc(x,y,26,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle="#fff";
    ctx.fillText(t,x,y);
    ctx.fillStyle="#2563eb";
  }

  function drawLine(x1,y1,x2,y2){
    const ctx = treeCanvas.getContext("2d");
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }

  async function loadParentsDropdown(){
    parentId.innerHTML="";
    const snap = await db.collection("users").get();
    snap.forEach(d=>{
      const o=document.createElement("option");
      o.value=d.id;
      o.textContent=d.data().name+" ("+d.id+")";
      parentId.appendChild(o);
    });
  }

  async function addUser(){
    if(!newName.value) return alert("Name required");

    const id="u"+Date.now();
    await db.collection("users").doc(id).set({
      name:newName.value,
      parent:parentId.value,
      position:newPosition.value
    });

    newName.value="";
    loadTreeFromFirebase();
    loadParentsDropdown();
  }
</script>

</body>
</html>
