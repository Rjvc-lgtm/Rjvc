<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Smart Earning – Customer Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #e6ebff;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .top-bar a {
      color: #0d47a1;
      text-decoration: none;
      font-weight: 600;
    }

    h1 {
      margin: 0;
      font-size: 16px;
      color: #102a6b;
    }
    h2 {
      margin: 10px 0 4px;
      font-size: 18px;
      color: #102a6b;
    }
    .subtitle {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
    }
    .small {
      font-size: 11px;
      color: #777;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .col {
      flex: 1 1 150px;
    }

    button {
      border: none;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 8px;
    }
    .btn-primary {
      background: #0066ff;
      color: white;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }
    .btn-danger {
      background: #ffebee;
      color: #b71c1c;
    }

    .section-card {
      margin-top: 12px;
      padding: 10px 10px 12px;
      border-radius: 12px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }

    .wallet-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f5f0ff;
      border: 1px solid #d6c6ff;
      font-size: 13px;
    }

    /* ====== Wallets को बड़ा और हाइलाइटेड दिखाने के लिए ====== */
    .wallet-values {
      display: flex;
      flex-direction: column;   /* एक के नीचे एक */
      gap: 10px;
      margin-top: 10px;
    }

    .wallet-pill {
      padding: 12px 16px;       /* बड़ा padding */
      border-radius: 14px;
      background: #111827;
      border: 1px solid #4f46e5;
      font-size: 18px;          /* बड़ा font */
      font-weight: 700;         /* मोटा text */
      color: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* अलग-अलग रंग Commission / Bonus / Total के लिए */
    #pillCommission {
      background: #14532d;      /* गहरा हरा */
      border-color: #22c55e;
    }
    #pillBonus {
      background: #7c2d12;      /* गहरा ब्राउन/ऑरेंज */
      border-color: #fdba74;
    }
    #pillTotal {
      background: #1e293b;      /* गहरा ब्लू-ग्रे */
      border-color: #38bdf8;
    }

    .menu-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 4px;
    }
    .menu-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      background: #f0f2ff;
      border: 1px solid #ccd2ff;
      color: #102a6b;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .menu-btn span.icon {
      font-size: 15px;
    }

    .bank-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f2fffb;
      border: 1px solid #bfeeda;
      font-size: 12px;
    }
    .bank-card h3 {
      margin-top: 0;
      font-size: 14px;
      margin-bottom: 4px;
      color: #035b3c;
    }
    .badge-saved,
    .badge-not {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
    }
    .badge-saved {
      background: #d9f7be;
      color: #135200;
    }
    .badge-not {
      background: #fff1f0;
      color: #a8071a;
    }
    .text-muted {
      font-size: 11px;
      color: #666;
    }

    .card {
      margin-top: 14px;
      padding: 10px;
      border-radius: 12px;
      background: #fff7e6;
      border: 1px solid #ffe0a3;
      font-size: 13px;
      white-space: pre-line;
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <!-- RJVC GOLDEN-BLACK BANNER -->
  <div style="width:100%; text-align:center;">
    <img src="https://raw.githubusercontent.com/Rjvc-lgtm/Rjvc/refs/heads/main/file_0000000021547209af0c0dab6fb5e932.png"
         alt="RJVC Banner" 
         style="width:100%; max-width:500px; display:block; margin:auto; border-radius:0 0 20px 20px;">
  </div>

  <div class="app">
    <div class="top-bar">
      <h1>RJVC Customer Panel</h1>
      <a href="javascript:void(0)" onclick="logout()">Logout</a>
    </div>

    <!-- BANK / WITHDRAWAL MENU BUTTON -->
    <div class="menu-row">
      <button class="menu-btn" onclick="toggleBankSection()">
        <span class="icon">☰</span>
        Bank / Withdrawal Details
      </button>
    </div>

    <!-- CUSTOMER DETAILS (read-only, login से आएँगे) -->
    <div class="section-card">
      <h2>Customer Details</h2>
      <div class="subtitle">
        यहाँ आपके RJVC ID की जानकारी है। यह data admin panel से auto आता है।
      </div>
      <div class="small">
        नाम: <b id="custName">-</b><br>
        Main RJVC ID: <b id="custMainId">-</b><br>
        Mobile (पेमेण्ट / contact के लिए): <b id="custMobile">-</b>
      </div>
    </div>

    <!-- WALLET / TRANSFER SECTION -->
    <div class="wallet-card">
      <div class="card-title">RJVC Wallets & Mobile Transfer</div>
      <div id="walletInfo" class="subtitle">
        Loading...
      </div>

      <div class="wallet-values">
        <div class="wallet-pill" id="pillCommission">
          <span>Commission Wallet</span>
          <span id="pillCommissionValue">₹0</span>
        </div>
        <div class="wallet-pill" id="pillBonus">
          <span>Bonus Wallet</span>
          <span id="pillBonusValue">₹0</span>
        </div>
        <div class="wallet-pill" id="pillTotal">
          <span>Total (Commission + Bonus)</span>
          <span id="pillTotalValue">₹0</span>
        </div>
      </div>

      <div class="small" style="margin-top:6px;">
        • Commission Wallet – Binary / Direct earning यहाँ आती है।  
        • Bonus Wallet – Sub IDs से आने वाला bonus + admin द्वारा दी गई bonus entry।  
        • Bonus Wallet से हर महीने withdrawal किया जा सकता है (admin approval के बाद)।  
      </div>

      <div style="border-top:1px dashed #c0b2ff; margin:10px 0 8px;"></div>

      <div class="small" style="margin-bottom:4px;">
        नीचे से आप Commission Wallet का पैसा किसी दूसरे mobile की Commission Wallet में transfer कर सकते हैं।  
        इस transfer के लिए admin approval की ज़रूरत नहीं है (सिर्फ mobile-to-mobile balance move होगा)।
      </div>

      <div class="row">
        <div class="col">
          <label>Transfer To Mobile (सिर्फ Commission Wallet से)</label>
          <input id="transferToMobile" type="tel" placeholder="जैसे: 98xxxxxxxx" />
        </div>
        <div class="col">
          <label>Amount to Transfer (₹)</label>
          <input id="transferAmount" type="number" min="0" value="0" />
        </div>
      </div>
      <button class="btn-secondary" onclick="transferCommission()">Transfer Commission</button>
    </div>

    <!-- BANK / WITHDRAWAL SECTION (toggle) -->
    <div id="bankSection" class="bank-card" style="display:none;">
      <h3>
        Bank / Withdrawal Details
        <span id="bankStatusBadge" class="badge-not">Details not saved</span>
      </h3>
      <div class="row">
        <div class="col">
          <label>Account Holder Name</label>
          <input id="bank_holder" type="text" placeholder="Account पर लिखा नाम" />
        </div>
        <div class="col">
          <label>Bank Name</label>
          <input id="bank_name" type="text" placeholder="जैसे: SBI / HDFC" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Account Number</label>
          <input id="bank_account" type="text" placeholder="Account Number" />
        </div>
        <div class="col">
          <label>IFSC Code</label>
          <input id="bank_ifsc" type="text" placeholder="जैसे: SBIN0001234" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>UPI ID (optional)</label>
          <input id="bank_upi" type="text" placeholder="जैसे: number@upi" />
        </div>
      </div>

      <div style="border-top:1px dashed #bfeeda; margin:8px 0;"></div>

      <div class="row">
        <div class="col">
          <label>Withdrawal Amount (₹)</label>
          <input id="withdrawAmount" type="number" min="0" value="0" />
        </div>
        <div class="col">
          <label>Amount किस wallet से काटें?</label>
          <select id="withdrawSource">
            <option value="commission">Commission Wallet</option>
            <option value="bonus">Bonus Wallet</option>
          </select>
        </div>
      </div>
      <button class="btn-primary" onclick="requestWithdrawal()">Request Bank Withdrawal</button>

      <div class="text-muted" style="margin-top:6px;">
        • यह details सिर्फ आपके इस mobile / browser में सुरक्षित रहेंगी।  
        • Withdrawal request admin panel में जाएगी – वहाँ से <b>Approve</b> होने पर ही payment होगा।  
        • Bonus Wallet का पैसा mobile-to-mobile transfer नहीं हो सकता, सिर्फ withdrawal के लिए है।
      </div>
      <div id="bankSummary" class="text-muted" style="margin-top:4px;"></div>
    </div>

    <!-- SUMMARY CARD -->
    <div class="card">
      <div class="card-title">Your Earning Summary</div>
      <div id="summaryText">
        Login के बाद यह जगह आपकी current earning और wallets का short report दिखाएगी।
      </div>
    </div>
  </div>

  <script>
    const ADMIN_CUSTOMER_KEY = "rjvc_admin_customers";
    const WITHDRAWAL_KEY = "rjvc_withdrawals";

    let currentCustomer = null;

    function formatNumber(n) {
      return Number(n || 0).toLocaleString("en-IN");
    }

    // ------------ LOGIN HANDLING / LOAD CUSTOMER -------------
    function loadLoggedInCustomer() {
      const role = localStorage.getItem("rjvc_logged_in_role");
      const idStr = localStorage.getItem("rjvc_current_customer_id");

      if (role !== "customer" || !idStr) {
        window.location.href = "login.html";
        return;
      }

      let customers = [];
      try {
        customers = JSON.parse(localStorage.getItem(ADMIN_CUSTOMER_KEY) || "[]");
      } catch (e) {
        customers = [];
      }

      const cust = customers.find(c => String(c.id) === String(idStr));
      if (!cust) {
        window.location.href = "login.html";
        return;
      }

      currentCustomer = cust;

      document.getElementById("custName").innerText = cust.name || "-";
      document.getElementById("custMobile").innerText = cust.mobile || "-";
      document.getElementById("custMainId").innerText = cust.mainId || (cust.rjvcId || "-");

      refreshWalletInfo();
      loadBankDetails();
      renderSummary();
    }

    function logout() {
      localStorage.removeItem("rjvc_logged_in_role");
      localStorage.removeItem("rjvc_current_customer_id");
      window.location.href = "login.html";
    }

    // ------------ WALLET HELPERS -------------

    function getCommissionWallet(c) {
      if (!c) return 0;
      if (typeof c.walletCommission !== "undefined") return Number(c.walletCommission || 0);
      if (typeof c.commissionWallet !== "undefined") return Number(c.commissionWallet || 0);
      return Number(c.wallet || 0);
    }

    function setCommissionWallet(c, value) {
      if (!c) return;
      if (typeof c.walletCommission !== "undefined") {
        c.walletCommission = value;
      } else if (typeof c.commissionWallet !== "undefined") {
        c.commissionWallet = value;
      } else {
        c.wallet = value;
      }
    }

    function getBonusWallet(c) {
      if (!c) return 0;
      if (typeof c.walletBonus !== "undefined") return Number(c.walletBonus || 0);
      if (typeof c.bonusWallet !== "undefined") return Number(c.bonusWallet || 0);
      return 0;
    }

    function setBonusWallet(c, value) {
      if (!c) return;
      if (typeof c.walletBonus !== "undefined") {
        c.walletBonus = value;
      } else {
        c.bonusWallet = value;
      }
    }

    function saveCurrentCustomer() {
      if (!currentCustomer) return;
      let customers = [];
      try {
        customers = JSON.parse(localStorage.getItem(ADMIN_CUSTOMER_KEY) || "[]");
      } catch (e) {
        customers = [];
      }
      const idx = customers.findIndex(c => String(c.id) === String(currentCustomer.id));
      if (idx !== -1) {
        customers[idx] = currentCustomer;
        localStorage.setItem(ADMIN_CUSTOMER_KEY, JSON.stringify(customers));
      }
    }

    function refreshWalletInfo() {
      if (!currentCustomer) return;

      const cWallet = getCommissionWallet(currentCustomer);
      const bWallet = getBonusWallet(currentCustomer);
      const total = cWallet + bWallet;

      const walletInfo = document.getElementById("walletInfo");
      walletInfo.textContent =
        (currentCustomer.name ? (currentCustomer.name + " जी, ") : "") +
        "नीचे आपके RJVC wallets का balance दिया गया है। Commission / Bonus admin side से auto update होता है।";

      document.getElementById("pillCommissionValue").innerText = "₹" + formatNumber(cWallet);
      document.getElementById("pillBonusValue").innerText = "₹" + formatNumber(bWallet);
      document.getElementById("pillTotalValue").innerText = "₹" + formatNumber(total);
    }

    function renderSummary() {
      if (!currentCustomer) return;

      const cWallet = getCommissionWallet(currentCustomer);
      const bWallet = getBonusWallet(currentCustomer);
      const total = cWallet + bWallet;

      const summaryDiv = document.getElementById("summaryText");
      let txt = "";

      txt += (currentCustomer.name || "आप") + " जी,\n\n";
      txt += "आपके RJVC ID (" + (currentCustomer.mainId || currentCustomer.rjvcId || "-") + ") के लिए:\n";
      txt += "• Commission Wallet: ₹" + formatNumber(cWallet) + "\n";
      txt += "• Bonus Wallet: ₹" + formatNumber(bWallet) + "\n";
      txt += "• कुल उपलब्ध balance: ₹" + formatNumber(total) + "\n\n";
      txt += "Binary pair / sub ID की पूरी calculation admin panel से होती है। "
          + "यहाँ आप सिर्फ अपना balance देख सकते हैं, withdrawal request कर सकते हैं "
          + "या Commission Wallet का कुछ हिस्सा दूसरे mobile की Commission Wallet में transfer कर सकते हैं।";

      summaryDiv.innerText = txt;
    }

    // ------------ MOBILE TRANSFER (Commission Wallet only) -------------

    function transferCommission() {
      if (!currentCustomer) {
        alert("पहले login करें।");
        return;
      }

      const fromMobile = currentCustomer.mobile || "";
      const toMobile = (document.getElementById("transferToMobile").value || "").trim();
      const amount = parseFloat(document.getElementById("transferAmount").value || "0");

      if (!toMobile) {
        alert("जिस mobile पर भेजना है, वो नंबर भरें।");
        return;
      }
      if (fromMobile && fromMobile === toMobile) {
        alert("खुद के mobile पर transfer की जरूरत नहीं है।");
        return;
      }
      if (amount <= 0) {
        alert("Valid transfer amount दर्ज करें।");
        return;
      }

      let customers = [];
      try {
        customers = JSON.parse(localStorage.getItem(ADMIN_CUSTOMER_KEY) || "[]");
      } catch (e) {
        customers = [];
      }

      const fromIdx = customers.findIndex(c => String(c.id) === String(currentCustomer.id));
      if (fromIdx === -1) {
        alert("आपके लिए कोई wallet record नहीं मिला (admin से contact करें)।");
        return;
      }

      const fromCust = customers[fromIdx];
      let fromWallet = getCommissionWallet(fromCust);

      if (fromWallet < amount) {
        alert("आपके Commission Wallet में इतना balance नहीं है।\nCurrent balance: ₹" + formatNumber(fromWallet));
        return;
      }

      const toIdx = customers.findIndex(c => String(c.mobile) === toMobile);
      if (toIdx === -1) {
        alert("जिस mobile पर भेजना है, उस mobile के लिए कोई customer नहीं मिला (admin पहले customer create करे)।");
        return;
      }

      const toCust = customers[toIdx];

      fromWallet -= amount;
      let toWallet = getCommissionWallet(toCust) + amount;

      setCommissionWallet(fromCust, fromWallet);
      setCommissionWallet(toCust, toWallet);

      customers[fromIdx] = fromCust;
      customers[toIdx] = toCust;
      localStorage.setItem(ADMIN_CUSTOMER_KEY, JSON.stringify(customers));

      if (String(currentCustomer.id) === String(fromCust.id)) {
        currentCustomer = fromCust;
      }

      alert("₹" + formatNumber(amount) + " सफलतापूर्वक " + toMobile + " की Commission Wallet में transfer कर दिया गया है।");
      document.getElementById("transferAmount").value = "0";
      refreshWalletInfo();
      renderSummary();
    }

    // ------------ BANK DETAILS / WITHDRAWAL -------------

    function toggleBankSection() {
      const sec = document.getElementById("bankSection");
      if (sec.style.display === "none" || !sec.style.display) {
        sec.style.display = "block";
      } else {
        sec.style.display = "none";
      }
    }

    function bankStorageKey() {
      if (!currentCustomer) return "rjvc_bank_details";
      return "rjvc_bank_details_" + String(currentCustomer.id);
    }

    function loadBankDetails() {
      const key = bankStorageKey();
      let data = {};
      try {
        data = JSON.parse(localStorage.getItem(key) || "{}");
      } catch (e) {
        data = {};
      }

      const holder = document.getElementById("bank_holder");
      const bankName = document.getElementById("bank_name");
      const acc = document.getElementById("bank_account");
      const ifsc = document.getElementById("bank_ifsc");
      const upi = document.getElementById("bank_upi");
      const badge = document.getElementById("bankStatusBadge");
      const summary = document.getElementById("bankSummary");

      if (data && (data.holderName || data.accountNumber)) {
        holder.value = data.holderName || "";
        bankName.value = data.bankName || "";
        acc.value = data.accountNumber || "";
        ifsc.value = data.ifsc || "";
        upi.value = data.upi || "";

        badge.className = "badge-saved";
        badge.innerText = "Details saved";

        summary.innerText =
          "Saved Account: " +
          (data.holderName || "") +
          (data.bankName ? (" | Bank: " + data.bankName) : "") +
          (data.accountNumber ? (" | A/C: " + data.accountNumber) : "");
      } else {
        badge.className = "badge-not";
        badge.innerText = "Details not saved";
        summary.innerText = "";
      }
    }

    function saveBankDetailsOnly() {
      const holder = (document.getElementById("bank_holder").value || "").trim();
      const bankName = (document.getElementById("bank_name").value || "").trim();
      const acc = (document.getElementById("bank_account").value || "").trim();
      const ifsc = (document.getElementById("bank_ifsc").value || "").trim();
      const upi = (document.getElementById("bank_upi").value || "").trim();

      if (!holder || !bankName || !acc || !ifsc) {
        alert("Account Holder Name, Bank Name, Account Number और IFSC भरना ज़रूरी है।");
        return false;
      }

      const data = {
        holderName: holder,
        bankName,
        accountNumber: acc,
        ifsc,
        upi
      };

      try {
        localStorage.setItem(bankStorageKey(), JSON.stringify(data));
      } catch (e) {
        console.warn("Bank details save error", e);
      }
      loadBankDetails();
      return true;
    }

    function requestWithdrawal() {
      if (!currentCustomer) {
        alert("पहले login करें।");
        return;
      }

      const amount = parseFloat(document.getElementById("withdrawAmount").value || "0");
      const source = document.getElementById("withdrawSource").value; // commission | bonus

      if (amount <= 0) {
        alert("Valid withdrawal amount दर्ज करें।");
        return;
      }

      if (!saveBankDetailsOnly()) {
        return;
      }

      let cWallet = getCommissionWallet(currentCustomer);
      let bWallet = getBonusWallet(currentCustomer);
      let available = source === "bonus" ? bWallet : cWallet;

      if (available < amount) {
        alert("चुने गए wallet में इतना balance नहीं है।\nCurrent balance: ₹" + formatNumber(available));
        return;
      }

      if (source === "bonus") {
        bWallet -= amount;
        setBonusWallet(currentCustomer, bWallet);
      } else {
        cWallet -= amount;
        setCommissionWallet(currentCustomer, cWallet);
      }

      saveCurrentCustomer();

      let list = [];
      try {
        list = JSON.parse(localStorage.getItem(WITHDRAWAL_KEY) || "[]");
      } catch (e) { list = []; }

      list.push({
        id: Date.now(),
        customerId: currentCustomer.id,
        name: currentCustomer.name || "",
        mobile: currentCustomer.mobile || "",
        amount: amount,
        source: source,
        status: "Pending",
        createdAt: new Date().toISOString()
      });

      localStorage.setItem(WITHDRAWAL_KEY, JSON.stringify(list));

      alert("Withdrawal request भेज दी गई है। Admin approval के बाद status 'Paid' हो जाएगी।");
      refreshWalletInfo();
      renderSummary();
      document.getElementById("withdrawAmount").value = "0";
    }

    // ------------ INIT -------------
    window.addEventListener("load", loadLoggedInCustomer);
  </script>
</body>
</html>
