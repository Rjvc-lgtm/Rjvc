<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Smart Earning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #f1f5f9;
      color: #111827;
    }
    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
      margin-bottom: 16px;
    }
    h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    label {
      font-size: 14px;
      display: block;
      margin: 8px 0 4px;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
    }
    input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
    }
    .btn-primary {
      background: #1d4ed8;
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      border: 1px solid #d1d5db;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 999px;
    }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wallet {
      border-radius: 16px;
      padding: 12px;
      color: #fff;
      margin-bottom: 10px;
    }
    .wallet-comm {
      background: #0f172a;
    }
    .wallet-bonus {
      background: #14532d;
    }
    .wallet-amount {
      font-size: 26px;
      font-weight: 700;
    }
    .wallet-label {
      font-size: 13px;
      opacity: 0.9;
    }
    .stat-box {
      border-radius: 14px;
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .stat-label {
      font-weight: 500;
      margin-bottom: 3px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
    }
    .error {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 4px;
    }
    .success {
      color: #166534;
      font-size: 13px;
      margin-top: 4px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 180px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- CUSTOMER LOGIN CARD -->
    <div id="customerLoginCard" class="card">
      <h2>Customer Login</h2>
      <label>Customer Name</label>
      <input id="custNameInput" type="text" placeholder="जैसे: Rajesh" />

      <label class="mt-8">Password</label>
      <input id="custPassInput" type="password" placeholder="जैसे: 1234" />

      <button id="custLoginBtn" class="btn btn-primary mt-12" style="width:100%;">Login</button>
      <div id="custLoginMsg" class="error" style="display:none;"></div>
    </div>

    <!-- CUSTOMER DASHBOARD -->
    <div id="customerDashboardCard" class="card" style="display:none;">
      <div class="flex-between">
        <h2>RJVC Customer Dashboard</h2>
        <button id="custLogoutBtn" class="btn btn-outline btn-sm">Logout</button>
      </div>
      <div class="small" id="custWelcome"></div>

      <div class="wallet wallet-comm mt-12">
        <div class="wallet-label">COMMISSION WALLET</div>
        <div class="wallet-amount" id="custCommWallet">₹0</div>
        <div class="small">Direct / अन्य earnings (जितनी भी हों)</div>
      </div>

      <div class="wallet wallet-bonus">
        <div class="wallet-label">BONUS WALLET</div>
        <div class="wallet-amount" id="custBonusWallet">₹0</div>
        <div class="small">Sub IDs network / Binary से आने वाली earning (service charge के बाद)</div>
      </div>

      <div class="stat-box">
        <div class="stat-label">आपके नीचे कुल MEMBERS</div>
        <div><span id="custTotalMembers">0</span></div>
        <div class="small">पूरी tree में जितने लोग आपकी main ID से नीचे जुड़े हैं।</div>
      </div>

      <div class="stat-box">
        <div class="stat-label">कुल BINARY PAIRS</div>
        <div><span id="custTotalPairs">0</span></div>
        <div class="small">हर 2 member = 1 pair. 1 pair पर ₹3 earning मानी गई है।</div>
      </div>

      <div class="stat-box">
        <div class="stat-label">NEXT PAIR तक कितने MEMBER और?</div>
        <div><span id="custNextNeed">0</span></div>
        <div class="small">अगला नया pair बनने के लिए आपको और इतने member चाहिए।</div>
      </div>

      <div class="stat-box">
        <div class="stat-label">कुल खाते में (COMM + BONUS)</div>
        <div><span id="custTotalAmount">₹0</span></div>
        <div class="small">ये वही amount है जो अभी आपके दोनों wallets में दिख रही है।</div>
      </div>
    </div>

    <!-- WITHDRAWAL & BANK DETAILS -->
    <div id="withdrawCard" class="card" style="display:none;">
      <h2>Bank Withdrawal (Bonus Wallet)</h2>
      <div class="small">
        यहाँ से आप Bonus Wallet से withdrawal request भेज सकते हैं।  
        Request जाने पर amount आपके bonus wallet से reduce हो जाएगा और status <b>Pending</b> रहेगा,  
        जब तक admin approve करके <b>Paid</b नहीं कर देता।
      </div>

      <div class="row mt-12">
        <div class="col">
          <label>Account Holder Name</label>
          <input id="bankHolderInput" type="text" placeholder="Account पर लिखा नाम" />
        </div>
        <div class="col">
          <label>Bank Name</label>
          <input id="bankNameInput" type="text" placeholder="जैसे: SBI / HDFC" />
        </div>
      </div>

      <div class="row mt-8">
        <div class="col">
          <label>Account Number</label>
          <input id="bankAccountInput" type="text" placeholder="Account Number" />
        </div>
        <div class="col">
          <label>IFSC Code</label>
          <input id="bankIfscInput" type="text" placeholder="जैसे: SBIN0001234" />
        </div>
      </div>

      <div class="row mt-8">
        <div class="col">
          <label>UPI ID (optional)</label>
          <input id="bankUpiInput" type="text" placeholder="जैसे: number@upi" />
        </div>
        <div class="col">
          <label>Withdrawal Amount (Bonus से) ₹</label>
          <input id="withdrawAmountInput" type="number" min="0" value="0" />
        </div>
      </div>

      <button id="withdrawBtn" class="btn btn-primary mt-12" style="width:100%;">Withdrawal Request भेजें</button>
      <div id="withdrawMsg" class="success" style="display:none;"></div>

      <div class="small mt-8">
        नोट:  
        • Request भेजते ही amount आपके Bonus Wallet से घट जाएगा।  
        • Admin approval के बाद status "Paid" होगा और payment आपके bank/UPI में होगी.  
        • अगर admin reject करता है, तो amount वापस Bonus Wallet में वापस जोड़ा जा सकता है (Admin panel से)।  
      </div>
    </div>
  </div>

  <!-- Firebase CDN Scripts (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

  <script>
    // ============================
    //  Firebase Configuration
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyBDw_FQyDzWZLJORFtOwZqrFRfeS5tOFSw",
      authDomain: "rjvc-plan.firebaseapp.com",
      projectId: "rjvc-plan",
      storageBucket: "rjvc-plan.firebasestorage.app",
      messagingSenderId: "265431528728",
      appId: "1:265431528728:web:c3dc4b8e8f3ae4469a1a6d",
      measurementId: "G-1Y7PN96H93"
    };

    firebase.initializeApp(firebaseConfig);
    try { firebase.analytics(); } catch (e) {}
    const db = firebase.firestore();
    const usersCol = db.collection("Users");
    const withdrawalsCol = db.collection("Withdrawals");

    // ============================
    //  CUSTOMER LOGIN / DASHBOARD
    // ============================
    const custNameInput = document.getElementById("custNameInput");
    const custPassInput = document.getElementById("custPassInput");
    const custLoginBtn = document.getElementById("custLoginBtn");
    const custLoginMsg = document.getElementById("custLoginMsg");

    const customerLoginCard = document.getElementById("customerLoginCard");
    const customerDashboardCard = document.getElementById("customerDashboardCard");
    const withdrawCard = document.getElementById("withdrawCard");

    const custLogoutBtn = document.getElementById("custLogoutBtn");
    const custWelcome = document.getElementById("custWelcome");
    const custCommWallet = document.getElementById("custCommWallet");
    const custBonusWallet = document.getElementById("custBonusWallet");
    const custTotalMembers = document.getElementById("custTotalMembers");
    const custTotalPairs = document.getElementById("custTotalPairs");
    const custNextNeed = document.getElementById("custNextNeed");
    const custTotalAmount = document.getElementById("custTotalAmount");

    // Withdrawal DOM
    const bankHolderInput = document.getElementById("bankHolderInput");
    const bankNameInput = document.getElementById("bankNameInput");
    const bankAccountInput = document.getElementById("bankAccountInput");
    const bankIfscInput = document.getElementById("bankIfscInput");
    const bankUpiInput = document.getElementById("bankUpiInput");
    const withdrawAmountInput = document.getElementById("withdrawAmountInput");
    const withdrawBtn = document.getElementById("withdrawBtn");
    const withdrawMsg = document.getElementById("withdrawMsg");

    let currentCustomer = null;
    let currentCustomerUnsub = null;
    let currentCustomerId = null;

    function formatRupees(x) {
      return "₹" + (x || 0);
    }

    function computeNextNeed(members) {
      const m = members || 0;
      const rem = m % 2;
      return rem === 0 ? 2 : 1;
    }

    function subscribeCustomerDoc(docId) {
      if (currentCustomerUnsub) currentCustomerUnsub();
      currentCustomerId = docId;
      currentCustomerUnsub = usersCol.doc(docId).onSnapshot((snap) => {
        if (!snap.exists) return;
        currentCustomer = snap;
        const data = snap.data();

        const name = data.name || "";
        const comm = data.commissionWallet || 0;
        const bonus = data.bonusWallet || 0;
        const members = data.totalMembers || 0;
        const pairs = data.totalPairs || 0;

        custWelcome.textContent = "स्वागत है, " + name + " जी";
        custCommWallet.textContent = formatRupees(comm);
        custBonusWallet.textContent = formatRupees(bonus);
        custTotalMembers.textContent = members;
        custTotalPairs.textContent = pairs;
        custNextNeed.textContent = computeNextNeed(members);
        custTotalAmount.textContent = formatRupees(comm + bonus);

        customerLoginCard.style.display = "none";
        customerDashboardCard.style.display = "block";
        withdrawCard.style.display = "block";
      });
    }

    custLoginBtn.addEventListener("click", async () => {
      const name = custNameInput.value.trim();
      const pass = custPassInput.value.trim();
      custLoginMsg.style.display = "none";

      if (!name || !pass) {
        custLoginMsg.textContent = "नाम और पासवर्ड दोनों भरें।";
        custLoginMsg.style.display = "block";
        return;
      }

      try {
        const snap = await usersCol
          .where("name", "==", name)
          .where("password", "==", pass)
          .limit(1)
          .get();

        if (snap.empty) {
          custLoginMsg.textContent = "गलत नाम या पासवर्ड!";
          custLoginMsg.style.display = "block";
          return;
        }

        const doc = snap.docs[0];
        subscribeCustomerDoc(doc.id);

      } catch (err) {
        custLoginMsg.textContent = "Login error: " + err.message;
        custLoginMsg.style.display = "block";
      }
    });

    custLogoutBtn.addEventListener("click", () => {
      if (currentCustomerUnsub) currentCustomerUnsub();
      currentCustomerUnsub = null;
      currentCustomer = null;
      currentCustomerId = null;
      custNameInput.value = "";
      custPassInput.value = "";
      customerDashboardCard.style.display = "none";
      withdrawCard.style.display = "none";
      customerLoginCard.style.display = "block";
    });

    // ============================
    //  WITHDRAWAL REQUEST
    // ============================
    withdrawBtn.addEventListener("click", async () => {
      withdrawMsg.style.display = "none";

      if (!currentCustomer || !currentCustomerId) {
        withdrawMsg.textContent = "पहले login करें।";
        withdrawMsg.className = "error";
        withdrawMsg.style.display = "block";
        return;
      }

      const holder = bankHolderInput.value.trim();
      const bankName = bankNameInput.value.trim();
      const account = bankAccountInput.value.trim();
      const ifsc = bankIfscInput.value.trim();
      const upi = bankUpiInput.value.trim();
      const amount = parseFloat(withdrawAmountInput.value || "0");

      if (!holder || !bankName || !account || !ifsc) {
        withdrawMsg.textContent = "Account Holder, Bank Name, Account Number और IFSC जरूरी हैं।";
        withdrawMsg.className = "error";
        withdrawMsg.style.display = "block";
        return;
      }
      if (amount <= 0) {
        withdrawMsg.textContent = "Valid withdrawal amount डालें।";
        withdrawMsg.className = "error";
        withdrawMsg.style.display = "block";
        return;
      }

      try {
        // latest data from Firestore
        const userSnap = await usersCol.doc(currentCustomerId).get();
        if (!userSnap.exists) {
          withdrawMsg.textContent = "User data नहीं मिला।";
          withdrawMsg.className = "error";
          withdrawMsg.style.display = "block";
          return;
        }
        const data = userSnap.data();
        const name = data.name || "";
        let bonus = data.bonusWallet || 0;

        if (bonus < amount) {
          withdrawMsg.textContent = "Bonus Wallet में इतना balance नहीं है। Current: " + formatRupees(bonus);
          withdrawMsg.className = "error";
          withdrawMsg.style.display = "block";
          return;
        }

        // 1) bonus wallet से amount घटाना
        bonus = bonus - amount;
        await usersCol.doc(currentCustomerId).update({
          bonusWallet: bonus
        });

        // 2) Withdrawal request create करना
        await withdrawalsCol.add({
          userId: currentCustomerId,
          customerName: name,
          amount: amount,
          walletType: "bonus",
          bankHolder: holder,
          bankName: bankName,
          bankAccount: account,
          bankIfsc: ifsc,
          bankUpi: upi,
          status: "Pending",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        withdrawAmountInput.value = "0";
        withdrawMsg.textContent = "Withdrawal request भेज दी गई है (status: Pending).";
        withdrawMsg.className = "success";
        withdrawMsg.style.display = "block";

      } catch (err) {
        withdrawMsg.textContent = "Error: " + err.message;
        withdrawMsg.className = "error";
        withdrawMsg.style.display = "block";
      }
    });
  </script>
</body>
</html>
