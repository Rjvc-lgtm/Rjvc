<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Smart Earning System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #0b1021;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px 20px 20px 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      margin-top: -20px;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .top-bar a {
      color: #0d47a1;
      text-decoration: none;
      font-weight: 600;
    }

    h2 {
      margin: 10px 0 4px;
      font-size: 18px;
      color: #102a6b;
    }
    .subtitle {
      font-size: 12px;
      color: #555;
      margin-bottom: 12px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
    }
    .col {
      flex: 1 1 150px;
    }
    button {
      border: none;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 8px;
    }
    .btn-primary {
      background: #0066ff;
      color: white;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }

    .card {
      margin-top: 14px;
      padding: 10px;
      border-radius: 12px;
      background: #fff7e6;
      border: 1px solid #ffe0a3;
      font-size: 13px;
      white-space: pre-line;
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .section-card {
      margin-top: 10px;
      padding: 10px 10px 12px;
      border-radius: 12px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }

    .menu-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 4px;
    }
    .menu-btn {
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      background: #f0f2ff;
      border: 1px solid #ccd2ff;
      color: #102a6b;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .menu-btn span.icon {
      font-size: 15px;
    }

    .bank-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f2fffb;
      border: 1px solid #bfeeda;
      font-size: 12px;
    }
    .bank-card h3 {
      margin-top: 0;
      font-size: 14px;
      margin-bottom: 4px;
      color: #035b3c;
    }
    .bank-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }
    .bank-col {
      flex: 1 1 180px;
    }
    .badge-saved,
    .badge-not {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
    }
    .badge-saved {
      background: #d9f7be;
      color: #135200;
    }
    .badge-not {
      background: #fff1f0;
      color: #a8071a;
    }
    .text-muted {
      font-size: 11px;
      color: #666;
    }

    .wallet-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f5f0ff;
      border: 1px solid #d6c6ff;
      font-size: 12px;
    }
    .wallet-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }
    .wallet-col {
      flex: 1 1 150px;
    }

    .login-info {
      font-size: 11px;
      color: #b91c1c;
      margin-top: 3px;
    }

    .tag-pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#e0e7ff;
      font-size:10px;
      margin-left:6px;
      color:#1e293b;
    }
  </style>
</head>
<body>
  <!-- RJVC GOLDEN-BLACK BANNER -->
  <div style="width:100%; text-align:center;">
    <img src="https://raw.githubusercontent.com/Rjvc-lgtm/Rjvc/refs/heads/main/file_0000000021547209af0c0dab6fb5e932.png"
         alt="RJVC Banner" 
         style="width:100%; max-width:500px; display:block; margin:auto; border-radius:0 0 20px 20px;">
  </div>

  <div class="app">

    <!-- Top admin link -->
    <div class="top-bar">
      <a href="admin.html">Admin Login</a>
    </div>

    <!-- BANK / WITHDRAWAL MENU BUTTON -->
    <div class="menu-row">
      <button class="menu-btn" onclick="toggleBankSection()">
        <span class="icon">☰</span>
        Bank / Withdrawal Details
      </button>
    </div>

    <!-- BANK / WITHDRAWAL SECTION -->
    <div id="bankSection" class="bank-card" style="display:none;">
      <h3>
        Bank / Withdrawal Details
        <span id="bankStatusBadge" class="badge-not">Details not saved</span>
      </h3>
      <div class="bank-row">
        <div class="bank-col">
          <label>Account Holder Name</label>
          <input id="bank_holder" type="text" placeholder="Account पर लिखा नाम" />
        </div>
        <div class="bank-col">
          <label>Bank Name</label>
          <input id="bank_name" type="text" placeholder="जैसे: SBI / HDFC" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>Account Number</label>
          <input id="bank_account" type="text" placeholder="Account Number" />
        </div>
        <div class="bank-col">
          <label>IFSC Code</label>
          <input id="bank_ifsc" type="text" placeholder="जैसे: SBIN0001234" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>UPI ID (optional)</label>
          <input id="bank_upi" type="text" placeholder="जैसे: number@upi" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>Withdrawal Amount (₹)</label>
          <input id="withdrawAmount" type="number" min="0" value="0" />
        </div>
        <div class="bank-col">
          <label>Amount किस wallet से काटें?</label>
          <select id="withdrawSource">
            <option value="commission">Commission Wallet</option>
            <option value="bonus">Bonus Wallet</option>
          </select>
        </div>
        <div class="bank-col" style="align-self:flex-end;">
          <button class="btn-primary" onclick="requestWithdrawal()">Request Bank Withdrawal</button>
        </div>
      </div>
      <div class="text-muted">
        यह details सिर्फ आपके इस mobile/browser में सुरक्षित रहेंगी।  
        Commission और Bonus दोनों wallet से withdrawal request पर admin approval के बाद ही payment होगी।  
        Bonus Wallet का पैसा mobile से mobile transfer नहीं हो सकता, वह सिर्फ withdrawal के लिए है।
      </div>
      <div id="bankSummary" class="text-muted" style="margin-top:6px;"></div>
    </div>

    <!-- LOGIN + BASIC INFO SECTION -->
    <div class="section-card">
      <h2>Customer Login / Wallet View</h2>
      <div class="subtitle">
        यहाँ अपना registered mobile number डालिए।  
        केवल वही customer login कर पाएगा जिसे Admin ने create किया है।
      </div>

      <div class="row">
        <div class="col">
          <label>मोबाइल नंबर (Login)</label>
          <input id="customerMobile" type="tel" placeholder="10 digit mobile" />
          <div class="small">यही नंबर Commission Wallet, Bonus Wallet और transfer के लिए use होगा।</div>
          <div class="login-info">Note: Admin panel में जिस mobile पर customer बना है, वही number यहाँ डालें।</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ग्राहक का नाम</label>
          <input id="customerName" type="text" placeholder="Admin वाला नाम अपने आप भर जाएगा" readonly />
        </div>
        <div class="col">
          <label>RJVC ID <span class="tag-pill">Read Only</span></label>
          <input id="customerRJVCId" type="text" placeholder="Auto" readonly />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Joined Members (Total Tree)</label>
          <input id="joinedMembers" type="number" min="0" value="0" readonly />
          <div class="small">ये संख्या admin side से अपने आप आएगी (customer change नहीं कर सकता)।</div>
        </div>
      </div>

      <button class="btn-primary" onclick="customerLogin()">Login / Wallet देखें</button>
    </div>

    <!-- WALLET / TRANSFER SECTION -->
    <div class="wallet-card">
      <div class="card-title">RJVC Wallets & Mobile Transfer</div>
      <div id="walletInfo" class="text-muted">
        पहले ऊपर अपना registered mobile डालकर "Login / Wallet देखें" दबाएँ।
      </div>
      <div class="small" style="margin-top:4px;">
        Bonus Wallet से हर महीने withdrawal किया जा सकता है।  
        हर तीसरे महीने अगर आप अपने direct में कम से कम 1 नया member नहीं जोड़ते हैं  
        तो उस महीने का bonus कंपनी को चला जाएगा (customer को नहीं मिलेगा)।  
        Sub ID commission पर 15% company share पहले ही admin side पर minus हो चुका होता है।
      </div>

      <div class="wallet-row" style="margin-top:8px;">
        <div class="wallet-col">
          <label>Transfer To Mobile (सिर्फ Commission Wallet से)</label>
          <input id="transferToMobile" type="tel" placeholder="जैसे: 98xxxxxxxx" />
        </div>
        <div class="wallet-col">
          <label>Amount to Transfer (₹)</label>
          <input id="transferAmount" type="number" min="0" value="0" />
        </div>
        <div class="wallet-col" style="align-self:flex-end;">
          <button class="btn-secondary" onclick="transferCommission()">Transfer Commission</button>
        </div>
      </div>
      <div class="text-muted">
        Mobile से mobile commission transfer के लिए admin approval की ज़रूरत नहीं है।  
        यह transfer सिर्फ Commission Wallet से होगा। Bonus Wallet से transfer नहीं होगा, वह सिर्फ withdrawal के लिए है।
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="customerSummary" class="card">
      <div class="card-title">Customer Report</div>
      <div id="summaryText">ऊपर registered mobile डालकर "Login / Wallet देखें" दबाएँ।</div>
    </div>
  </div>

  <script>
    function formatNumber(n) {
      return Number(n || 0).toLocaleString("en-IN");
    }

    // ---------- BANK DETAILS ----------
    function toggleBankSection() {
      const sec = document.getElementById("bankSection");
      if (sec.style.display === "none" || !sec.style.display) {
        sec.style.display = "block";
      } else {
        sec.style.display = "none";
      }
    }

    function loadBankDetails() {
      try {
        const data = JSON.parse(localStorage.getItem("rjvc_bank_details") || "{}");
        const holder = document.getElementById("bank_holder");
        const bankName = document.getElementById("bank_name");
        const acc = document.getElementById("bank_account");
        const ifsc = document.getElementById("bank_ifsc");
        const upi = document.getElementById("bank_upi");
        const badge = document.getElementById("bankStatusBadge");
        const summary = document.getElementById("bankSummary");

        if (data && (data.holderName || data.accountNumber)) {
          holder.value = data.holderName || "";
          bankName.value = data.bankName || "";
          acc.value = data.accountNumber || "";
          ifsc.value = data.ifsc || "";
          upi.value = data.upi || "";

          badge.className = "badge-saved";
          badge.innerText = "Details saved";

          summary.innerText =
            "Saved Account: " +
            (data.holderName || "") +
            (data.bankName ? (" | Bank: " + data.bankName) : "") +
            (data.accountNumber ? (" | A/C: " + data.accountNumber) : "");
        } else {
          badge.className = "badge-not";
          badge.innerText = "Details not saved";
          summary.innerText = "";
        }
      } catch (e) {
        console.warn("Bank details load error", e);
      }
    }

    function saveBankDetailsOnly() {
      const holder = (document.getElementById("bank_holder").value || "").trim();
      const bankName = (document.getElementById("bank_name").value || "").trim();
      const acc = (document.getElementById("bank_account").value || "").trim();
      const ifsc = (document.getElementById("bank_ifsc").value || "").trim();
      const upi = (document.getElementById("bank_upi").value || "").trim();

      if (!holder || !bankName || !acc || !ifsc) {
        alert("Account Holder Name, Bank Name, Account Number और IFSC भरना जरूरी है।");
        return false;
      }

      const data = {
        holderName: holder,
        bankName,
        accountNumber: acc,
        ifsc,
        upi
      };

      try {
        localStorage.setItem("rjvc_bank_details", JSON.stringify(data));
      } catch (e) {
        console.warn("Bank details save error", e);
      }
      loadBankDetails();
      return true;
    }

    function getWithdrawals() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_withdrawals") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveWithdrawals(list) {
      localStorage.setItem("rjvc_withdrawals", JSON.stringify(list));
    }

    // ---------- COMMON CUSTOMER STORAGE ----------
    function getCustomersArray() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_customers") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveCustomersArray(list) {
      localStorage.setItem("rjvc_customers", JSON.stringify(list));
    }

    function findCustomerByMobile(mobile) {
      const customers = getCustomersArray();
      return customers.find(c => c.mobile === mobile);
    }

    // ---------- CUSTOMER LOGIN ----------
    function customerLogin() {
      const mobile = (document.getElementById("customerMobile").value || "").trim();

      if (!mobile || mobile.length < 10) {
        alert("सही registered mobile number डालें (10 digit)।");
        return;
      }

      const cust = findCustomerByMobile(mobile);

      if (!cust) {
        document.getElementById("customerName").value = "";
        document.getElementById("customerRJVCId").value = "";
        document.getElementById("joinedMembers").value = "0";

        document.getElementById("walletInfo").innerText =
          "इस मोबाइल नंबर के लिए कोई customer record नहीं मिला। कृपया admin से contact करें।";

        document.getElementById("summaryText").innerText =
          "आपका mobile RJVC system में नहीं मिला है।\n\n" +
          "हो सकता है कि:\n" +
          "• Admin ने अभी तक आपका customer create न किया हो, या\n" +
          "• Mobile number गलत टाइप हुआ हो।";

        return;
      }

      // Login successful – basic details दिखाओ
      document.getElementById("customerName").value = cust.name || "";
      document.getElementById("customerRJVCId").value = cust.mainId || cust.rjvcId || "";
      document.getElementById("joinedMembers").value = cust.joinedMembers || 0;

      refreshWalletInfo();

      const commissionWallet = cust.walletBalance || 0;
      const bonusWallet = cust.bonusBalance || 0;

      let report = "";
      if (cust.name) {
        report += cust.name + " जी,\n\n";
      }
      report += "आपका RJVC ID: " + (cust.mainId || cust.rjvcId || "N/A") + "\n";
      report += "आपके पूरे tree में अभी तक जुड़े total members: " + formatNumber(cust.joinedMembers || 0) + "\n\n";
      report += "Commission Wallet: ₹" + formatNumber(commissionWallet) + "\n";
      report += "Bonus Wallet: ₹" + formatNumber(bonusWallet) + "\n\n";
      report += "ध्यान दें: Wallet balance में main ID + 3 Sub ID से जितनी भी commission बनी है,\n" +
                "सारी calculation admin side पर auto हो चुकी है। यहाँ आपको final amount दिखाई दे रही है।";

      document.getElementById("summaryText").innerText = report;
    }

    // ---------- WITHDRAWAL ----------
    function requestWithdrawal() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value || "0");
      const source = document.getElementById("withdrawSource").value; // commission | bonus
      const name = (document.getElementById("customerName").value || "").trim();
      const mobile = (document.getElementById("customerMobile").value || "").trim();

      if (!mobile) {
        alert("Withdrawal के लिए पहले अपना registered mobile number भरें।");
        return;
      }
      if (amount <= 0) {
        alert("Valid withdrawal amount दर्ज करें।");
        return;
      }

      if (!saveBankDetailsOnly()) {
        return;
      }

      const customers = getCustomersArray();
      const idx = customers.findIndex(c => c.mobile === mobile);
      if (idx === -1) {
        alert("इस मोबाइल के लिए कोई customer record नहीं मिला। पहले admin से contact करें।");
        return;
      }

      const cust = customers[idx];
      const commissionWallet = cust.walletBalance || 0;
      const bonusWallet = cust.bonusBalance || 0;

      let available = source === "bonus" ? bonusWallet : commissionWallet;

      if (available < amount) {
        alert("चुने गए wallet में इतना balance नहीं है। Current balance: ₹" + formatNumber(available));
        return;
      }

      if (source === "bonus") {
        cust.bonusBalance = bonusWallet - amount;
      } else {
        cust.walletBalance = commissionWallet - amount;
      }

      customers[idx] = cust;
      saveCustomersArray(customers);

      const withdrawals = getWithdrawals();
      withdrawals.push({
        id: Date.now(),
        customerId: cust.id,
        name: name || cust.name || "",
        mobile,
        amount,
        source,
        status: "Pending",
        createdAt: new Date().toISOString()
      });
      saveWithdrawals(withdrawals);

      alert("Withdrawal request भेज दी गई है। Admin approval के बाद status 'Paid' हो जाएगी।");
      refreshWalletInfo();
    }

    // ---------- Wallet / Transfer ----------
    function refreshWalletInfo() {
      const mobile = (document.getElementById("customerMobile").value || "").trim();
      const name = (document.getElementById("customerName").value || "").trim();
      const box = document.getElementById("walletInfo");

      if (!mobile) {
        box.innerText = "पहले ऊपर अपना registered mobile number भरें और \"Login / Wallet देखें\" दबाएँ।";
        return;
      }

      const customers = getCustomersArray();
      const cust = customers.find(c => c.mobile === mobile);
      if (!cust) {
        box.innerText = "इस मोबाइल नंबर के लिए अभी कोई customer record नहीं मिला (admin से contact करें)।";
        return;
      }

      const commissionWallet = cust.walletBalance || 0;
      const bonusWallet = cust.bonusBalance || 0;

      box.innerText =
        (name ? (name + " जी,\n") : "") +
        "Commission Wallet Balance: ₹" + formatNumber(commissionWallet) +
        "\nBonus Wallet Balance: ₹" + formatNumber(bonusWallet) +
        "\n(Main ID + सभी Sub IDs की commission का final result है)।";
    }

    function transferCommission() {
      const fromMobile = (document.getElementById("customerMobile").value || "").trim();
      const toMobile = (document.getElementById("transferToMobile").value || "").trim();
      const amount = parseFloat(document.getElementById("transferAmount").value || "0");

      if (!fromMobile) {
        alert("पहले ऊपर अपना registered mobile number भरें और login करें।");
        return;
      }
      if (!toMobile) {
        alert("जिस mobile पर भेजना है, वो नंबर भरें।");
        return;
      }
      if (fromMobile === toMobile) {
        alert("खुद के मोबाइल पर transfer की जरूरत नहीं है।");
        return;
      }
      if (amount <= 0) {
        alert("Valid transfer amount दर्ज करें।");
        return;
      }

      const customers = getCustomersArray();
      const fromIdx = customers.findIndex(c => c.mobile === fromMobile);
      if (fromIdx === -1) {
        alert("आपके mobile के लिए कोई wallet नहीं मिला। पहले admin से contact करें।");
        return;
      }

      const from = customers[fromIdx];
      const fromWallet = from.walletBalance || 0; // सिर्फ commission wallet से transfer
      if (fromWallet < amount) {
        alert("आपके Commission Wallet में इतना balance नहीं है। Current balance: ₹" + formatNumber(fromWallet));
        return;
      }

      let toIdx = customers.findIndex(c => c.mobile === toMobile);
      if (toIdx === -1) {
        const newCust = {
          id: Date.now() + 1,
          name: "Customer " + toMobile,
          mobile: toMobile,
          joinedMembers: 0,
          state: "manual",
          currentLevel: 0,
          nextLevel: null,
          remainingForNext: 0,
          nextLevelIncome: 0,
          totalIncome: 0,
          walletBalance: 0,
          bonusBalance: 0,
          status: "Active",
          createdAt: new Date().toISOString()
        };
        customers.push(newCust);
        toIdx = customers.length - 1;
      }

      const to = customers[toIdx];

      from.walletBalance = fromWallet - amount; // bonus नहीं घटा
      to.walletBalance = (to.walletBalance || 0) + amount;

      customers[fromIdx] = from;
      customers[toIdx] = to;

      saveCustomersArray(customers);

      alert("₹" + formatNumber(amount) + " सफलतापूर्वक " + toMobile + " पर transfer कर दिया गया है (Commission Wallet से)।");
      refreshWalletInfo();
      document.getElementById("transferAmount").value = "0";
    }

    window.addEventListener("load", function () {
      loadBankDetails();
    });
  </script>
</body>
</html>
