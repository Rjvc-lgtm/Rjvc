<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>RJVC Smart Earning System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #e6ebff;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 18px 18px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .top-bar a {
      color: #0d47a1;
      text-decoration: none;
      font-weight: 600;
    }

    h2 {
      margin: 10px 0 4px;
      font-size: 18px;
      color: #102a6b;
    }
    .subtitle {
      font-size: 12px;
      color: #555;
      margin-bottom: 12px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
    }
    .col {
      flex: 1 1 150px;
    }
    button {
      border: none;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 8px;
    }
    .btn-primary {
      background: #0066ff;
      color: white;
    }
    .btn-secondary {
      background: #e0e4ff;
      color: #102a6b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 6px 6px;
      text-align: right;
    }
    th {
      background: #f8f8ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    .total-box {
      margin-top: 14px;
      padding: 10px;
      border-radius: 12px;
      background: #f0f5ff;
      font-size: 14px;
    }
    .small {
      font-size: 11px;
      color: #777;
    }
    .card {
      margin-top: 14px;
      padding: 10px;
      border-radius: 12px;
      background: #fff7e6;
      border: 1px solid #ffe0a3;
      font-size: 13px;
      white-space: pre-line;
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .section-card {
      margin-top: 10px;
      padding: 10px 10px 12px;
      border-radius: 12px;
      background: #f9f9ff;
      border: 1px solid #dde2ff;
    }

    .menu-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 4px;
    }
    .menu-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      background: #f0f2ff;
      border: 1px solid #ccd2ff;
      color: #102a6b;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .menu-btn span.icon {
      font-size: 15px;
    }

    .bank-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f2fffb;
      border: 1px solid #bfeeda;
      font-size: 12px;
    }
    .bank-card h3 {
      margin-top: 0;
      font-size: 14px;
      margin-bottom: 4px;
      color: #035b3c;
    }
    .bank-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }
    .bank-col {
      flex: 1 1 180px;
    }
    .badge-saved,
    .badge-not {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
    }
    .badge-saved {
      background: #d9f7be;
      color: #135200;
    }
    .badge-not {
      background: #fff1f0;
      color: #a8071a;
    }
    .text-muted {
      font-size: 11px;
      color: #666;
    }

    .wallet-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f5f0ff;
      border: 1px solid #d6c6ff;
      font-size: 12px;
    }
    .wallet-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }
    .wallet-col {
      flex: 1 1 150px;
    }
  </style>
</head>
<body>
  <!-- RJVC GOLDEN-BLACK BANNER -->
  <div style="width:100%; text-align:center;">
    <img src="https://raw.githubusercontent.com/Rjvc-lgtm/Rjvc/refs/heads/main/file_0000000021547209af0c0dab6fb5e932.png"
         alt="RJVC Banner" 
         style="width:100%; max-width:500px; display:block; margin:auto; border-radius:0 0 20px 20px;">
  </div>

  <div class="app">

    <!-- Top admin link -->
    <div class="top-bar">
      <a href="login.html">Admin Login</a>
    </div>

    <!-- BANK / WITHDRAWAL MENU BUTTON -->
    <div class="menu-row">
      <button class="menu-btn" onclick="toggleBankSection()">
        <span class="icon">☰</span>
        Bank / Withdrawal Details
      </button>
    </div>

    <!-- BANK / WITHDRAWAL SECTION -->
    <div id="bankSection" class="bank-card" style="display:none;">
      <h3>
        Bank / Withdrawal Details
        <span id="bankStatusBadge" class="badge-not">Details not saved</span>
      </h3>
      <div class="bank-row">
        <div class="bank-col">
          <label>Account Holder Name</label>
          <input id="bank_holder" type="text" placeholder="Account पर लिखा नाम" />
        </div>
        <div class="bank-col">
          <label>Bank Name</label>
          <input id="bank_name" type="text" placeholder="जैसे: SBI / HDFC" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>Account Number</label>
          <input id="bank_account" type="text" placeholder="Account Number" />
        </div>
        <div class="bank-col">
          <label>IFSC Code</label>
          <input id="bank_ifsc" type="text" placeholder="जैसे: SBIN0001234" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>UPI ID (optional)</label>
          <input id="bank_upi" type="text" placeholder="जैसे: number@upi" />
        </div>
      </div>
      <div class="bank-row">
        <div class="bank-col">
          <label>Withdrawal Amount (₹)</label>
          <input id="withdrawAmount" type="number" min="0" value="0" />
        </div>
        <div class="bank-col">
          <label>Amount किस wallet से काटें?</label>
          <select id="withdrawSource">
            <option value="commission">Commission Wallet</option>
            <option value="bonus">Bonus Wallet</option>
          </select>
        </div>
        <div class="bank-col" style="align-self:flex-end;">
          <button class="btn-primary" onclick="requestWithdrawal()">Request Bank Withdrawal</button>
        </div>
      </div>
      <div class="text-muted">
        यह details सिर्फ आपके इस mobile/browser में सुरक्षित रहेंगी।  
        Commission और Bonus दोनों wallet से withdrawal request पर admin approval के बाद ही payment होगी।  
        Bonus Wallet का पैसा mobile से mobile transfer नहीं हो सकता, वह सिर्फ withdrawal के लिए है।
      </div>
      <div id="bankSummary" class="text-muted" style="margin-top:6px;"></div>
    </div>

    <!-- CUSTOMER & PLAN SECTION -->
    <div class="section-card">
      <h2>Customer Details</h2>
      <div class="subtitle">
        यहाँ अपना नाम और मोबाइल नंबर भरें – इसी पर आपका wallet और payout चलेगा।
      </div>

      <div class="row">
        <div class="col">
          <label>ग्राहक का नाम</label>
          <input id="customerName" type="text" placeholder="जैसे: राजेश" />
        </div>
        <div class="col">
          <label>मोबाइल नंबर</label>
          <input id="customerMobile" type="tel" placeholder="10 digit mobile" />
          <div class="small">यही नंबर commission wallet, bonus wallet और transfer के लिए use होगा</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>अभी तक कुल कितने सदस्य जुड़ चुके हैं?</label>
          <input id="joinedMembers" type="number" min="0" value="0" />
          <div class="small">आपके direct + indirect दोनों, कुल active members</div>
        </div>
      </div>
    </div>

    <div class="section-card">
      <h2>Plan Settings</h2>
      <div class="subtitle">
        ये setting admin panel से भी change की जा सकती है। अभी आप चाहें तो यहाँ से देख सकते हैं।
      </div>

      <div class="row">
        <div class="col">
          <label>कितने levels दिखाने हैं?</label>
          <input id="levels" type="number" min="1" max="20" value="11" />
          <div class="small">जैसे: 11 तक</div>
        </div>
        <div class="col">
          <label>प्रति सदस्य commission (₹)</label>
          <input id="commissionPerMember" type="number" min="0" value="16" />
          <div class="small">ये amount हर member पर apply होगी (ग्राहक को table में अलग से नहीं दिखेगी)</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>स्टार्टिंग में कितने लोग हैं?</label>
          <input id="startMembers" type="number" min="1" value="2" />
          <div class="small">आमतौर पर 2 से शुरुआत</div>
        </div>
        <div class="col">
          <label>डबलिंग (multiplier)</label>
          <input id="multiplier" type="number" min="2" value="2" />
          <div class="small">आमतौर पर 2x रहता है</div>
        </div>
      </div>

      <div style="margin-bottom: 4px;">
        <button class="btn-primary" onclick="calculate()">कैल्क्युलेट करें</button>
        <button class="btn-secondary" onclick="loadExample()">Demo Example</button>
      </div>
    </div>

    <!-- WALLET / TRANSFER SECTION -->
    <div class="wallet-card">
      <div class="card-title">RJVC Wallets & Mobile Transfer</div>
      <div id="walletInfo" class="text-muted">
        पहले ऊपर अपना नाम और मोबाइल नंबर भरें और "कैल्क्युलेट करें" दबाएँ।
      </div>
      <div class="small" style="margin-top:4px;">
        Bonus Wallet से हर महीने withdrawal किया जा सकता है।  
        हर तीसरे महीने अगर आप अपने direct में कम से कम 1 नया member नहीं जोड़ते हैं  
        तो उस महीने का bonus कंपनी को चला जाएगा (customer को नहीं मिलेगा)।
      </div>

      <div class="wallet-row" style="margin-top:8px;">
        <div class="wallet-col">
          <label>Transfer To Mobile (सिर्फ Commission Wallet से)</label>
          <input id="transferToMobile" type="tel" placeholder="जैसे: 98xxxxxxxx" />
        </div>
        <div class="wallet-col">
          <label>Amount to Transfer (₹)</label>
          <input id="transferAmount" type="number" min="0" value="0" />
        </div>
        <div class="wallet-col" style="align-self:flex-end;">
          <button class="btn-secondary" onclick="transferCommission()">Transfer Commission</button>
        </div>
      </div>
      <div class="text-muted">
        Mobile से mobile commission transfer के लिए admin approval की ज़रूरत नहीं है।  
        यह transfer सिर्फ Commission Wallet से होगा। Bonus Wallet से transfer नहीं होगा, वह सिर्फ withdrawal के लिए है।
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="customerSummary" class="card">
      <div class="card-title">Customer Report</div>
      <div id="summaryText">ऊपर डेटा भरकर "कैल्क्युलेट करें" दबाएँ।</div>
    </div>

    <!-- RESULT TABLE -->
    <div class="section-card" style="margin-top:12px;">
      <h2>Earning Table (Auto Calculated)</h2>
      <div style="max-height: 280px; overflow:auto;">
        <table id="resultTable">
          <thead>
            <tr>
              <th>Level</th>
              <th>Members</th>
              <th>New Members</th>
              <th>Level Income (₹)</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS से rows आएँगे -->
          </tbody>
        </table>
      </div>

      <div class="total-box" id="totalBox">
        कुल कमाई: ₹0
      </div>
    </div>
  </div>

  <script>
    function formatNumber(n) {
      return Number(n || 0).toLocaleString("en-IN");
    }

    // ---------- BANK DETAILS ----------
    function toggleBankSection() {
      const sec = document.getElementById("bankSection");
      if (sec.style.display === "none" || !sec.style.display) {
        sec.style.display = "block";
      } else {
        sec.style.display = "none";
      }
    }

    function loadBankDetails() {
      try {
        const data = JSON.parse(localStorage.getItem("rjvc_bank_details") || "{}");
        const holder = document.getElementById("bank_holder");
        const bankName = document.getElementById("bank_name");
        const acc = document.getElementById("bank_account");
        const ifsc = document.getElementById("bank_ifsc");
        const upi = document.getElementById("bank_upi");
        const badge = document.getElementById("bankStatusBadge");
        const summary = document.getElementById("bankSummary");

        if (data && (data.holderName || data.accountNumber)) {
          holder.value = data.holderName || "";
          bankName.value = data.bankName || "";
          acc.value = data.accountNumber || "";
          ifsc.value = data.ifsc || "";
          upi.value = data.upi || "";

          badge.className = "badge-saved";
          badge.innerText = "Details saved";

          summary.innerText =
            "Saved Account: " +
            (data.holderName || "") +
            (data.bankName ? (" | Bank: " + data.bankName) : "") +
            (data.accountNumber ? (" | A/C: " + data.accountNumber) : "");
        } else {
          badge.className = "badge-not";
          badge.innerText = "Details not saved";
          summary.innerText = "";
        }
      } catch (e) {
        console.warn("Bank details load error", e);
      }
    }

    function saveBankDetailsOnly() {
      const holder = (document.getElementById("bank_holder").value || "").trim();
      const bankName = (document.getElementById("bank_name").value || "").trim();
      const acc = (document.getElementById("bank_account").value || "").trim();
      const ifsc = (document.getElementById("bank_ifsc").value || "").trim();
      const upi = (document.getElementById("bank_upi").value || "").trim();

      if (!holder || !bankName || !acc || !ifsc) {
        alert("Account Holder Name, Bank Name, Account Number और IFSC भरना जरूरी है।");
        return false;
      }

      const data = {
        holderName: holder,
        bankName,
        accountNumber: acc,
        ifsc,
        upi
      };

      try {
        localStorage.setItem("rjvc_bank_details", JSON.stringify(data));
      } catch (e) {
        console.warn("Bank details save error", e);
      }
      loadBankDetails();
      return true;
    }

    function getWithdrawals() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_withdrawals") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveWithdrawals(list) {
      localStorage.setItem("rjvc_withdrawals", JSON.stringify(list));
    }

    function requestWithdrawal() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value || "0");
      const source = document.getElementById("withdrawSource").value; // commission | bonus
      const name = (document.getElementById("customerName").value || "").trim();
      const mobile = (document.getElementById("customerMobile").value || "").trim();

      if (!mobile) {
        alert("Withdrawal के लिए पहले अपना मोबाइल नंबर भरें।");
        return;
      }
      if (amount <= 0) {
        alert("Valid withdrawal amount दर्ज करें।");
        return;
      }

      if (!saveBankDetailsOnly()) {
        return;
      }

      const customers = getCustomersArray();
      const idx = customers.findIndex(c => c.mobile === mobile);
      if (idx === -1) {
        alert("इस मोबाइल के लिए कोई wallet नहीं मिला। पहले calculation करें।");
        return;
      }

      const cust = customers[idx];
      const commissionWallet = cust.walletBalance || 0;
      const bonusWallet = cust.bonusBalance || 0;

      let available = source === "bonus" ? bonusWallet : commissionWallet;

      if (available < amount) {
        alert("चुने गए wallet में इतना balance नहीं है। Current balance: ₹" + formatNumber(available));
        return;
      }

      // कटौती सही wallet से
      if (source === "bonus") {
        cust.bonusBalance = bonusWallet - amount;
      } else {
        cust.walletBalance = commissionWallet - amount;
      }

      customers[idx] = cust;
      saveCustomersArray(customers);

      const withdrawals = getWithdrawals();
      withdrawals.push({
        id: Date.now(),
        customerId: cust.id,
        name: name || cust.name || "",
        mobile,
        amount,
        source, // "commission" या "bonus"
        status: "Pending",
        createdAt: new Date().toISOString()
      });
      saveWithdrawals(withdrawals);

      alert("Withdrawal request भेज दी गई है। Admin approval के बाद status 'Paid' हो जाएगी।");
      refreshWalletInfo();
    }

    // ---------- SETTINGS / CUSTOMERS ----------

    function loadSettings() {
      try {
        const s = JSON.parse(localStorage.getItem("rjvc_settings") || "{}");
        if (s.levels) document.getElementById("levels").value = s.levels;
        if (s.perMember) document.getElementById("commissionPerMember").value = s.perMember;
        if (s.startMembers) document.getElementById("startMembers").value = s.startMembers;
        if (s.multiplier) document.getElementById("multiplier").value = s.multiplier;
      } catch (e) {
        console.warn("Settings load error", e);
      }
    }

    function getCustomersArray() {
      try {
        return JSON.parse(localStorage.getItem("rjvc_customers") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveCustomersArray(list) {
      localStorage.setItem("rjvc_customers", JSON.stringify(list));
    }

    function calculate() {
      const levels = parseInt(document.getElementById("levels").value || "0", 10);
      const perMember = parseFloat(document.getElementById("commissionPerMember").value || "0");
      const startMembers = parseInt(document.getElementById("startMembers").value || "0", 10);
      const multiplier = parseInt(document.getElementById("multiplier").value || "2", 10);
      const customerName = (document.getElementById("customerName").value || "").trim();
      const customerMobile = (document.getElementById("customerMobile").value || "").trim();
      const joinedMembers = parseInt(document.getElementById("joinedMembers").value || "0", 10);

      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      let currentMembers = startMembers;
      let totalIncome = 0;
      const levelInfo = [];

      for (let level = 1; level <= levels; level++) {
        const newMembers = currentMembers;
        const levelIncome = newMembers * perMember;
        totalIncome += levelIncome;

        levelInfo.push({
          level,
          members: newMembers,
          income: levelIncome
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${level}</td>
          <td>${formatNumber(currentMembers)}</td>
          <td>${formatNumber(newMembers)}</td>
          <td>${formatNumber(levelIncome)}</td>
        `;
        tbody.appendChild(tr);

        currentMembers = currentMembers * multiplier;
      }

      document.getElementById("totalBox").innerText =
        "कुल कमाई: ₹" + formatNumber(totalIncome);

      const summaryData = computeSummaryData(joinedMembers, levelInfo, perMember);
      renderCustomerSummary(customerName, joinedMembers, levelInfo, perMember, summaryData);
      saveCustomerRecord(customerName, customerMobile, joinedMembers, summaryData, totalIncome);
      refreshWalletInfo();
    }

    function computeSummaryData(joined, levelInfo, perMember) {
      if (!levelInfo.length) return { state: "noLevels" };

      if (joined <= 0) {
        return {
          state: "noMembers",
          neededFirstLevel: levelInfo[0].members
        };
      }

      let cumulative = 0;
      let currentLevel = 0;
      let nextLevel = 0;
      let neededInNextLevel = 0;
      let remainingForNext = 0;
      let nextLevelIncome = 0;
      const totalLevels = levelInfo.length;

      for (let i = 0; i < totalLevels; i++) {
        const levelMembers = levelInfo[i].members;
        const level = levelInfo[i].level;
        const prevCum = cumulative;
        cumulative += levelMembers;

        if (joined >= cumulative) {
          currentLevel = level;
        } else {
          nextLevel = level;
          const joinedInThisLevel = Math.max(0, joined - prevCum);
          neededInNextLevel = levelMembers;
          remainingForNext = Math.max(0, levelMembers - joinedInThisLevel);
          nextLevelIncome = levelMembers * perMember;
          break;
        }
      }

      if (joined >= cumulative && nextLevel === 0) {
        return {
          state: "allComplete",
          totalLevels
        };
      }

      return {
        state: "normal",
        currentLevel,
        nextLevel,
        neededInNextLevel,
        remainingForNext,
        nextLevelIncome
      };
    }

    function renderCustomerSummary(name, joined, levelInfo, perMember, summary) {
      const summaryDiv = document.getElementById("summaryText");

      if (!name && !joined) {
        summaryDiv.innerText = "ऊपर ग्राहक का नाम, मोबाइल और अभी तक के सदस्य भरकर \"कैल्क्युलेट करें\" दबाएँ।";
        return;
      }

      if (summary.state === "noMembers") {
        summaryDiv.innerText =
          (name ? (name + " जी, ") : "") +
          "अभी तक कोई सदस्य join नहीं हुआ है। आप Level 1 के लिए " +
          formatNumber(summary.neededFirstLevel) + " सदस्य की ज़रूरत है।";
        return;
      }

      if (summary.state === "allComplete") {
        summaryDiv.innerText =
          (name ? (name + " जी, ") : "") +
          "आपने दिए गए सभी " + summary.totalLevels +
          " steps पूरा कर लिए हैं। अगला data नहीं है (ऊपर levels बढ़ाकर नया plan बना सकते हैं)।";
        return;
      }

      if (summary.state !== "normal") {
        summaryDiv.innerText = "डेटा उपलब्ध नहीं है।";
        return;
      }

      let text = "";
      if (name) {
        text += name + " जी,\n";
      }

      text += "अभी तक आपकी तरफ कुल " + formatNumber(joined) + " सदस्य जुड़े हैं।\n";

      if (summary.currentLevel > 0) {
        text += "आपने अभी तक Step " + summary.currentLevel + " पूरा कर लिया है।\n";
      } else {
        text += "आप अभी First step पर हैं (अभी कोई पूरा step नहीं हुआ है)।\n";
      }

      text += "\nNext Step: " + summary.nextLevel + "\n";
      text += "इस step के लिए कुल सदस्य चाहिए: " + formatNumber(summary.neededInNextLevel) + "\n";
      text += "आपको और सदस्य चाहिए: " + formatNumber(summary.remainingForNext) + "\n";
      text += "जब यह step पूरा होगा तो इस से आपकी earning होगी: ₹" + formatNumber(summary.nextLevelIncome) + "\n";

      summaryDiv.innerText = text;
    }

    function saveCustomerRecord(name, mobile, joined, summary, totalIncome) {
      if (!mobile) return; // mobile ही unique ID

      const customers = getCustomersArray();
      const idx = customers.findIndex(c => c.mobile === mobile);

      if (idx === -1) {
        const record = {
          id: Date.now(),
          name,
          mobile,
          joinedMembers: joined,
          state: summary.state,
          currentLevel: summary.currentLevel || 0,
          nextLevel: summary.nextLevel || null,
          remainingForNext: summary.remainingForNext || 0,
          nextLevelIncome: summary.nextLevelIncome || 0,
          totalIncome: totalIncome || 0,
          walletBalance: totalIncome || 0, // main commission wallet
          bonusBalance: 0,                 // Bonus Wallet (admin से credit होगा)
          createdAt: new Date().toISOString()
        };
        customers.push(record);
      } else {
        const old = customers[idx];
        const oldTotal = old.totalIncome || 0;
        const extra = Math.max(0, (totalIncome || 0) - oldTotal);
        const newWallet = (old.walletBalance || 0) + extra;

        customers[idx] = {
          ...old,
          name: name || old.name,
          joinedMembers: joined,
          state: summary.state,
          currentLevel: summary.currentLevel || old.currentLevel || 0,
          nextLevel: summary.nextLevel || old.nextLevel || null,
          remainingForNext: summary.remainingForNext || old.remainingForNext || 0,
          nextLevelIncome: summary.nextLevelIncome || old.nextLevelIncome || 0,
          totalIncome: totalIncome || old.totalIncome || 0,
          walletBalance: newWallet,
          bonusBalance: old.bonusBalance || 0
        };
      }

      saveCustomersArray(customers);
    }

    // ---------- Wallet / Transfer ----------

    function refreshWalletInfo() {
      const mobile = (document.getElementById("customerMobile").value || "").trim();
      const name = (document.getElementById("customerName").value || "").trim();
      const box = document.getElementById("walletInfo");

      if (!mobile) {
        box.innerText = "पहले ऊपर अपना मोबाइल नंबर भरें और \"कैल्क्युलेट करें\" दबाएँ।";
        return;
      }

      const customers = getCustomersArray();
      const cust = customers.find(c => c.mobile === mobile);
      if (!cust) {
        box.innerText = "इस मोबाइल नंबर के लिए अभी कोई रिकॉर्ड नहीं मिला। पहले calculation करें।";
        return;
      }

      const commissionWallet = cust.walletBalance || 0;
      const bonusWallet = cust.bonusBalance || 0;

      box.innerText =
        (name ? (name + " जी,\n") : "") +
        "Commission Wallet Balance: ₹" + formatNumber(commissionWallet) +
        "\nBonus Wallet Balance: ₹" + formatNumber(bonusWallet) +
        "\nTotal calculated earning: ₹" + formatNumber(cust.totalIncome || 0);
    }

    function transferCommission() {
      const fromMobile = (document.getElementById("customerMobile").value || "").trim();
      const toMobile = (document.getElementById("transferToMobile").value || "").trim();
      const amount = parseFloat(document.getElementById("transferAmount").value || "0");

      if (!fromMobile) {
        alert("पहले ऊपर अपना मोबाइल नंबर भरें और \"कैल्क्युलेट करें\" करें।");
        return;
      }
      if (!toMobile) {
        alert("जिस mobile पर भेजना है, वो नंबर भरें।");
        return;
      }
      if (fromMobile === toMobile) {
        alert("खुद के मोबाइल पर transfer की जरूरत नहीं है।");
        return;
      }
      if (amount <= 0) {
        alert("Valid transfer amount दर्ज करें।");
        return;
      }

      const customers = getCustomersArray();
      const fromIdx = customers.findIndex(c => c.mobile === fromMobile);
      if (fromIdx === -1) {
        alert("आपके mobile के लिए कोई wallet नहीं मिला। पहले calculation करें।");
        return;
      }

      const from = customers[fromIdx];
      const fromWallet = from.walletBalance || 0; // सिर्फ commission wallet से transfer
      if (fromWallet < amount) {
        alert("आपके Commission Wallet में इतना balance नहीं है। Current balance: ₹" + formatNumber(fromWallet));
        return;
      }

      let toIdx = customers.findIndex(c => c.mobile === toMobile);
      if (toIdx === -1) {
        const newCust = {
          id: Date.now() + 1,
          name: "Customer " + toMobile,
          mobile: toMobile,
          joinedMembers: 0,
          state: "manual",
          currentLevel: 0,
          nextLevel: null,
          remainingForNext: 0,
          nextLevelIncome: 0,
          totalIncome: 0,
          walletBalance: 0,
          bonusBalance: 0,
          createdAt: new Date().toISOString()
        };
        customers.push(newCust);
        toIdx = customers.length - 1;
      }

      const to = customers[toIdx];

      from.walletBalance = fromWallet - amount; // bonus नहीं घटा
      to.walletBalance = (to.walletBalance || 0) + amount;

      customers[fromIdx] = from;
      customers[toIdx] = to;

      saveCustomersArray(customers);

      alert("₹" + formatNumber(amount) + " सफलतापूर्वक " + toMobile + " पर transfer कर दिया गया है (Commission Wallet से)।");
      refreshWalletInfo();
      document.getElementById("transferAmount").value = "0";
    }

    function loadExample() {
      document.getElementById("levels").value = 11;
      document.getElementById("startMembers").value = 2;
      document.getElementById("multiplier").value = 2;
      document.getElementById("commissionPerMember").value = 16;
      document.getElementById("customerName").value = "Demo Customer";
      document.getElementById("customerMobile").value = "9811111111";
      document.getElementById("joinedMembers").value = 100;
      calculate();
    }

    window.addEventListener("load", function () {
      loadSettings();
      loadBankDetails();
      calculate();
    });
  </script>
</body>
</html>
